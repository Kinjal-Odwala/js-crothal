window.__bt__0bf692a1 = ['<div>    <div id="mop-filter">        <div style="color: #FFF; background-color: #659A66; font-size: 14px; padding: 5px;">            <table class="mop-filter">                <tr>                    <td>                        Site:                    </td>                    <td id="hcmHouseCode">                    </td>                    <td>                        Job:                    </td>                    <td id="hcmJob">                    </td>                    <td>                        Fiscal Year:                    </td>                    <td id="fscYear">                    </td>                    <td style="padding-left: 15px;" id="load-button" class="row-btn">                    </td>                </tr>            </table>        </div>    </div>    <div id="mop-column-switch">        <div style="color: #FFF;  background-color: #659A66; border-top: 1px solid #555; font-size: 14px;            padding: 5px;">            <div style="float:left">                           <table class="mop-filter">                <tr>                    <td>                        <input type="checkbox" name="Budget" id="Budget" />&nbsp;<label for="Budget">Budget</label>                    </td>                    <td>                        <input type="checkbox" name="Variance" id="Variance" />&nbsp;<label for="Variance">Variance</label>                    </td>                    <td>                        <input type="checkbox" name="RunRate" id="RunRate" />&nbsp;<label for="RunRate">Run                            Rate</label>                    </td>                    <td style="padding-left: 20px;">                        Period:                    </td>                    <td id="fscPeriodStart">                    </td>                    <td>                        -                    </td>                    <td id="fscPeriodEnd">                    </td>                       <td style="padding-left: 15px;" id="apply-button" class="row-btn">                    </td>                </tr>            </table>            </div>            <div style="position: relative; float:left; width:110px; margin-top:-1px;">                <a id="popupButton" class="popup-button"><span>Comment</span><em></em></a>                <div style="clear: both">                </div>                <div class="popup-box" id="popupBox">                    <div class="popup-box-inner-wrapper" style="width:500px">                        <div class="popup-box-form ">                            <label id="commentLabel">                                Summary Comments:</label>                            <textarea rows="5" class="textarea" id="summaryComment"></textarea>                            <div style="text-align:right; padding-right:20px; padding-top:5px;">                                <img id="saveButton"  src="images/button-ok.png" style="cursor:pointer"/>    <img id="cancelButton"  src="images/button-cancel.png"  style="cursor:pointer"/></div>                        </div>                    </div>                </div>            </div>        </div>    </div>    <div id="mop-footer">        <div style="color: #FFF; background-color: #659A66; padding: 10px; font-size: 14px;">            <table class="mop-filter" style="width: 100%;">                <tr class="row-btn">                    <td style="width: 40%">                        <table id="add-account-warpper">                            <tr>                                <td>                                    Account:                                </td>                                <td id="fscAccount">                                </td>                                <td id="addAccountButton">                                </td>                            </tr>                        </table>                    </td>                    <td style="text-align: right; width: 60%; padding-right: 20px;">                        <span id="saveButton" />&nbsp; <span id="payrollRegisterButton" />&nbsp; <span id="transactionDetailButton" />                        &nbsp; <span id="printMopButton" />&nbsp;                    </td>                </tr>            </table>        </div>    </div>    <div id="wor-filter">        <div style="color: #FFF; background-color: #659A66; font-size: 14px;">            <div style="float: left; background-color: #555; color: #fff; font-weight: bold;                width: 100px; height: 24px; padding: 5px; 0; text-align: center;">                WOR</div>            <div style="padding: 5px; float: left;">                <table class="mop-filter">                    <tr>                        <td style="font-weight: bold;">                            Site:                        </td>                        <td name="hcmHouseCode">                        </td>                        <td style="font-weight: bold;">                            Job:                        </td>                        <td name="hcmJob">                        </td>                        <td style="font-weight: bold;">                            Fiscal Year:                        </td>                        <td name="fscYear">                        </td>                        <td style="font-weight: bold;">                            Period:                        </td>                        <td id="fscPeriod">                        </td>                        <td id="backToMopButton" class="row-btn">                        </td>                    </tr>                </table>            </div>            <div style="position: relative; float: left; width: 110px; margin-top:4px;">                <a id="popupButton" class="popup-button"><span>Comment</span><em></em></a>                <div style="clear: both">                </div>                <div class="popup-box" id="popupBox">                    <div class="popup-box-inner-wrapper" style="width: 500px">                        <div class="popup-box-form ">                            <label id="commentLabel">                                Summary Comments:</label>                            <textarea rows="5" class="textarea" id="summaryComment"></textarea>                            <div style="text-align: right; padding-right: 20px; padding-top: 5px;">                                <img id="saveButton" src="images/button-ok.png" style="cursor: pointer" />                                <img id="cancelButton" src="images/button-cancel.png" style="cursor: pointer" />                            </div>                        </div>                    </div>                </div>            </div>            <div style="clear:both; " ></div>        </div>    </div>    <div id="wor-comment">        <div style="margin-top: 15px;">            <div style="font-size: 14px; padding-left: 5px;">                Comments:</div>            <textarea name="Comment" id="Comment" cols="100" rows="3" />        </div>    </div></div>','<div style="min-height: 400px" class="mop">    <div id="mop-top">        <div style="background-color: #555; color: #fff; float: left; text-align: center;            height: 60px; vertical-align: middle; font-size: 14px; font-weight: bold; width: 180px;            padding-top: 15px;">            Monthly Operating Projection        </div>        <div style="margin-left: 180px; background-color: #659A66; vertical-align:text-bottom">            <div id="filter-wrapper">            </div>            <div id="column-swith">            </div>            <div style="clear: both">            </div>        </div>    </div>    <div style="padding-top: 10px;" id="mop-wrapper">        <div class="list-header">            <div class="mop-controller" style="float:left;overflow:hidden"><div style="width:500px" id="controller-header"></div> </div>            <div class="mop-grid-main" style="overflow:hidden" id="mop-grid-header-wrapper"><div  id="grid-header" style="width:12000px"></div></div>            <div class="clear"></div>        </div>        <div>            <div class="mop-controller" style="float:left;overflow:hidden" id="mop-controller-wrapper"><div style="width:500px" id="mop-controller"></div> </div>            <div class="mop-grid-main" style="overflow:auto" id="mop-grid-wrapper"><div id="mop-grid"></div></div>            <div class="clear"></div>        </div>    </div>       <div style=" width: 100%;">        <div id="mop-footer">        </div>    </div></div>','<div>    <div id="controller-header">         <table class="bud-table-2">            <thead class="table-head">                <tr>                    <th class="boundary mop-updatefuture" style="width: 100px">                        <div class="row1-btn">                            <button class="bine-btn bine-btn-txt bine-ctrl" id="updatefuture-button" style="height: 50px;">                                Update Future<br />                                Periods w/MOP</button></div>                        <div style="padding: 5px;">                            <div style="width: 13px; height: 20px; padding-top: 3px; float: left;">                                <input type="checkbox" name="selectAllPeriods" id="SelectAllPeriods" /></div>                            <span style="line-height: 18px; height: 20px; padding-left: 5px;">Select All</span><div                                style="clear: both;">                            </div>                        </div>                    </th>                    <th class="boundary mop-updaterunrate" style="width: 90px">                        <div class="row1-btn">                            <button class="bine-btn bine-btn-txt bine-ctrl " id="updaterunrate-button" style="height: 50px;">                                Update With<br />                                Run Rate</button></div>                        <div style="padding: 5px;">                            <div style="width: 13px; height: 20px; padding-top: 3px; float: left;">                                <input type="checkbox" name="selectAll" id="SelectAllRunRate" /></div>                            <span style="float: left; line-height: 18px; height: 20px; padding-left: 5px;">Select                                All</span><div style="clear: both;">                                </div>                        </div>                    </th>                    <th class="boundary mop-accountcode-title" style="width: 245px; height: 85px;">                        Account Code                    </th>                </tr>            </thead>        </table>    </div>    <div id="controller-list">        <div>            <div id="holder"></div>        </div>    </div>    <table>        <tbody id="controller-view">            <tr>                <td class="boundary mop-updatefuture" style="width: 100px; height: 20px;">                    <div style="padding: 3px 7px;">                        <input type="checkbox" name="UpdateFuture" /></div>                </td>                <td class="boundary mop-updaterunrate" style="width: 90px; height: 20px;">                    <div style="padding: 3px 7px;">                        <input type="checkbox" name="UpdateRunRate" /></div>                </td>                <td class="boundary mop-account-column" style="white-space: nowrap; width: 245px; padding-top:0; padding-bottom:0; vertical-align:middle;                    height: 26px;">                    <a href="#" class="account-link" name="FscAccountDescription"></a>                </td>            </tr>        </tbody>    </table></div>','<div style="min-height: 400px" class="mop">    <div id="mop-top">        <div id="wor-filter">        </div>    </div>    <div id="mop-list-wrapper" style="padding-top: 10px; width: 99%;         margin: 0 auto; overflow: auto;">        <div id="wor-list">        </div>        <div id="wor-comment">        </div>    </div>    <div style="position: absolute; bottom: 0px; width: 100%;">        <div id="mop-footer">        </div>    </div></div>',''];

/*
* jquery.fixheadertable
*
* Copyright (c) 2010 Benjamin Léouzon
* http://www.tablefixedheader.com/
*
* Licensed under MIT
* http://www.opensource.org/licenses/mit-license.php
* 
* http://docs.jquery.com/Plugins/Authoring
* jQuery authoring guidelines
*
* Launch  : December 2010
* Version : 2.0
*/

(function($) { 

	$.fn.fixheadertable = function(options) {

		var defaults = {  
				
			caption		 : '',
			
			showhide	 : true,
			
			theme		 : 'ui',
			
			height		 : null,
			
			width		 : null, 
			
			minWidth	 : null,
			
			minWidthAuto : false,
			
			colratio	 : [],
			
			whiteSpace	 : 'nowrap',
			
			addTitles	 : false,
			
			zebra		 : false,
			
			zebraClass	 : 'ui-state-active',
			
			sortable	 : false, 
			
			sortedColId	 : null,
			
			sortType	 : [],
			
			dateFormat	 : 'd-m-y',
			
			pager		 : false,
			
			rowsPerPage	 : 10,
			
			resizeCol	 : false,
			
			minColWidth	 : 100,
			
			wrapper		 : true
		};  
		
		var options = $.extend(defaults, options); 
		
		function util_getComputedStyle(element, property) {
			
			if (element.currentStyle) {
				
				var y = x.currentStyle[property];
				
			} else if (window.getComputedStyle) {
				
				var y = document.defaultView.getComputedStyle(element, null).getPropertyValue(property);
			}
			
			return y;
		}
		
		function util_getScrollbarWidth () {
						
			var inner = $('<p/>').addClass('t_fixed_header_scroll_inner');
			
			var outer = $('<div/>').addClass('t_fixed_header_scroll_outer');
			
			outer.append(inner);
			
			$(document.body).append(outer);
			
			var w1 = inner[0].offsetWidth;  
			
			outer.css('overflow', 'scroll');
			
			var w2 = inner[0].offsetWidth;  
			
			if (w1 == w2) w2 = outer[0].clientWidth;  
			
			outer.remove();
			
			return (w1 - w2);			
		}
		
		function util_parseDate (format, date) {
			
			var tsp = {m : 1, d : 1, y : 1970, h : 0, i : 0, s : 0}, k, hl, dM;
			
			if(date && date !== null && date !== undefined){
				
				date = $.trim(date);
				
				date = date.split(/[\\\/:_;.\t\T\s-]/);
				
				format = format.split(/[\\\/:_;.\t\T\s-]/);
				
				var dfmt = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
				
				var afmt = ["am", "pm", "AM", "PM"];
				
				var h12to24 = function(ampm, h){
					
					if (ampm === 0){ if (h == 12) { h = 0;} }
					
					else { if (h != 12) { h += 12; } }
					
					return h;
				};
				
				for (k=0, hl=format.length; k < hl; k++){
					
					if(format[k] == 'M') {
						
						dM = $.inArray(date[k],dfmt);
						
						if(dM !== -1 && dM < 12){date[k] = dM+1;}
					}
					
					if(format[k] == 'F') {
						
						dM = $.inArray(date[k],dfmt);
						
						if(dM !== -1 && dM > 11){date[k] = dM+1-12;}
					}
					
					if(format[k] == 'a') {
						
						dM = $.inArray(date[k],afmt);
						
						if(dM !== -1 && dM < 2 && date[k] == afmt[dM]){
							
							date[k] = dM;
							
							tsp.h = h12to24(date[k], tsp.h);
						}
					}
					
					if(format[k] == 'A') {
						
						dM = $.inArray(date[k],afmt);
						
						if(dM !== -1 && dM > 1 && date[k] == afmt[dM]){
							
							date[k] = dM-2;
							
							tsp.h = h12to24(date[k], tsp.h);
						}
					}
					
					if(date[k] !== undefined) {
						
						tsp[format[k].toLowerCase()] = parseInt(date[k],10);
					}
				}
				
				tsp.m = parseInt(tsp.m,10)-1;
				
				var ty = tsp.y;
				
				if (ty >= 70 && ty <= 99) {tsp.y = 1900 + tsp.y;}
				
				else if (ty >=0 && ty <=69) {tsp.y= 2000 + tsp.y;}
			}
			
			return new Date(tsp.y, tsp.m, tsp.d, tsp.h, tsp.i, tsp.s,0);
		}
		
		return this.each(function() {
			
			var _table				= $(this);
			
			var main_wrapper		= null;
			
			var nbcol 				= $('thead th', this).length;
			
			var _initialWidth		= $(this).width();
			
			var _wrapper 			= null;
			
			var _headerscontainer	= null;
			
			var _fillScrollbar 		= null;
			
			var _body 				= null;
			
			var _headers			= null;
			
			var _scrollWidth		= util_getScrollbarWidth();
			
			var _colgroup			= buildColgroup(nbcol);
			
			var _colgroup_body		= null;
			
			var _nbRowsPerPage		= 10;
			
			var _new_nbRowsPerPage  = null;
			
			var _nbpages			= null;
			
			var _nbpagesDiv			= null;
			
			var _currentpage 		= null;
			
			var _pager				= null;
			
			var _objectTable		= null;
			
			var _stripNum 			= /[\$,%]/g;
			
			var _resizeInfo 		= null;
			
			var _resizeGhost		= null;
			
			function buildTop (table) {
				
				_fillScrollbar = $('<div class="headtable ui-state-default" style="margin-right : 0px"></div>');
				
				_headerscontainer = _fillScrollbar;
				
				_headerscontainer.insertBefore(table);
			}
			
			function buildColgroup (nbcol) {
					
				var colgroup = $('<colgroup />');				
				
				if (options.colratio.length == 0) {
				
					var temp = null;
					
					for (var i = 0; i < nbcol; i++) {
						
						temp = $('<col style="width : ' + (100/nbcol) + '%" />');
						
						colgroup.append(temp);

						temp = null;
					}
				
				} else if (options.colratio.length == nbcol) {
					
					var cw = 0;
					
					for (var i = 0; i < nbcol; i++) {
						
						temp = $('<col style="width : ' + options.colratio[i] + 'px" />');
						
						colgroup.append(temp);

						temp = null;
						
						cw += parseInt(options.colratio[i]);
					}
					
					$(_table).css('width', cw + 'px');
				}
				
				return colgroup;
			}
			
			function sortColumn (table, number, sens, th) {
				
				if ((options.sortType.length != 0) && (options.sortType.length == nbcol)) {
					
					var type = options.sortType[number];
					
					if (type == 'float') {						
						
						getSortKey = function(cell) {
							
							var key = parseFloat( String(cell).replace(_stripNum, ''));
							
							return isNaN(key) ? 0.00 : key;
						}
						
					} else if (type == 'integer') {
						
						getSortKey = function(cell) {
							
							return cell ? parseFloat(String(cell).replace(_stripNum, '')) : 0;							
						}
						
					} else if (type == 'date') {
						
						getSortKey = function(cell) {
							
							return util_parseDate(options.dateFormat, cell).getTime();
						}
						
					} else {
						
						getSortKey = function(cell) {
							
							if(!cell) { cell =""; }
							
							return $.trim(String(cell).toLowerCase());
						}
					}
					
				} else {
					
					getSortKey = function(cell) {
						
						if(!cell) { cell =""; }
						
						return $.trim(String(cell).toLowerCase());
					}
				}
				
				_objectTable.sort(function(a, b){
										
					var x = getSortKey(a[number]);
					
				    var y = getSortKey(b[number]);
				    
				    return ((x < y) ? -1 : ((x > y) ? 1 : 0));
				})
					
				if(sens == 'DESC'){
					
					_objectTable.reverse();
				}
				
				(options.pager) ? moveToPage(table) : objectToTable(_objectTable, table);
			}
			
			function objectToTable(objectArray, table) {
				
				var body = $('tbody', table);
								
				body.children().remove();
				
				if(options.zebra){
					
					for (var i = 0; i < objectArray.length; i++){
						
						(i%2) ? (tr = $('<tr class="' + options.zebraClass + '"></tr>')) : (tr = $('<tr></tr>'));									
						
						for (var j in objectArray[i]){
							
							tr.append($('<td class="ui-widget-content"></td>').html(objectArray[i][j]));
						}	
						
						body.append(tr);
					}
					
				} else {
				
					for (var i = 0; i < objectArray.length; i++){
							
						tr = $('<tr></tr>');				
						
						for (var j in objectArray[i]){
							
							tr.append($('<td class="ui-widget-content"></td>').html(objectArray[i][j]));
						}	
						
						body.append(tr);
					}
				}
			}
			
			function tableToObject(table) {

				var objectArray = [];
				
				$('tr', table).each(function(i){
					
					var data = {};
					
					$('td', this).each(function(j){
						
						data[j] = $(this).html();
					})
					
					objectArray.push(data);
				});	

				return objectArray;
			}
			
			function buildHeaders(table) {
				
				_headers = $('<table class="head"/>').append(_colgroup).append($('thead', table));
				
				_headerscontainer.append(_headers);	
				
				_headers.wrap('<div></div>');
				
				var tab_headers = $('th', _headers);
				
				tab_headers.addClass('ui-widget-content ui-state-default');
								
				if(options.sortable){
					
					var th_div_sort = null;
					
					tab_headers.each(function(i){
						
						$(this).contents().wrapAll('<div class="ui-sort"></div>');
						
						th_div_sort = $('div.ui-sort', this);
						
						th_div_sort.click(function(){
							
							tab_headers.removeClass('ui-state-hover');
							
							$(this).parent().removeClass('ui-state-active').addClass('ui-state-hover');
							
							$('span.ui-icon', tab_headers).remove();
							
							if($(this).hasClass('sortedUp')){
								
								sortColumn(table, i, "DESC", this);
								
								$(this).removeClass('sortedUp').addClass('sortedDown');
								
								$(this).append('<span style="display : inline-block; vertical-align : middle" class="ui-icon ui-icon-triangle-1-s"></span>');
								
							} else {
								
								sortColumn(table, i, "ASC", this);
								
								$(this).removeClass('sortedDown').addClass('sortedUp');
								
								$(this).append('<span style="display : inline-block; vertical-align : middle" class="ui-icon ui-icon-triangle-1-n"></span>');
							}
							
							_headerscontainer[0].scrollLeft = _body[0].scrollLeft;
						})
					});
				    
					$('div.ui-sort', tab_headers).addClass('hover');
				}
				
				if(options.resizeCol && (options.colratio.length == nbcol)){
					
					tab_headers.each(function(i){
						
						var resizer = $('<span class="ui-resize"></span>');
						
						$(this).prepend(resizer);
						
						resizer.mousedown(function(e){
							
							dragStart(i, e);
							
							return false;
						})						
					});
					
					_main_wrapper.mousemove(function(e){
						
						if (_resizeInfo){
							
							dragMove(e);
							
							return false;
						}
					}).mouseup(function(){
						
						if (_resizeInfo){
							
							dragEnd();
							
							return false;
						}
						
						return true;
					});
					
					function getOffset(col){
						
						var ret = 0, cell = $('col', _colgroup), handler = $('th > span.ui-resize', _headers)[col], bso = _body[0].scrollLeft;
						
						for(var i = 0; i < col; i++){
							
							ret += parseInt(cell[i].style.width);
						}
						
						return handler.offsetLeft + 5 + ret - bso;
					}
					
					function dragStart(i, x){
						
						_resizeInfo = { id : i, startX : x.clientX , initTableWidth : getColratioWidth(), offset : getOffset(i) };
						
						_resizeGhost.css({ display : 'block', height : _headerscontainer.height() + _body.height() + 2 + 'px', left : _resizeInfo.offset + 'px', cursor : 'col-resize' });
					}
					
					function dragMove(x){
						
						var diff = x.clientX - _resizeInfo.startX;
						
						_resizeInfo.newWidth = parseInt($('col', _colgroup)[_resizeInfo.id].style.width) + diff;
						
						_resizeInfo.newTableWidth = _resizeInfo.initTableWidth + diff;
						
						if(_resizeInfo.newWidth > parseInt(options.minColWidth)){
						
							_resizeGhost.css({ left :  _resizeInfo.offset + diff + 'px' });
							
						} else {
							
							_resizeInfo.newWidth = parseInt(options.minColWidth);
						}
					}
					
					function dragEnd(){
						
						$(_colgroup.children()[_resizeInfo.id]).css({ width : _resizeInfo.newWidth + 'px' });
						
						$(_colgroup_body.children()[_resizeInfo.id]).css({ width : _resizeInfo.newWidth + 'px' });
						
						var wrapper_width = _resizeInfo.newTableWidth;
						
						_headers.css({ 'width' : wrapper_width + 'px' });
						
						$(_table).css({ 'width'	: wrapper_width + 'px' });
							
						_resizeInfo = null;
						
						_resizeGhost.css({ display : 'none' });
						
						_headerscontainer[0].scrollLeft = _body[0].scrollLeft;
					}
				}
			}

			function isIE6_7() {
				
				if (/MSIE (\d+\.\d+);/.test(navigator.userAgent)) {
					
	        		var ieversion = new Number(RegExp.$1);
	        		 
	 				if (ieversion == 7 || ieversion == 6) {
	 					
	        				return true;
	        				
	        		} else {
	        				return false;
	        		}
	        	}
			}
			
			function isIE8() {
				
				if (/MSIE (\d+\.\d+);/.test(navigator.userAgent)) {
					
	        		var ieversion = new Number(RegExp.$1);
	        		 
	 				if (ieversion == 8) {
	 					
	        				return true;
	        				
	        		} else {
	        				return false;
	        		}
	        	}
			}
			
			function buildBody (table) {
				
				_body = $('<div class="body ui-widget-content"></div>').insertBefore(table).append(table);
				
				if(options.height != null &&  !isNaN(parseInt(options.height))) {
				
					_body.css('height', options.height + 'px');
				}
				
				_colgroup_body = _colgroup.clone();
				
				$(table).prepend(_colgroup_body);
				
				$('td', table).addClass('ui-widget-content');
				
				$(table).wrap('<div></div>');
				
				if (options.addTitles == true) {
				
					$('td', table).each(function() {
						
							$(this).attr('title', $(this).text());
					});			
				}
				
				if (options.zebra) {
					
					$('tr:odd', table).addClass(options.zebraClass);
				}
			}
			
			function adaptScroll (table) {
				
				var scrollwidth = _scrollWidth;
	        	
	        	if(isIE6_7()){
	        		
	        		scrollwidth = 0; 
	        	}
	        	
	        	var width = 0;
	        							
				if (parseInt($(table).height()) > parseInt(options.height)) { 
									
					width = scrollwidth;
					
					overflow = 'scroll';
					
				} else { 
									
					width = 0;
						
					overflow = 'auto';
				}
				
				if($.browser.msie && options.height) {
				
					width = scrollwidth;
					
					overflow = 'scroll';
				}
				
				_fillScrollbar.css('margin-right', width);
				
				return overflow;				
			}
			
			function restrictRows(table, nbrows) {
							
				var length = _objectTable.length;
				
				var limit = 0;
				
				if(length < nbrows) {
					
					limit = length;
				
				} else {
					
					limit = nbrows;
				}
				
				var _objectTableSliced = _objectTable.slice(0, limit);
				
				objectToTable(_objectTableSliced, table);	
				
				_nbpages = Math.ceil(length / nbrows);
				
				_currentpage = 1;
				
				_nbpagesDiv.html('Showing page ' + _currentpage + ' of ' + _nbpages);
				
				_body.css('overflow-y', adaptScroll(table));
				
				$('tr:last td', table).css('border-bottom-width', '1px');
			}
			
			function moveToNextPage(table) {
				
				_currentpage++;
				
				if(_currentpage >= (_nbpages)) {
					
					_currentpage = (_nbpages);
				}
					
				moveToPage(table);
			}
			
			function moveToPreviousPage(table) {
				
				_currentpage--;
				
				if(_currentpage <= 1) {
					
					_currentpage = 1;
				}
				
				moveToPage(table);
			}
			
			function moveToPage(table) {
				
				var length = _objectTable.length;
				
				var start, limit = 0;
				
				start = (_currentpage - 1) * _new_nbRowsPerPage;
				
				if(length < (_currentpage * _new_nbRowsPerPage)) {
					
					limit = length;
				
				} else {
					
					limit = (_currentpage * _new_nbRowsPerPage);
				}
				
				var _objectTableSliced = _objectTable.slice(start, limit);
				
				objectToTable(_objectTableSliced, table);
				
				_nbpagesDiv.html('Showing page ' + _currentpage + ' of ' + _nbpages);
				
				_body.css('overflow-y', adaptScroll(table));	
				
				$('tr:last td', table).css('border-bottom-width', '1px');
			}
			
			function buildNavButton(className, callbackClick, buttonClass) {
				
				var button = $('<div class="button ui-state-default ' + buttonClass + '"><span class="ui-icon ' + className + '">&nbsp;</span></div>');
				
				_pager.append(button);
				
				button.mouseover(function(){
						
					$(this).addClass('ui-state-hover');
						
				}).mousedown(function(){
						
					$(this).addClass('ui-state-active');
						
				}).mouseup(function(){
						
					$(this).removeClass('ui-state-active');
						
				}).mouseout(function(){
					
					$(this).removeClass('ui-state-active');
					
					$(this).removeClass('ui-state-hover');
					
				}).click(callbackClick);	
			}
			
			function buildPager(table) {
				
				_pager = $('<div class="pager ui-widget-header ui-corner-bottom ui-widget-content"></div>');
				
				_main_wrapper.append(_pager);
				
				buildNavButton('ui-icon-arrowthickstop-1-e', function(){
					
					_currentpage = _nbpages;
					
					moveToPage(table);
				}, 'ui-corner-right');
				
				buildNavButton('ui-icon ui-icon-arrowthick-1-e', function(){
					
					moveToNextPage(table);
				}, 'noborder');
				
				buildNavButton('ui-icon ui-icon-arrowthick-1-w', function(){
					
					moveToPreviousPage(table);
				}, 'noborder');
				
				buildNavButton('ui-icon-arrowthickstop-1-w', function(){
					
					_currentpage = 1;
					
					moveToPage(table);
				}, 'ui-corner-left noborder');
				
				_button_set = 
				
				$('<div id="' + table.id + '_radio" style="float : left">' + 
				
					'<input type="radio" id="' + table.id + '_show_10_rows" name="' + table.id + '_radio"/><label for="'  + table.id + '_show_10_rows">10</label>' + 
					'<input type="radio" id="' + table.id + '_show_25_rows" name="' + table.id + '_radio"/><label for="'  + table.id + '_show_25_rows">25</label>' + 
					'<input type="radio" id="' + table.id + '_show_50_rows" name="' + table.id + '_radio" /><label for="' + table.id + '_show_50_rows">50</label>' + 
					'<input type="radio" id="' + table.id + '_show_100_rows" name="' + table.id + '_radio"/><label for="' + table.id + '_show_100_rows">100</label>' + 
				
				'</div>');
									
				_pager.append(_button_set);
				
				$('#' + table.id + '_show_10_rows', _pager).click(function(){
						
						_new_nbRowsPerPage = _nbRowsPerPage;
						
						restrictRows(table, _new_nbRowsPerPage);
				});
				
				$('#' + table.id + '_show_25_rows', _pager).click(function(){
						
						_new_nbRowsPerPage = _nbRowsPerPage * 2.5;
						
						restrictRows(table, _new_nbRowsPerPage);
				});
				
				$('#' + table.id + '_show_50_rows', _pager).click(function(){
					
						_new_nbRowsPerPage = _nbRowsPerPage * 5;
					
						restrictRows(table, _new_nbRowsPerPage);
				});
				
				$('#' + table.id + '_show_100_rows', _pager).click(function(){
					
						_new_nbRowsPerPage = _nbRowsPerPage * 10;
					
						restrictRows(table, _new_nbRowsPerPage);
				});
				
				_nbpagesDiv = $('<div class="page_infos"></div>');
				
				_pager.append(_nbpagesDiv);
				
				_new_nbRowsPerPage = _nbRowsPerPage;
				
				$('#' + table.id + '_show_' + options.rowsPerPage + '_rows', _pager).click();
				
				_button_set.buttonset();
			}
			
			function getColratioWidth(){
				
				var tw = 0;
				
				for(var i = 0; i < options.colratio.length; i++){
					
					tw += parseInt(options.colratio[i]);
				}
				
				return tw;
			}

			/***********************/
			/********* MAIN ********/
			/***********************/
			
			_wrapper = $('<div/>').addClass('t_fixed_header ui-state-default default ' + options.theme).insertBefore(this).append(this);
			
			_wrapper.css('border', 'none').css('font-weight', 'normal');
			
			_main_wrapper = $('<div class="t_fixed_header_main_wrapper ui-widget ui-widget-header ' + options.theme + '"></div>');
			
			if (options.whiteSpace == 'normal') {
			
				_wrapper.addClass('t_fixed_header_wrap');
			}		
			
			buildTop(this);
			
			buildHeaders(this);	
			
			buildBody(this);
			
			if(options.wrapper){
			
				var tampon = _wrapper.wrap('<div class="ui-widget ui-widget-content ui-corner-all" style="padding : 5px; font-size : 1em;"></div>').parent();
				
			} else {
				
				var tampon = _wrapper.wrap('<div></div>').parent();
			}
			
			if (options.width != null && !isNaN(parseInt(options.width)) && options.width > 0) {
				
				tampon.css('width', options.width + 'px');	
			}
			
			var res = _wrapper.detach();
			
			var main_wrapper_child = $('<div class="t_fixed_header_main_wrapper_child"></div>');
			
			_main_wrapper.append(main_wrapper_child);
			
			main_wrapper_child.append(res);
			
			tampon.append(_main_wrapper);	
			
			if(isIE6_7()){
			
				_body.css('margin-bottom', 17 + 'px');
			}
			
			if (options.caption != '') {
				
				var caption = $('<div class="t_fixed_header_caption ui-widget-header ui-corner-top">' + options.caption + '</div>');
				
				_main_wrapper.prepend(caption).addClass('ui-corner-all');
				
				if (options.showhide) {
				
					var showhide = $('<div style="cursor : pointer; display : inline-block; vertical-align : middle; background : none; border : none;" class="ui-state-active"><span class="ui-icon ui-icon-triangle-1-n">&nbsp;</span></div>');
					
					caption.append(showhide);
					
					showhide.click(function(){
						
						main_wrapper_child.toggle();
						
						caption.toggleClass('toggle')
						
						if(_pager) _pager.toggle();
						
						$('span', showhide).toggleClass('ui-icon-triangle-1-s');
					});
				
				}
			} 	
						
			if (options.sortable || options.pager) {
				
				_objectTable = tableToObject(this);
			}
			
			if (options.pager) {
				
				buildPager(this);
			}
			
			if(options.sortable && !isNaN(parseInt(options.sortedColId))) {
				
				var cur_th = $('th', _headers)[options.sortedColId];
				
				$(cur_th).addClass('ui-state-hover')
				
				$('div.ui-sort', cur_th).click();
			}
			
			if(options.resizeCol && (options.colratio.length == nbcol)){
			
				_resizeGhost = $('<div class="ui-resize-ghost ui-widget-header" style="height : ' + _main_wrapper.parent().height() + 'px"></div>');
				
				_wrapper.append(_resizeGhost);
			}
			
			_body.css('overflow-y', adaptScroll(this));
			
			if (options.minWidth != null && !isNaN(parseInt(options.minWidth)) && options.minWidth > 0) {
				
				var minWidth = options.minWidth + 'px';
				
			} else if (options.minWidthAuto) {
				
				if (options.colratio.length == nbcol) {
					
					var minWidth =  $(this).width() + 'px';
					
				} else {
					
					var minWidth = (_initialWidth + 150) + 'px';
				}
			}
						
			_headerscontainer.children().first().css('min-width', minWidth);
			
			_body.children().first().css('min-width', minWidth);
			
			_body.scroll(function(){
				
				_headerscontainer[0].scrollLeft = _body[0].scrollLeft;
			});
			
			if (options.colratio.length == nbcol) {
								
				_wrapper.removeClass('default');
				
				$(_headers).css('width', getColratioWidth() + 'px');
			}
		});
	};

})(jQuery);
if ((typeof Range !== "undefined") && !Range.prototype.createContextualFragment) {
    Range.prototype.createContextualFragment = function (html) {
        var frag = document.createDocumentFragment(),
        div = document.createElement("div");
        frag.appendChild(div);
        div.outerHTML = html;
        return frag;
    };
}

$.fn.focusNextInputField = function () {
    return this.each(function () {
        var fields = $(this).parents('form:eq(0),body').find('input,textarea,select');
        var index = fields.index(this);
        if (index > -1 && (index + 1) < fields.length) {
            fields.eq(index + 1).focus();
        }
        return false;
    });
};

$.fn.focusPrevInputField = function () {
    return this.each(function () {
        var fields = $(this).parents('form:eq(0),body').find('input,textarea,select');
        var index = fields.index(this);
        if (index > 1) {
            fields.eq(index - 1).focus();
        }
        return false;
    });
};

bine.namespace('fin.bud', 'fin.bud.page', 'fin.bud.data');

fin.bud.budRequest = function (requestXml, callback) {
    var data = String.format('moduleId=bud&requestId=1&requestXml={0}&&targetId=iiCache', encodeURIComponent(requestXml));

    jQuery.post('/net/crothall/chimes/fin/bud/act/Provider.aspx', data, function (data, status) {
        callback(data);
    });
}

fin.bud.hcmRequest = function (requestXml, callback) {
    var data = String.format('moduleId=hcm&requestId=1&requestXml={0}&&targetId=iiCache', encodeURIComponent(requestXml));

    jQuery.post('/net/crothall/chimes/fin/hcm/act/Provider.aspx', data, function (data, status) {
        callback(data);
    });
}

fin.bud.fscRequest = function (requestXml, callback) {
    var data = String.format('moduleId=fsc&requestId=1&requestXml={0}&&targetId=iiCache', encodeURIComponent(requestXml));

    jQuery.post('/net/crothall/chimes/fin/fsc/act/Provider.aspx', data, function (data, status) {
        callback(data);
    });
}

fin.bud.rptRequest = function (callback) {
    var data = String.format('moduleId=rpt&requestId=1&requestXml={0}&&targetId=iiCache', encodeURIComponent('<criteria>storeId:rptReports,userId:[user],</criteria>'));

    jQuery.post('/net/crothall/chimes/fin/rpt/act/Provider.aspx', data, function (d, status) {
        callback(d);
    });

}

fin.bud.budSubmit = function (submitXml, callback) {
    var data = String.format('moduleId=bud&requestId=1&requestXml={0}&&targetId=iiTransaction', encodeURIComponent(submitXml));

    jQuery.post('/net/crothall/chimes/fin/bud/act/Provider.aspx', data, function (data, status) {
        callback(data);
    });
}

if (!window.top.fin.appUI) {
    //window.top.fin = { appUI: { houseCodeId: 227, glbFscYear: 2, glbFscPeriod: 18} };
    window.top.fin.appUI = { houseCodeId: 415, glbFscYear: 3, glbFscPeriod: 45, glbWeek: 2 };
}

fin.bud.Context = {
    isTest: document.location.host == 'localhost',

    getHcmHouseCode: function () {
        var hcmHouseCode = window.top.fin.appUI.houseCodeId;
        if (!hcmHouseCode)
            return 0;
        return hcmHouseCode;
    },

    getWeekNumber: function () {
        var week = window.top.fin.appUI.glbWeek;
        if (!week)
            return 1;
        return week;    
    },

    getFscYear: function () {
        var fscYear = window.top.fin.appUI.glbFscYear;
        if (!fscYear)
            return 0;
        return fscYear;
    },

    getFscPeriod: function () {

        var fscPeriod = window.top.fin.appUI.glbFscPeriod;
        if (!fscPeriod)
            return 0;
        return fscPeriod;
    },

    setHcmHouseCode: function (appUnit, id, name, brief, hirNode) {

        if (window.top.fin.appUI) {
            window.top.fin.appUI.unitId = appUnit;
            window.top.fin.appUI.houseCodeId = parseFloat(id);
            window.top.fin.appUI.houseCodeTitle = name;
            window.top.fin.appUI.houseCodeBrief = brief;
            window.top.fin.appUI.hirNode = hirNode;
        }
    },

    setFscYear: function (id, name) {
        if (window.top.fin.appUI) {
            window.top.fin.appUI.glbFscYear = parseFloat(id);
            window.top.fin.appUI.glbfiscalYear = name;
        }
    },

    setFscPeriod: function (id, name) {
        if (window.top.fin.appUI) {
            window.top.fin.appUI.glbFscPeriod = parseFloat(id);
            window.top.fin.appUI.glbPeriod = name;
        }
    }
};

$bud = {
    calcDaysInDateRange: function (date1, date2) {
        date1.setHours(0, 0, 0, 0);
        date2.setHours(0, 0, 0, 0);
        return Math.round((date2.getTime() - date1.getTime()) / (1000 * 60 * 60 * 24)) + 1;
    }

};

Date.prototype.addDays = function (days) {
    var dat = new Date(this.valueOf())
    dat.setDate(dat.getDate() + days);
    return dat;
}

var htmlEncode = function (str) {
    if (!str)
        return '';

    return String(str)
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
}


bine.applyIf(Array.prototype, {
    /**
    * Add an element at the specified index
    * @param {Object} o The object to add
    * @param {int} index The index position the element has to be inserted
    * @return {Boolean} True if you can insert
    */
    insertAt: function (o, index) {
        if (index > -1 && index <= this.length) {
            this.splice(index, 0, o);
            return true;
        }
        return false;
    },
    /**
    * Add an element after another element
    * @param {Object} The object before which you want to insert
    * @param {Object} The object to insert
    * @return {Boolean} True if inserted, false otherwise
    */
    insertBefore: function (o, toInsert) {
        var inserted = false;
        var index = this.indexOf(o);
        if (index == -1)
            return false;
        else {
            if (index == 0) {
                this.unshift(toInsert)
                return true;
            }
            else
                return this.insertAt(toInsert, index - 1);
        }
    },
    /**
    * Add an element before another element
    * @param {Object} The object after which you want to insert
    * @param {Object} The object to insert
    * @return {Boolean} True if inserted, false otherwise
    */
    insertAfter: function (o, toInsert) {
        var inserted = false;
        var index = this.indexOf(o);
        if (index == -1)
            return false;
        else {
            if (index == this.length - 1) {
                this.push(toInsert);
                return true;
            }
            else
                return this.insertAt(toInsert, index + 1);
        }
    }
});  

!function (bud) {
    //

var FscYears = [];
var FscAccounts = [];
var FscAccountCategories = [];
var HcmHouseCodes = [];
var RptReportUrls = [];

var FscPeriodLookup = {};
var FscPeriodLookup2 = {};
var HcmHouseCodeLookup = {};
var FscAccountLookup = {};
var FscAccountCategoryLookup = {};

var HcmHouseCodeStore = new Ext.data.JsonStore({
    root: 'data',
    idProperty: 'Id',
    fields: [{ name: 'Id' }, { name: 'Description'}]
});

var HcmJobStore = new Ext.data.JsonStore({
    root: 'data',
    idProperty: 'Id',
    fields: [{ name: 'Id' }, { name: 'Description'}]
});

var FscYearStore = new Ext.data.JsonStore({
    root: 'data',
    idProperty: 'Id',
    fields: [{ name: 'Id' }, { name: 'Description'}]
});

var FscPeriodStore = new Ext.data.JsonStore({
    root: 'data',
    idProperty: 'Id',
    fields: [{ name: 'Id' }, { name: 'Description'}]
});


var FscAccountStore = new Ext.data.JsonStore({
    root: 'data',
    idProperty: 'Id',
    fields: [{ name: 'Id' }, { name: 'Description'}]
});

var loadFscYears = function (callback) {
    var criteriaXml = '<criteria>storeId:fiscalYears,userId:[user],</criteria>';

    fin.bud.budRequest(criteriaXml, function (data) {
        FscYears = [];
        $('item', $(data)).each(function (index, item) {
            var $item = $(item);
            FscYears.push({ Id: parseInt($item.attr('id')), Description: $item.attr('title') });
        });

        FscYearStore.loadData({ data: FscYears });
        if (callback)
            callback();
    });
};

var loadFscPeriods = function (fscYearId, callback) {

    var fscYear = bine.query(FscYears).where(function (i) { return i.Id == fscYearId; }).first();

    if (fscYear && fscYear.Periods) {
        FscPeriodStore.loadData({ data: fscYear.Periods });

        callback(fscYear.Periods);
        return;
    }

    var criteriaXml = String.format('<criteria>fiscalYearId:{0},storeId:fiscalPeriods,userId:[user],</criteria>', fscYear.Id);

    fin.bud.fscRequest(criteriaXml, function (data) {
        var fscPeriods = [];
        $('item', $(data)).each(function (index, item) {
            var $item = $(item);
            var fscPeriod = { Id: parseInt($item.attr('id')), Number: parseFloat($item.attr('title')),
                Description: 'Period ' + $item.attr('title'),
                StartDt: Date.parseDate($item.attr('startDate'), 'n/j/Y'), EndDt: Date.parseDate($item.attr('endDate'), 'n/j/Y')
            };
            fscPeriod.Days = $bud.calcDaysInDateRange(fscPeriod.StartDt, fscPeriod.EndDt);

            var weeks = [];
            var startDt = fscPeriod.StartDt;
            var endDt = fscPeriod.StartDt;

            while (endDt < fscPeriod.EndDt) {

                if (endDt.getDay() == 6) {
                    weeks.push({ StartDt: startDt, EndDt: endDt, Days: $bud.calcDaysInDateRange(startDt, endDt) });
                    startDt = endDt.addDays(1);
                }
                endDt = endDt.addDays(1);
            }
            if (startDt != endDt) {
                weeks.push({ StartDt: startDt, EndDt: endDt, Days: $bud.calcDaysInDateRange(startDt, endDt) });
            }
            fscPeriod.Weeks = weeks;
            fscPeriods.push(fscPeriod);
        });

        $.each(fscPeriods, function (index, fscPeriod) {
            FscPeriodLookup2[fscPeriod.Id] = fscPeriod;
            FscPeriodLookup[fscYearId + '_' + fscPeriod.Number] = fscPeriod;
        });

        fscYear.Periods = fscPeriods;
        FscPeriodStore.loadData({ data: fscPeriods });
        callback(fscPeriods);

    });
};

var loadFscAccounts = function (callback) {
    var criteriaXml = '<criteria>storeId:budFscAccounts,userId:[user],</criteria>';

    fin.bud.budRequest(criteriaXml, function (data) {
        FscAccounts = [];
        FscAccountCategories = [];
        $('item', $(data)).each(function (index, item) {
            var $item = $(item);
            var categoryId = parseInt($item.attr('accountCategoryId'));
            var category = bine.query(FscAccountCategories).where(function (i) { return i.Id == categoryId; }).first();

            var FscAccount = {
                Id: parseInt($item.attr('id')),
                Code: parseFloat($item.attr('code')),
                CategoryId: categoryId,
                Name: $item.attr('name'),
                Description: String.format('{0} {1}', $item.attr('code'), $item.attr('name')),
                IsNegative: $item.attr('isNegative') == 'true'
            };


            if (!category) {
                var FscAccountCategory = {
                    Id: categoryId,
                    Description: $item.attr('accountCategory'),
                    OrderIndex: parseFloat($item.attr('categoryDisplayOrder')),
                    IsNegative: $item.attr('isNegative') == 'true'
                };
                FscAccountCategories.push(FscAccountCategory);
                FscAccountCategoryLookup[FscAccountCategory.Id] = FscAccountCategory;
            }
            FscAccounts.push(FscAccount);
            FscAccountLookup[FscAccount.Id] = FscAccount;
        });

        FscAccountStore.loadData({ data: FscAccounts });

        if (callback)
            callback();
    });
};

var loadHcmHouseCodes = function (callback) {
    var criteriaXml = '<criteria>appUnitBrief:,storeId:hcmHouseCodes,userId:[user],</criteria>';

    fin.bud.hcmRequest(criteriaXml, function (data) {
        HcmHouseCodes = [];
        $('item', $(data)).each(function (index, item) {
            var $item = $(item);
            var HcmHouseCode = { Id: parseInt($item.attr('id')), Description: $item.attr('name'), Code: $item.attr('brief'), HirNode: $item.attr('hirNode'), AppUnit: $item.attr('appUnit') };
            HcmHouseCodes.push(HcmHouseCode);
            HcmHouseCodeLookup[HcmHouseCode.Id] = HcmHouseCode;
        });

        HcmHouseCodeStore.loadData({ data: HcmHouseCodes });

        if (callback)
            callback();
    });
};

var loadHcmHouseJobs = function (hcmHouseCodeId, callback) {

    var hcmHouseCode = HcmHouseCodeLookup[hcmHouseCodeId];         // bine.query(HcmHouseCodes).where(function (h) { return h.Id == hcmHouseCodeId; }).first();
    if (hcmHouseCode && hcmHouseCode.Jobs) {
        HcmJobStore.loadData({ data: hcmHouseCode.Jobs });
        callback(hcmHouseCode.Jobs);
        return;
    }

    var criteriaXml = String.format('<criteria>houseCodeId:{0},jobType:0,storeId:houseCodeJobs,userId:[user],</criteria>', hcmHouseCode.Id);

    fin.bud.hcmRequest(criteriaXml, function (data) {
        var hcmJobs = [];
        $('item', $(data)).each(function (index, item) {
            var $item = $(item);
            hcmJobs.push({ Id: parseInt($item.attr('jobId')), Description: $item.attr('jobTitle') });
        });
        HcmJobStore.loadData({ data: hcmJobs });
        hcmHouseCode.Jobs = hcmJobs;
        callback(hcmJobs);
    });
};

var loadReportUrls = function (callback) {

    fin.bud.rptRequest(function (data) {
        var rptReportUrls = [];
        $('item', $(data)).each(function (index, item) {
            var $item = $(item);
            rptReportUrls.push({ Title: $item.attr('title'), Url: $item.attr('reportURL') });
        });
        RptReportUrls = rptReportUrls;

    });
};

var GetFscPeriod = function (fscPeriod) {
    return FscPeriodLookup2[fscPeriod];
    var FscPeriod = {};
    $.each(FscYears, function (index, FscYearItem) {

        if (FscYearItem.Periods) {
            $.each(FscYearItem.Periods, function (i, period) {
                if (period.Id == fscPeriod) {
                    FscPeriod = period;
                    return true;
                }
            });
        }

    });
    return FscPeriod;
};

var GetFscPeriod2 = function (fscYear, number) {
    //    var FscYear = bine.query(FscYears).where(function (y) { return y.Id == fscYear; }).first();
    //    return bine.query(FscYear.Periods).where(function (p) { return p.Number == number; }).first();
    return FscPeriodLookup[fscYear + '_' + number];
};



var GetCurrentFscPeriod = function () {
    var today = new Date();
    today.setHours(0, 0, 0, 0);
    var FscPeriod = FscPeriodLookup2[fin.bud.Context.getFscPeriod()];
    if (!FscPeriod)
        return { Number: -1 };

    return FscPeriod;
//    var FscPeriod = { Number: -1 };
//    $.each(FscYears, function (index, FscYearItem) {

//        if (FscYearItem.Periods) {
//            $.each(FscYearItem.Periods, function (i, period) {
//                if (period.StartDt <= today && period.EndDt >= today) {
//                    FscPeriod = period;
//                    return true;
//                }
//            });
//        }

//    });
//    return FscPeriod;
};

var GetCurrentFscPeriodByToday = function () {
    var today = new Date();
    today.setHours(0, 0, 0, 0);


    var FscPeriod = { Number: -1 };
    $.each(FscYears, function (index, FscYearItem) {

        if (FscYearItem.Periods) {
            $.each(FscYearItem.Periods, function (i, period) {
                if (period.StartDt <= today && period.EndDt >= today) {
                    FscPeriod = period;
                    return true;
                }
            });
        }

    });
    return FscPeriod;
};


    //

var BudDetails = [];
var ProjectedComments = [];
var ProjectedDetails = [];
var ProjectedWorDetails = [];
var MopPeriodItems = [];


var MopDetails = [];

var isBudgetStarted = function (hcmHouseCode, hcmJob, fscYear, callback) {
    var criteriaXml = String.format('<criteria>hcmHouseCode:{0},fscYear:{2},hcmJob:{1},storeId:budAnnualBudgets,userId:[user],</criteria>', hcmHouseCode, hcmJob, fscYear);

    fin.bud.budRequest(criteriaXml, function (data) {
        callback($('item', $(data)).length > 0);
    });
};

var loadPeriodData = function (storeId, hcmHouseCode, hcmJob, fscYear, array, isAmountField, callback) {

    var criteriaXml = String.format('<criteria>hcmHouseCode:{0},fscYear:{2},hcmJob:{1},storeId:{3},userId:[user],</criteria>', hcmHouseCode, hcmJob, fscYear, storeId);

    fin.bud.budRequest(criteriaXml, function (data) {
        array.length = 0;

        $('item', $(data)).each(function (index, item) {
            var $item = $(item);
            var dataItem = { FscAccount: $item.attr('fscAccount') };
            for (var i = 1; i <= 16; i++) {
                var periodField = 'Period' + i;
                if (isAmountField === true) {
                    dataItem[periodField] = parseFloat($item.attr('period' + i));
                    if (isNaN(dataItem[periodField]))
                        dataItem[periodField] = 0;
                }
                else
                    dataItem[periodField] = $item.attr('period' + i);
            }
            array.push(dataItem);
        });

        callback(array);

    });
};

var loadBudDetails = function (hcmHouseCode, hcmJob, fscYear, callback) {
    loadPeriodData('budDetails', hcmHouseCode, hcmJob, fscYear, BudDetails, true, callback);
};

var loadProjectedDetails = function (hcmHouseCode, hcmJob, fscYear, callback) {
    loadPeriodData('budProjectedDetails', hcmHouseCode, hcmJob, fscYear, ProjectedDetails, true, callback);
};

var loadProjectedWorDetails = function (hcmHouseCode, hcmJob, fscYear, callback) {
    loadPeriodData('budProjectedWORDetails', hcmHouseCode, hcmJob, fscYear, ProjectedWorDetails, true, callback);
};

var loadProjectedComments = function (hcmHouseCode, hcmJob, fscYear, callback) {
    loadPeriodData('budProjectedComments', hcmHouseCode, hcmJob, fscYear, ProjectedComments, false, callback);
};

var initMopDataItem = function (dataItem) {
    for (var i = 1; i <= 14; i++) {
        dataItem['Budget' + i] = 0;
        dataItem['Projection' + i] = 0;
        dataItem['Variance' + i] = 0;
        dataItem['RunRate' + i] = 0;
        dataItem['DailyRunRate' + i] = 0;
        dataItem['Forecast' + i] = 0;
        dataItem['Comment' + i] = '';
        dataItem['WorModified' + i] = false;
    }
    dataItem['BudgetTotal'] = 0;
    dataItem['ProjectionTotal'] = 0;
    //dataItem['WorModified'] = false;
};

var createFscAccountDataItem = function (fscAccount) {
    var FscAccount = FscAccountLookup[fscAccount];           // bine.query(FscAccounts).where(function (f) { return f.Id == fscAccount; }).first();
    var FscAccountCategory = FscAccountCategoryLookup[FscAccount.CategoryId];          // bine.query(FscAccountCategories).where(function (f) { return f.Id == FscAccount.CategoryId; }).first();

    var dataItem = { FscAccount: fscAccount, FscAccountDescription: FscAccount.Description, IsAccount: true };

    dataItem.CategoryId = FscAccountCategory.Id;
    dataItem.SortIndex = FscAccountCategory.OrderIndex.toString().padLeft('0', 4) + '_' + FscAccount.Code;

    initMopDataItem(dataItem);

    return dataItem;

};

var createFscAccountCategoryDataItem = function (fscAccountCategory) {

    var FscAccountCategory = FscAccountCategoryLookup[fscAccountCategory];            //bine.query(FscAccountCategories).where(function (f) { return f.Id == fscAccountCategory; }).first();

    var dataItem = { FscAccount: FscAccountCategory.Id, FscAccountDescription: FscAccountCategory.Description, IsCategory: true };

    dataItem.SortIndex = FscAccountCategory.OrderIndex.toString().padLeft('0', 4) + '_9999';

    initMopDataItem(dataItem);

    return dataItem;

};

var populateMopDetails = function () {

    MopDetails = [];

    var fscAccounts = bine.query(BudDetails).select('FscAccount').toArray();
    fscAccounts = fscAccounts.concat(bine.query(ProjectedDetails).select('FscAccount').toArray());
    fscAccounts = fscAccounts.distinct();

    var categories = {};

    var totalItem = { FscAccount: 99999, FscAccountDescription: 'Total', IsTotal: true, SortIndex: '9999_9999' };
    initMopDataItem(totalItem);
    MopDetails.push(totalItem);

    $.each(fscAccounts, function (index, fscAccount) {

        var dataItem = createFscAccountDataItem(fscAccount);

        var categoryItem = categories[dataItem.CategoryId];
        if (!categoryItem) {
            categoryItem = createFscAccountCategoryDataItem(dataItem.CategoryId);
            categories[dataItem.CategoryId] = categoryItem;
        }

        var budgetTotal = 0;
        var projectionTotal = 0;

        var budget = bine.query(BudDetails).where(function (b) { return b.FscAccount == fscAccount; }).first();
        if (budget) {
            for (var i = 1; i <= 14; i++) {
                dataItem['Budget' + i] = budget['Period' + i] || 0;
                categoryItem['Budget' + i] += dataItem['Budget' + i];
                totalItem['Budget' + i] += dataItem['Budget' + i];
                budgetTotal += budget['Period' + i] || 0;
            }
        }

        var projection = bine.query(ProjectedDetails).where(function (b) { return b.FscAccount == fscAccount; }).first();
        if (projection) {
            for (var i = 1; i <= 14; i++) {
                dataItem['Projection' + i] = Math.round((projection['Period' + i] || 0) * 100) / 100;
                categoryItem['Projection' + i] += dataItem['Projection' + i];
                totalItem['Projection' + i] += dataItem['Projection' + i];

            }
        }

        var forecast = bine.query(ProjectedWorDetails).where(function (b) { return b.FscAccount == fscAccount; }).first();
        if (forecast) {
            for (var i = 1; i <= 14; i++) {
                dataItem['Forecast' + i] = forecast['Period' + i] || 0;
                categoryItem['Forecast' + i] += dataItem['Forecast' + i];
                totalItem['Forecast' + i] += dataItem['Forecast' + i];
                projectionTotal += dataItem['Forecast' + i] || 0;
            }
        }
        for (var i = 1; i <= 14; i++) {
            dataItem['Variance' + i] = (dataItem['Projection' + i] - dataItem['Budget' + i]) || 0;
            categoryItem['Variance' + i] += (dataItem['Projection' + i] - dataItem['Budget' + i]) || 0;
            totalItem['Variance' + i] += (dataItem['Projection' + i] - dataItem['Budget' + i]) || 0;

        }

        var comment = bine.query(ProjectedComments).where(function (b) { return b.FscAccount == fscAccount; }).first();
        if (comment) {
            for (var i = 1; i <= 14; i++) {
                dataItem['Comment' + i] = comment['Period' + i] || '';
            }
        }

        dataItem['ProjectionTotal'] = projectionTotal;
        dataItem['BudgetTotal'] = budgetTotal;

        categoryItem['ProjectionTotal'] += projectionTotal;
        categoryItem['BudgetTotal'] += budgetTotal;

        totalItem['ProjectionTotal'] += projectionTotal;
        totalItem['BudgetTotal'] += budgetTotal;


        MopDetails.push(dataItem);
    });

    for (var key in categories)
        MopDetails.push(categories[key]);

    MopDetails = bine.query(MopDetails).orderBy('SortIndex').toArray();

};

var loadMopData = function (hcmHouseCode, hcmJob, fscYear, callback) {

    var dataLoadedCount = 0;
    var innerCallback = function () {
        dataLoadedCount++;
        if (dataLoadedCount == 4) {

            populateMopDetails();

            callback(MopDetails);

        }
    };

    loadBudDetails(hcmHouseCode, hcmJob, fscYear, innerCallback);
    loadProjectedDetails(hcmHouseCode, hcmJob, fscYear, innerCallback);
    loadProjectedComments(hcmHouseCode, hcmJob, fscYear, innerCallback);
    loadProjectedWorDetails(hcmHouseCode, hcmJob, fscYear, innerCallback);
    loadMopPeriodItems(hcmHouseCode, hcmJob, fscYear);
};

var loadMopPeriodItems = function (hcmHouseCode, hcmJob, fscYear, callback) {
    var criteriaXml = String.format('<criteria>hcmHouseCode:{0},fscYear:{2},hcmJob:{1},storeId:budMopPeriodItems,userId:[user],</criteria>', hcmHouseCode, hcmJob, fscYear);

    var innerCallback = function (data) {

        MopDetails = [];

        var mopItemIndex = {};

        var totalItem = { FscAccount: 99999, FscAccountDescription: 'Total', IsTotal: true, SortIndex: '9999_9999' };
        initMopDataItem(totalItem);
        MopDetails.push(totalItem);

        var currentPeriodIndex = GetCurrentFscPeriod()['Number'];
        /*
        $('item', $(data)).each(function (index, item) {
        var $item = $(item);

        var dataItem = { fscPeriod: parseInt($item.attr('fscPeriod')), fscAccount: parseInt($item.attr('fscAccount')),
        mop: parseFloat($item.attr('mop')), budget: parseFloat($item.attr('budget')), runrate: parseFloat($item.attr('runrate')), wor: parseFloat($item.attr('wor')),
        worModified: $item.attr('wormodified') == '1',
        comments: $item.attr('comments')
        };
        dataItem.mop2Budget = dataItem.mop - dataItem.budget;
        dataItem.runrate = Math.round(dataItem.runrate * 100) / 100;

        MopPeriodItems.push(dataItem);

        var mopAccountItem = mopItemIndex[dataItem.fscAccount];
        if (!mopAccountItem) {
        mopAccountItem = createFscAccountDataItem(dataItem.fscAccount);
        MopDetails.push(mopAccountItem);
        mopItemIndex[dataItem.fscAccount] = mopAccountItem;
        }

        var mopCategoryItem = mopItemIndex[mopAccountItem.CategoryId];
        if (!mopCategoryItem) {
        mopCategoryItem = createFscAccountCategoryDataItem(mopAccountItem.CategoryId);
        MopDetails.push(mopCategoryItem);
        mopItemIndex[mopAccountItem.CategoryId] = mopCategoryItem;
        }

        //var FscPeriod = GetFscPeriod(dataItem.fscPeriod);
        });*/

        $('item', $(data)).each(function (index, item) {
            var $item = $(item);

            var dataItem = { fscPeriod: parseInt($item.attr('fscPeriod')), fscAccount: parseInt($item.attr('fscAccount')),
                mop: parseFloat($item.attr('mop')), budget: parseFloat($item.attr('budget')), runrate: parseFloat($item.attr('runrate')), wor: parseFloat($item.attr('wor')),
                worModified: $item.attr('wormodified') == '1',
                comments: $item.attr('comments')
            };
            dataItem.mop2Budget = dataItem.mop - dataItem.budget;
            dataItem.runrate = Math.round(dataItem.runrate * 100) / 100;

            var mopAccountItem = mopItemIndex[dataItem.fscAccount];
            if (!mopAccountItem) {
                mopAccountItem = createFscAccountDataItem(dataItem.fscAccount);
                MopDetails.push(mopAccountItem);
                mopItemIndex[dataItem.fscAccount] = mopAccountItem;
            }

            var mopCategoryItem = mopItemIndex[mopAccountItem.CategoryId];
            if (!mopCategoryItem) {
                mopCategoryItem = createFscAccountCategoryDataItem(mopAccountItem.CategoryId);
                MopDetails.push(mopCategoryItem);
                mopItemIndex[mopAccountItem.CategoryId] = mopCategoryItem;
            }

            var FscPeriod = GetFscPeriod(dataItem.fscPeriod);
            var FscAccount = FscAccountLookup[dataItem.fscAccount];

            var periodNumber = FscPeriod.Number;
            var dailyRunRate = Math.round(dataItem.runrate / FscPeriod.Days * 100) / 100;

            mopAccountItem['WorModified' + periodNumber] = dataItem.worModified;

            mopAccountItem['Budget' + periodNumber] = dataItem.budget;
            mopCategoryItem['Budget' + periodNumber] += dataItem.budget;
            totalItem['Budget' + periodNumber] += FscAccount.IsNegative ? dataItem.budget : -dataItem.budget;

            mopAccountItem['Projection' + periodNumber] = dataItem.mop;
            mopCategoryItem['Projection' + periodNumber] += dataItem.mop;
            totalItem['Projection' + periodNumber] += FscAccount.IsNegative ? dataItem.mop : -dataItem.mop;

            mopAccountItem['BudgetTotal'] += dataItem.budget;
            mopCategoryItem['BudgetTotal'] += dataItem.budget;
            totalItem['BudgetTotal'] += FscAccount.IsNegative ? dataItem.budget : -dataItem.budget;

            mopAccountItem['ProjectionTotal'] += dataItem.mop;
            mopCategoryItem['ProjectionTotal'] += dataItem.mop;
            totalItem['ProjectionTotal'] += FscAccount.IsNegative ? dataItem.mop : -dataItem.mop;

            mopAccountItem['RunRate' + periodNumber] = dataItem.runrate;
            mopCategoryItem['RunRate' + periodNumber] += dataItem.runrate;
            totalItem['RunRate' + periodNumber] += FscAccount.IsNegative ? dataItem.runrate : -dataItem.runrate;

            mopAccountItem['DailyRunRate' + periodNumber] = dailyRunRate;
            mopCategoryItem['DailyRunRate' + periodNumber] += dailyRunRate;
            totalItem['DailyRunRate' + periodNumber] += FscAccount.IsNegative ? dailyRunRate : -dailyRunRate;

            mopAccountItem['Forecast' + periodNumber] = dataItem.wor;
            mopCategoryItem['Forecast' + periodNumber] += dataItem.wor;
            totalItem['Forecast' + periodNumber] += FscAccount.IsNegative ? dataItem.wor : -dataItem.wor;

            mopAccountItem['Comment' + periodNumber] += dataItem.comments;

            mopAccountItem['WorModified' + periodNumber] = dataItem.worModified;
            if (currentPeriodIndex == periodNumber) {
                mopAccountItem['WorModified'] = dataItem.worModified;
            }

            mopAccountItem['Variance' + periodNumber] = dataItem.mop2Budget;
            mopCategoryItem['Variance' + periodNumber] += dataItem.mop2Budget;
            //totalItem['Variance' + periodNumber] += dataItem.mop2Budget;
        });

        for (var i = 1; i <= 14; i++) {
            totalItem['Variance' + i] = (totalItem['Projection' + i] || 0) - (totalItem['Budget' + i] || 0);
        }

        MopDetails = bine.query(MopDetails).orderBy('SortIndex').toArray();

        callback(MopDetails);

    };

    // innerCallback(test_data);
    fin.bud.budRequest(criteriaXml, innerCallback); ;

}


var submitMopItems = function (changes, callback) {
    var xml = ['<transaction id="1">\r\n'];

    $.each(changes, function (index, item) {

        xml.push('<budProjectedDetail ');
        xml.push(String.format(' hcmHouseCode="{0}"', item.HcmHouseCode));
        xml.push(String.format(' hcmJob="{0}"', item.HcmJob));
        xml.push(String.format(' fscYear="{0}"', item.FscYear));
        xml.push(String.format(' fscAccount="{0}"', item.FscAccount));

        for (var i = 1; i <= 14; i++) {
            xml.push(String.format(' period{1}="{0}"', item['Projection' + i] || 0, i));
        }
        xml.push(' />\r\n');

        xml.push('<budProjectedComment ');
        xml.push(String.format(' hcmHouseCode="{0}"', item.HcmHouseCode));
        xml.push(String.format(' hcmJob="{0}"', item.HcmJob));
        xml.push(String.format(' fscYear="{0}"', item.FscYear));
        xml.push(String.format(' fscAccount="{0}"', item.FscAccount));

        for (var i = 1; i <= 14; i++) {
            xml.push(String.format(' period{1}="{0}"', htmlEncode(item['Comment' + i] || ''), i));
        }
        xml.push(' />\r\n');


    });

    xml.push('</transaction>');

    fin.bud.budSubmit(xml.join(''), callback);
};


var loadWorSummaryComment = function (hcmHouseCode, hcmJob, fscYear, fscPeriod, callback) {
    var criteriaXml = String.format('<criteria>hcmHouseCode:{0},fscYear:{2},hcmJob:{1},storeId:budBudgetWORForecastComments, fscPeriod: {3},userId:[user],</criteria>',
             hcmHouseCode, hcmJob, fscYear, fscPeriod);

    fin.bud.budRequest(criteriaXml, function (data) {

        var first = $('item:first', $(data));
        if (first.length == 0)
            callback('');
        else
            callback(first.attr('comment'));
    });

};

var saveWorSummaryComment = function (hcmHouseCode, hcmJob, fscYear, fscPeriod, comment, callback) {
    var xml = ['<transaction id="1">\r\n'];

    xml.push('<budBudgetWORForecastComment ');
    xml.push(String.format(' hcmHouseCode="{0}"', hcmHouseCode));
    xml.push(String.format(' hcmJob="{0}"', hcmJob));
    xml.push(String.format(' fscYear="{0}"', fscYear));
    xml.push(String.format(' fscPeriod="{0}"', fscPeriod));
    xml.push(String.format(' comment="{0}"', comment.replace(/&/gi, '&amp;').replace(/"/gi, '&quot;').replace(/</gi,'&lt;').replace(/>/gi,'&gt;')));
    xml.push(' />\r\n');

    xml.push('</transaction>');

    fin.bud.budSubmit(xml.join(''), callback);
}
    //

 var $mop_templates = $(window.__bt__0bf692a1[2]);


 var MopDataControllerHeader = function () {

     var Header = bine.extend(bine.Control, {
         tpl: $('#controller-header', $mop_templates).html(),

         onDomReady: function () {
             var me = this;

             me.$("#SelectAllRunRate").change(function (e) {
                 me.fireEvent('checkrunrate', $(this).attr("checked") == "checked");
             });

             me.$("#SelectAllPeriods").change(function () {
                 me.fireEvent('checkfuture', $(this).attr("checked") == "checked");
             });

             me.$('#updaterunrate-button').click(function (e) {
                 if (e)
                     e.preventDefault();
                 me.fireEvent('updaterunrate');
             });

             me.$('#updatefuture-button').click(function (e) {
                 if (e)
                     e.preventDefault();

                 me.fireEvent('updatefuture');
             });

         }
     });

     return Header;
 } ();


var MopGridHeader = function () {

    var htmlBuilder = [];
    htmlBuilder.push('<table class="bud-table-2"><thead class="table-head">');

    htmlBuilder.push('<tr>');
    for (var i = 1; i <= 13; i++) {
        htmlBuilder.push(String.format('<th colspan="7" class="boundary mop-period-title mop-period-{0}" style="text-align:center; height:30px;">Period {0}</th>', i));
    }
    htmlBuilder.push('<th rowspan="2" class="boundary"  style="text-align:center; width:100px; height:73px;"><br/>Full Year<br/>Projections</th>');
    htmlBuilder.push('<th rowspan="2" class=""  style="text-align:center; width:100px;"><br/>Full Year<br/>Budget</th>');

    htmlBuilder.push('</tr>');

    htmlBuilder.push('<tr style="height:55px;">');
    for (var i = 1; i <= 13; i++) {
        htmlBuilder.push(String.format('<th class="mop-projection amount-col mop-period-{0}" style="width:100px; display:none;">MOP</th>', i));
        htmlBuilder.push(String.format('<th class="mop-budget amount-col  mop-period-{0}" style="width:100px; display:none;">Budget</th>', i));
        htmlBuilder.push(String.format('<th style="text-align:center;width:100px; display:none;"  class="mop-variance mop-period-{0}" >MOP to <br/>Budget Var</th>', i));
        htmlBuilder.push(String.format('<th class="mop-drunrate amount-col mop-period-{0}" style="width:100px; display:none;">Daily Run Rate</th>', i));
        htmlBuilder.push(String.format('<th style="width:100px; display:none;" class="mop-runrate amount-col mop-period-{0}" >Run Rate</th>', i));
        htmlBuilder.push(String.format('<th style="text-align:center;width:100px; display:none;" class="mop-actual mop-period-{0}">Current Month<br/>Actual</th>', i));
        htmlBuilder.push(String.format('<th style="width:150px;; display:none;" class="boundary mop-comment mop-period-{0}" >Comments</th>', i));
    }

    htmlBuilder.push('</tr>');
    htmlBuilder.push('</thead></table>');

    var Header = bine.extend(bine.Control, {
        tpl: htmlBuilder.join('')
    });

    return Header;
} ();


var MopController = function () {

    var fieldConfig = { UpdateRunRate: { type: 'bool' }, UpdateFuture: { type: 'bool'} };

    var DataViewList = bine.extend(bine.DataViewList, {
        tpl: $('#controller-list', $mop_templates).html(), itemContainerId: 'item-wrapper',
        fscYear: 0, 
        createDataView: function () {
            var me = this;

            var dv = new bine.DataView({ tpl: $('#controller-view', $mop_templates).html(),
                onDomReady: function () {
                    var dv = this;

                    dv.$('.account-link').click(function (e) {
                        e.preventDefault();
                        if (dv.val('IsAccount'))
                            me.fireEvent('showaccountwor', dv.val('FscAccount'));
                    });


                    dv.on('change', function (name, value) {
                        if (name == dv.name) {
                            if (dv.val('IsCategory') || dv.val('IsTotal')) {
                                dv.$this.addClass('account-category-data-view');
                                dv.$this.addClass('summary');
                                // dv.disable();
                                if (dv.getField('UpdateFuture'))
                                    dv.getField('UpdateFuture').css('display', 'none');
                                if (dv.getField('UpdateRunRate'))
                                    dv.getField('UpdateRunRate').css('display', 'none');
                                dv.$('.account-link').addClass('display-as-text');
                            }
                            else
                                dv.$('.account-link').addClass('account-item-link');

                            if (dv.getField('UpdateRunRate')) {
                                if (dv.val('WorModified'))
                                    dv.getField('UpdateRunRate').prop('disabled', true);
                                else
                                    dv.getField('UpdateRunRate').prop('disabled', false);
                            }
                        }

                    });
                }
            }, fieldConfig);
            return dv;
        }
    });

    return DataViewList;
} ();


var MopGrid = function () {


    var htmlBuilder = [];
    htmlBuilder.push('<tr>');

    for (var i = 1; i <= 13; i++) {
        htmlBuilder.push(String.format('<td class="mop-projection amount-col mop-period-{0}" style="width:100px; display:none;"><input type="text"  style="width:100%;" name="Projection{0}" /></td>', i));
        htmlBuilder.push(String.format('<td class="mop-budget amount-col mop-period-{0}" style="width:100px; display:none;" name="Budget{0}"></td>', i));
        htmlBuilder.push(String.format('<td class="mop-variance amount-col mop-period-{0}" style="width:100px; display:none;" name="Variance{0}"></td>', i));
        htmlBuilder.push(String.format('<td class="mop-drunrate amount-col mop-period-{0}" style="width:100px; display:none;" name="DailyRunRate{0}"></td>', i));
        htmlBuilder.push(String.format('<td class="mop-runrate amount-col mop-period-{0}" style="width:100px; display:none;" name="RunRate{0}"></td>', i));
        htmlBuilder.push(String.format('<td class="mop-actual amount-col mop-period-{0}" style="width:100px; display:none;" name="Forecast{0}"></td>', i));
        htmlBuilder.push(String.format('<td class="mop-comment mop-period-{0} boundary" style="width:150px; display:none;"><input type="text" name="Comment{0}" style="width:100%;" /></td>', i));
    }

    htmlBuilder.push('<td  class="boundary amount-col" style="width:100px;height:20px; padding-top:0; padding-bottom:0; vertical-align:baseline;"  name="ProjectionTotal"></td>');
    htmlBuilder.push('<td  class=" amount-col" style="width:100px;" name="BudgetTotal"></td>');

    htmlBuilder.push('</tr>');

    var TPL_VIEW = htmlBuilder.join('\r\n');

    var amountDisplay = function (value) {
        if (!value)
            return '0.00';
        return bine.format(value, '0,000.00');
    };

    var amountEdit = function (value) {
        if (!value)
            return 0;
        return value;
    };

    var amountConfig = {
        convertDisplay: amountDisplay,
        convertBack: amountEdit,
        convert: function (value) {
            return parseFloat(value);
        }
    }

    var fieldConfig = { UpdateRunRate: { type: 'bool' }, UpdateFuture: { type: 'bool'} };

    for (var i = 1; i <= 13; i++) {
        fieldConfig['Budget' + i] = { type: 'number', format: '0,000.00', allowNegative: true }
        fieldConfig['Projection' + i] = { type: 'number', format: '0,000.00', allowNegative: true }
        fieldConfig['Forecast' + i] = { type: 'number', format: '0,000.00', allowNegative: true }
        fieldConfig['Variance' + i] = { type: 'number', format: '0,000.00', allowNegative: true }
        fieldConfig['RunRate' + i] = { type: 'number', format: '0,000.00', allowNegative: true }
        fieldConfig['DailyRunRate' + i] = { type: 'number', format: '0,000.00', allowNegative: true }
    }

    fieldConfig['BudgetTotal'] = { type: 'number', format: '0,000.00', convertDisplay: function (value) {
        var total = 0;
        for (var i = 1; i <= 13; i++) {
            total += this.val('Budget' + i) || 0;
        }
        this.val()['BudgetTotal'] = total;
        return bine.format(total, '0,000.00');
    }
    };

    fieldConfig['ProjectionTotal'] = { type: 'number', format: '0,000.00', convertDisplay: function (value) {
        var total = 0;
        for (var i = 1; i <= 13; i++) {
            total += this.val('Projection' + i) || 0;
        }
        this.val()['ProjectionTotal'] = total;
        return bine.format(total, '0,000.00');
    }
    };

    var DataViewList = bine.extend(bine.DataViewList, {
        tpl: $('#controller-list', $mop_templates).html(), itemContainerId: 'item-wrapper',
        fscYear: 0,
        createDataView: function () {
            var me = this;

            var dv = new bine.DataView({ tpl: TPL_VIEW,
                onDomReady: function () {
                    var dv = this;


                    me.$("#SelectAllRunRate").change(function (e) {
                        if ($(this).attr("checked") == "checked" && !dv.val('WorModified')) {
                            dv.val('UpdateRunRate', true);
                        }
                        else {
                            dv.val('UpdateRunRate', false);
                        }
                    });

                    me.$("#SelectAllPeriods").change(function () {
                        if ($(this).attr("checked") == "checked") {
                            dv.val('UpdateFuture', true);
                        }
                        else {
                            dv.val('UpdateFuture', false);
                        }
                    });

                    dv.$('.account-link').click(function (e) {
                        e.preventDefault();
                        if (dv.val('IsAccount'))
                            me.fireEvent('showaccountwor', dv.val('FscAccount'));
                    });


                    var today = new Date();
                    today.setHours(0, 0, 0, 0);
                    dv.on('change', function (name, value) {


                        if (name == dv.name) {
                            if (dv.val('IsCategory') || dv.val('IsTotal')) {
                                dv.$this.addClass('account-category-data-view');
                                dv.$this.addClass('summary');
                                // dv.disable();
                                if (dv.getField('UpdateFuture'))
                                    dv.getField('UpdateFuture').css('display', 'none');
                                if (dv.getField('UpdateRunRate'))
                                    dv.getField('UpdateRunRate').css('display', 'none');
                                dv.$('.account-link').addClass('display-as-text');
                            }
                            else
                                dv.$('.account-link').addClass('account-item-link');

                            if (dv.getField('UpdateRunRate')) {
                                if (dv.val('WorModified'))
                                    dv.getField('UpdateRunRate').prop('disabled', true);
                                else
                                    dv.getField('UpdateRunRate').prop('disabled', false);
                            }
                        }

                        var projectionTotal = 0;
                        if (!me.isController) {
                            for (var i = 1; i <= 13; i++) {
                                var FscPeriod = GetFscPeriod2(me.fscYear, i);
                                if (FscPeriod) {
                                    if (dv.val('WorModified' + i) || dv.val('IsCategory') || dv.val('IsTotal')
                              || FscPeriod.EndDt < today) {
                                        dv.getField('Projection' + i).attr('readonly', 'readonly');
                                        dv.getField('Comment' + i).attr('readonly', 'readonly');        //.prop('disabled', true);
                                        dv.getField('Projection' + i).addClass('mop-disabled');
                                    }
                                    else {
                                        dv.getField('Projection' + i).removeAttr('readOnly');               //.prop('disabled', false);
                                        dv.getField('Projection' + i).removeClass('mop-disabled');
                                    }
                                }
                            }
                        }

                        if (name.startsWith('Projection') && name != 'ProjectionTotal') {
                            var periodNumber = name.replace('Projection', '');
                            dv.val('Variance' + periodNumber, value - dv.val('Budget' + periodNumber));

                            var projectionTotal = 0;
                            for (var i = 1; i <= 13; i++) {
                                projectionTotal += dv.val('Projection' + i);
                            }
                            dv.val('ProjectionTotal', projectionTotal);

                            var mopDetails = me.val();

                            if (dv.val('IsAccount')) {
                                var categoryView = me.getDataView(mopDetails.indexOf(bine.query(mopDetails).where(function (f) { return f.FscAccount == dv.val('CategoryId'); }).first()));

                                categoryView.val(name, bine.query(mopDetails).where(function (i) { return i.CategoryId == categoryView.val('FscAccount'); }).select(name).toArray().sum());
                            }
                            else if (dv.val('IsCategory')) {
                                var totalView = me.getDataView(me.itemCount() - 1);
                                totalView.val(name, bine.query(mopDetails).where(function (i) { return i.IsCategory; }).select(name).toArray().sum());
                            }
                        }
                    });
                }
            }, fieldConfig);
            return dv;
        },

        onDomReady: function () {
            var me = this;

            me.$('#updaterunrate-button').click(function () {
                var periodIndex = GetCurrentFscPeriod()['Number'];
                me.each(function (index, dv) {
                    if (dv.val('UpdateRunRate'))
                        dv.val('Projection' + periodIndex, dv.val('RunRate' + periodIndex));
                });
            });

            me.$('#updatefuture-button').click(function () {
                var periodIndex = me.periodStart;         //GetCurrentFscPeriod()['Number'];
                me.each(function (index, dv) {
                    if (dv.val('UpdateFuture')) {
                        for (var i = periodIndex + 1; i <= 13; i++) {
                            dv.val('Projection' + i, dv.val('Projection' + periodIndex));
                        }
                    }
                });
            });

        },

        addFscAccount: function (fscAccount) {
            var me = this;

            var mopDetails = me.val();

            var exists = bine.query(mopDetails).where(function (f) { return f.FscAccount == fscAccount; }).first() != null;
            if (exists)
                return;

            var getPriorIndex = function (sortIndex) {
                for (var i = 0; i < mopDetails.length; i++) {
                    if (mopDetails[i].SortIndex > sortIndex)
                        return i;
                }
                return mopDetails.length;
            };

            var dataItem = createFscAccountDataItem(fscAccount);

            //            var dataItemIndex = mopDetails.indexOf(bine.query(mopDetails).where(function (f) { return f.SortIndex < dataItem.SortIndex; }).orderBy('SortIndex', false).first()) + 1;
            //            if (dataItemIndex < 0)
            //                dataItemIndex = 0;
            var dataItemIndex = getPriorIndex(dataItem.SortIndex);

            var dv = me.insert(dataItemIndex, dataItem);

            mopDetails = me.val();
            var categoryItem = bine.query(mopDetails).where(function (f) { return f.FscAccount == dataItem.CategoryId; }).first();
            if (!categoryItem) {
                categoryItem = createFscAccountCategoryDataItem(dataItem.CategoryId);

                //                var categoryItemIndex = mopDetails.indexOf(bine.query(mopDetails).where(function (f) { return f.SortIndex < categoryItem.SortIndex; }).orderBy('SortIndex', false).first()) + 1;
                //                if (categoryItemIndex < 0)
                //                    categoryItemIndex = 0;

                var categoryItemIndex = getPriorIndex(categoryItem.SortIndex);

                me.insert(categoryItemIndex, categoryItem);
            }

            //            mopDetails = bine.query(mopDetails).orderBy('SortIndex').toArray();
            //            console.log(mopDetails);
            //            me.val(mopDetails);
        }
    });

    return DataViewList;
} ();


var MopDataViewList = function () {


    var htmlBuilder = [];
    htmlBuilder.push('<div id="mop-list-header" class="list-header" style="width: 100%; margin: 0 auto; overflow: hidden; border: 1px solid #c6c6c6;"><div style="width:10000px" class="mop-table-container"><table class="bud-table-2"><thead class="table-head">');

    htmlBuilder.push('<tr>');
    for (var i = 1; i <= 13; i++) {
        htmlBuilder.push(String.format('<th colspan="7" class="boundary mop-period-title mop-period-{0}" style="text-align:center">Period {0}</th>', i));
    }
    htmlBuilder.push('<th rowspan="2" class="boundary"  style="text-align:center; width:100px; height:73px;"><br/>Full Year<br/>Projections</th>');
    htmlBuilder.push('<th rowspan="2" class=""  style="text-align:center; width:100px;"><br/>Full Year<br/>Budget</th>');

    htmlBuilder.push('</tr>');

    htmlBuilder.push('<tr style="height:55px;">');
    for (var i = 1; i <= 13; i++) {
        htmlBuilder.push(String.format('<th class="mop-projection amount-col mop-period-{0}" style="width:100px; display:none;">MOP</th>', i));
        htmlBuilder.push(String.format('<th class="mop-budget amount-col  mop-period-{0}" style="width:100px; display:none;">Budget</th>', i));
        htmlBuilder.push(String.format('<th style="text-align:center;width:100px; display:none;"  class="mop-variance mop-period-{0}" >MOP to <br/>Budget Var</th>', i));
        htmlBuilder.push(String.format('<th class="mop-drunrate amount-col mop-period-{0}" style="width:100px; display:none;">Daily Run Rate</th>', i));
        htmlBuilder.push(String.format('<th style="width:100px; display:none;" class="mop-runrate amount-col mop-period-{0}" >Run Rate</th>', i));
        htmlBuilder.push(String.format('<th style="text-align:center;width:100px; display:none;" class="mop-actual mop-period-{0}">Current Month<br/>Actual</th>', i));
        htmlBuilder.push(String.format('<th style="width:150px;; display:none;" class="boundary mop-comment mop-period-{0}" >Comments</th>', i));
    }

    htmlBuilder.push('</tr>');
    htmlBuilder.push('</thead></table></div></div>');
    htmlBuilder.push('<div id="mop-list-wrapper" class="list-body" style="width: 100%; min-height: 300px;margin: 0 auto; overflow: auto; overflow-x: visible;"><div class="mop-table-container" style="width:10000px"><table id="mop-item-table" class="bud-table-2">');

    htmlBuilder.push('<tbody id="item-wrapper"></tbody></table></div></div>');

    var TPL_LIST = htmlBuilder.join('\r\n');

    htmlBuilder = [];
    htmlBuilder.push('<tr>');

    for (var i = 1; i <= 13; i++) {
        htmlBuilder.push(String.format('<td class="mop-projection amount-col mop-period-{0}" style="width:100px; display:none;"><input type="text"  style="width:100%;" name="Projection{0}" /></td>', i));
        htmlBuilder.push(String.format('<td class="mop-budget amount-col mop-period-{0}" style="width:100px; display:none;" name="Budget{0}"></td>', i));
        htmlBuilder.push(String.format('<td class="mop-variance amount-col mop-period-{0}" style="width:100px; display:none;" name="Variance{0}"></td>', i));
        htmlBuilder.push(String.format('<td class="mop-drunrate amount-col mop-period-{0}" style="width:100px; display:none;" name="DailyRunRate{0}"></td>', i));
        htmlBuilder.push(String.format('<td class="mop-runrate amount-col mop-period-{0}" style="width:100px; display:none;" name="RunRate{0}"></td>', i));
        htmlBuilder.push(String.format('<td class="mop-actual amount-col mop-period-{0}" style="width:100px; display:none;" name="Forecast{0}"></td>', i));
        htmlBuilder.push(String.format('<td class="mop-comment mop-period-{0} boundary" style="width:150px; display:none;"><input type="text" name="Comment{0}" style="width:100%;" /></td>', i));
    }

    htmlBuilder.push('<td  class="boundary amount-col" style="width:100px"  name="ProjectionTotal"></td>');
    htmlBuilder.push('<td  class=" amount-col" style="width:100px" name="BudgetTotal"></td>');

    htmlBuilder.push('</tr>');

    var TPL_VIEW = htmlBuilder.join('\r\n');

    htmlBuilder = [];
    htmlBuilder.push('<div class="list-header" style="width: 100%; margin: 0 auto; overflow: hidden; border: 1px solid #c6c6c6;"><div class="mop-table-container"><table class="bud-table-2"><thead class="table-head">');

    htmlBuilder.push('<tr>');
    htmlBuilder.push('<th class="boundary mop-updatefuture" style="width:100px"><br/><div class="row1-btn"><button class="bine-btn bine-btn-txt bine-ctrl" id="updatefuture-button"  style="height:50px;">Update Future<br/>Periods w/MOP</button></div><div style="padding:5px;"><div style="width:13px; height:20px;padding-top:3px;float:left;"><input type="checkbox" name="selectAllPeriods" id="SelectAllPeriods"/></div><span style="line-height:18px; height:20px;padding-left:5px;">Select All</span><div style="clear:both;"></div></div></th>');
    htmlBuilder.push('<th class="boundary mop-updaterunrate"   style="width:90px"><br/><div class="row1-btn"><button class="bine-btn bine-btn-txt bine-ctrl " id="updaterunrate-button" style="height:50px;">Update With<br/>Run Rate</button></div><div style="padding:5px;"><div style="width:13px; height:20px;padding-top:3px;float:left;"><input type="checkbox" name="selectAll" id="SelectAllRunRate"/></div><span style="float:left;line-height:18px; height:20px;padding-left:5px;">Select All</span><div style="clear:both;"></div></div></th>');
    htmlBuilder.push('<th class="boundary mop-accountcode-title" style="width:245px">Account Code</th>');
    htmlBuilder.push('</tr>');
    htmlBuilder.push('</thead></table></div></div>');
    htmlBuilder.push('<div  class="list-body" style="width: 100%; min-height: 300px;margin: 0 auto; overflow: auto; overflow-x: visible;"><div class="mop-table-container" ><table id="mop-item-table" class="bud-table-2">');

    htmlBuilder.push('<tbody id="item-wrapper"></tbody></table></div></div>');

    var LEFT_TPL_LIST = htmlBuilder.join('\r\n');

    htmlBuilder = [];
    htmlBuilder.push('<tr>');
    htmlBuilder.push('<td class="boundary mop-updatefuture" style="width:100px"><div style="padding:3px 7px;"><input type="checkbox" name="UpdateFuture" /></div></td>');
    htmlBuilder.push('<td class="boundary mop-updaterunrate" style="width:90px"><div style="padding:3px 7px;"><input type="checkbox" name="UpdateRunRate" /></div></td>');
    htmlBuilder.push('<td class="boundary mop-account-column" style="white-space:nowrap;width:245px"><a href="#" class="account-link"  name="FscAccountDescription"></a></td>');
    htmlBuilder.push('</tr>');

    var LEFT_TPL_VIEW = htmlBuilder.join('\r\n');

    var amountDisplay = function (value) {
        if (!value)
            return '0.00';
        return bine.format(value, '0,000.00');
    };

    var amountEdit = function (value) {
        if (!value)
            return 0;
        return value;
    };

    var amountConfig = {
        convertDisplay: amountDisplay,
        convertBack: amountEdit,
        convert: function (value) {
            return parseFloat(value);
        }
    }

    var fieldConfig = { UpdateRunRate: { type: 'bool' }, UpdateFuture: { type: 'bool'} };

    for (var i = 1; i <= 13; i++) {
        fieldConfig['Budget' + i] = { type: 'number', format: '0,000.00', allowNegative: true }
        fieldConfig['Projection' + i] = { type: 'number', format: '0,000.00', allowNegative: true }
        fieldConfig['Forecast' + i] = { type: 'number', format: '0,000.00', allowNegative: true }
        fieldConfig['Variance' + i] = { type: 'number', format: '0,000.00', allowNegative: true }
        fieldConfig['RunRate' + i] = { type: 'number', format: '0,000.00', allowNegative: true }
        fieldConfig['DailyRunRate' + i] = { type: 'number', format: '0,000.00', allowNegative: true }
    }

    fieldConfig['BudgetTotal'] = { type: 'number', format: '0,000.00', convertDisplay: function (value) {
        var total = 0;
        for (var i = 1; i <= 13; i++) {
            total += this.val('Budget' + i) || 0;
        }
        this.val()['BudgetTotal'] = total;
        return bine.format(total, '0,000.00');
    }
    };

    fieldConfig['ProjectionTotal'] = { type: 'number', format: '0,000.00', convertDisplay: function (value) {
        var total = 0;
        for (var i = 1; i <= 13; i++) {
            total += this.val('Projection' + i) || 0;
        }
        this.val()['ProjectionTotal'] = total;
        return bine.format(total, '0,000.00');
    }
    };

    var DataViewList = bine.extend(bine.DataViewList, {
        tpl: TPL_LIST, itemContainerId: 'item-wrapper',
        fscYear: 0, isController: false,
        createDataView: function () {
            var me = this;

            var dv = new bine.DataView({ tpl: me.isController ? LEFT_TPL_VIEW : TPL_VIEW,
                onDomReady: function () {
                    var dv = this;

                    //                    $(".mop-comment").focusin(function () {
                    //                        if (!$(this).parent().hasClass("summary"))
                    //                            $(this).addClass("focus");
                    //                    });
                    //                    $(".mop-comment").focusout(function () {
                    //                        if (!$(this).parent().hasClass("summary"))
                    //                            $(this).removeClass("focus");
                    //                    });

                    //                    $(".mop-projection").focusin(function () {
                    //                        if (!$(this).parent().hasClass("summary"))
                    //                            $(this).addClass("focus");
                    //                    });
                    //                    $(".mop-projection").focusout(function () {
                    //                        if (!$(this).parent().hasClass("summary"))
                    //                            $(this).removeClass("focus");
                    //                    });


                    me.$("#SelectAllRunRate").change(function (e) {
                        if ($(this).attr("checked") == "checked" && !dv.val('WorModified')) {
                            dv.val('UpdateRunRate', true);
                        }
                        else {
                            dv.val('UpdateRunRate', false);
                        }
                    });

                    me.$("#SelectAllPeriods").change(function () {
                        if ($(this).attr("checked") == "checked") {
                            dv.val('UpdateFuture', true);
                        }
                        else {
                            dv.val('UpdateFuture', false);
                        }
                    });

                    dv.$('.account-link').click(function (e) {
                        e.preventDefault();
                        if (dv.val('IsAccount'))
                            me.fireEvent('showaccountwor', dv.val('FscAccount'));
                    });


                    var today = new Date();
                    today.setHours(0, 0, 0, 0);
                    dv.on('change', function (name, value) {


                        if (name == dv.name) {
                            if (dv.val('IsCategory') || dv.val('IsTotal')) {
                                dv.$this.addClass('account-category-data-view');
                                dv.$this.addClass('summary');
                                // dv.disable();
                                if (dv.getField('UpdateFuture'))
                                    dv.getField('UpdateFuture').css('display', 'none');
                                if (dv.getField('UpdateRunRate'))
                                    dv.getField('UpdateRunRate').css('display', 'none');
                                dv.$('.account-link').addClass('display-as-text');
                            }
                            else
                                dv.$('.account-link').addClass('account-item-link');

                            if (dv.getField('UpdateRunRate')) {
                                if (dv.val('WorModified'))
                                    dv.getField('UpdateRunRate').prop('disabled', true);
                                else
                                    dv.getField('UpdateRunRate').prop('disabled', false);
                            }
                        }

                        var projectionTotal = 0;
                        if (!me.isController) {
                            for (var i = 1; i <= 13; i++) {
                                var FscPeriod = GetFscPeriod2(me.fscYear, i);
                                if (FscPeriod) {
                                    if (dv.val('WorModified' + i) || dv.val('IsCategory') || dv.val('IsTotal')
                              || FscPeriod.EndDt < today) {
                                        dv.getField('Projection' + i).attr('readonly', 'readonly');
                                        dv.getField('Comment' + i).attr('readonly', 'readonly');        //.prop('disabled', true);
                                        dv.getField('Projection' + i).addClass('mop-disabled');
                                    }
                                    else {
                                        dv.getField('Projection' + i).removeAttr('readOnly');               //.prop('disabled', false);
                                        dv.getField('Projection' + i).removeClass('mop-disabled');
                                    }
                                }
                            }
                        }

                        if (name.startsWith('Projection') && name != 'ProjectionTotal') {
                            var periodNumber = name.replace('Projection', '');
                            dv.val('Variance' + periodNumber, value - dv.val('Budget' + periodNumber));

                            var projectionTotal = 0;
                            for (var i = 1; i <= 13; i++) {
                                projectionTotal += dv.val('Projection' + i);
                            }
                            dv.val('ProjectionTotal', projectionTotal);

                            var mopDetails = me.val();

                            if (dv.val('IsAccount')) {
                                var categoryView = me.getDataView(mopDetails.indexOf(bine.query(mopDetails).where(function (f) { return f.FscAccount == dv.val('CategoryId'); }).first()));

                                categoryView.val(name, bine.query(mopDetails).where(function (i) { return i.CategoryId == categoryView.val('FscAccount'); }).select(name).toArray().sum());
                            }
                            else if (dv.val('IsCategory')) {
                                var totalView = me.getDataView(me.itemCount() - 1);
                                totalView.val(name, bine.query(mopDetails).where(function (i) { return i.IsCategory; }).select(name).toArray().sum());
                            }
                        }
                    });
                }
            }, fieldConfig);
            return dv;
        },

        onDomReady: function () {
            var me = this;

            me.$('.wor-link').click(function (e) {
                e.preventDefault();

                me.fireEvent('showwor', parseFloat($(this).attr('periodNumber')));
            });

            me.$('#updaterunrate-button').click(function () {
                var periodIndex = GetCurrentFscPeriod()['Number'];
                me.each(function (index, dv) {
                    if (dv.val('UpdateRunRate'))
                        dv.val('Projection' + periodIndex, dv.val('RunRate' + periodIndex));
                });
            });

            me.$('#updatefuture-button').click(function () {
                var periodIndex = me.periodStart;         //GetCurrentFscPeriod()['Number'];
                me.each(function (index, dv) {
                    if (dv.val('UpdateFuture')) {
                        for (var i = periodIndex + 1; i <= 13; i++) {
                            dv.val('Projection' + i, dv.val('Projection' + periodIndex));
                        }
                    }
                });
            });

            me.$('#mop-list-wrapper').scroll(function () {
                me.$('#mop-list-header').scrollLeft(me.$('#mop-list-wrapper').scrollLeft());
            });
        },

        addFscAccount: function (fscAccount) {
            var me = this;

            var mopDetails = me.val();

            var exists = bine.query(mopDetails).where(function (f) { return f.FscAccount == fscAccount; }).first() != null;
            if (exists)
                return;

            var getPriorIndex = function (sortIndex) {
                for (var i = 0; i < mopDetails.length; i++) {
                    if (mopDetails[i].SortIndex > sortIndex)
                        return i;
                }
                return mopDetails.length;
            };

            var dataItem = createFscAccountDataItem(fscAccount);

            //            var dataItemIndex = mopDetails.indexOf(bine.query(mopDetails).where(function (f) { return f.SortIndex < dataItem.SortIndex; }).orderBy('SortIndex', false).first()) + 1;
            //            if (dataItemIndex < 0)
            //                dataItemIndex = 0;
            var dataItemIndex = getPriorIndex(dataItem.SortIndex);

            var dv = me.insert(dataItemIndex, dataItem);

            mopDetails = me.val();
            var categoryItem = bine.query(mopDetails).where(function (f) { return f.FscAccount == dataItem.CategoryId; }).first();
            if (!categoryItem) {
                categoryItem = createFscAccountCategoryDataItem(dataItem.CategoryId);

                //                var categoryItemIndex = mopDetails.indexOf(bine.query(mopDetails).where(function (f) { return f.SortIndex < categoryItem.SortIndex; }).orderBy('SortIndex', false).first()) + 1;
                //                if (categoryItemIndex < 0)
                //                    categoryItemIndex = 0;

                var categoryItemIndex = getPriorIndex(categoryItem.SortIndex);

                me.insert(categoryItemIndex, categoryItem);
            }

            //            mopDetails = bine.query(mopDetails).orderBy('SortIndex').toArray();
            //            console.log(mopDetails);
            //            me.val(mopDetails);
        }
    });

    DataViewList.CONTROLLER_TPL = LEFT_TPL_LIST;

    return DataViewList;
} ();
    //
MopDataController = function () {

    var DataGrid = bine.extend(bine.Control, {
        tpl: '<div></div>',

        _items: null,

        refreshUi: function () {

            var me = this;

            me.$this.empty();

            if (!me._items || !bine.isArray(me._items))
                return;

            var html = [];
            //html.push('  <table class="bud-table-2 list-body mop-grid" cellpadding="0" cellspacing="0">');
            for (var i = 0; i < me._items.length; i++) {
                me.renderDataItem(me._items[i], html);
            }
            html.push('');
            //  html.push('</table>');
            html.push('<div style="height:50px" ></div>');
            me.$this.html(html.join('\r\n'));

            me.$('input').change(function () {
                var $el = $(this);
                var val = $el.val() || '0';
                val = val.replace(',', '');
                me.fireEvent('change', $el.attr('id'), val);
            });



            me.$('.bine-dv-right-field').keydown(function (e) {
                var key = e.charCode || e.keyCode || 0;

                if (e.ctrlKey)
                    return true;

                // allow backspace, tab, delete, arrows, numbers and keypad numbers ONLY 
                return (
                                        key == 8 ||
                                        key == 9 ||
                                        key == 46 ||
                                        (key >= 37 && key <= 40) ||
                                        (key >= 48 && key <= 57) ||
                                        (key >= 96 && key <= 105)
                                        || (key == 109 || key == 189)  // FF: 109, IE: 189
                                        || key == 190
                                        || key == 110);
            });

            me.$('a').click(function (e) {
                e.preventDefault();
                var $el = $(this);
                me.fireEvent('showaccountwor', $el.attr('id'));
            });

        },

        renderDataItem: function (dataItem, html) {
            var me = this;

            var width = (me.endPeriod - me.startPeriod + 1) * (bine.isIE ? 757 : 750) + 200;
            html.push('<table class="bud-table-2 list-body mop-grid" style="width:' + width + 'px" >');

            if (dataItem.IsCategory || dataItem.IsTotal)
                html.push('<tr class="bine-ctrl bine-dv account-category-data-view" >');
            else
                html.push('<tr class="bine-ctrl bine-dv">');

            if (me.currentPeriodAvailable) {
                if (dataItem.IsCategory || dataItem.IsTotal) {
                    html.push(' <td style="width: 100px;; " class="boundary">&nbsp;</td>');
                    html.push(' <td style="width: 90px; " class="boundary">&nbsp;</td>');
                }
                else {
                    html.push(String.format(' <td style="width: 100px; " class="boundary"><input id="UpdateFuture_' + dataItem.FscAccount + '" type="checkbox" name="UpdateFuture" {0}></td>', (dataItem.UpdateFuture ? 'checked="checked"' : '')));
                    html.push(String.format(' <td style="width: 90px; " class="boundary"><input id="UpdateRunRate_' + dataItem.FscAccount + '" type="checkbox" name="UpdateRunRate" {0}></td>', (dataItem.UpdateRunRate ? 'checked="checked"' : '')));
                }

            }

            if (dataItem.IsCategory || dataItem.IsTotal)
                html.push('<td class="boundary" style=" width: 245px;  text-align:right;height:20px "><div style="">');
            else
                html.push('<td class="boundary" style=" width: 245px;text-align:left;height:20px "><div style="">');

            if (!me.currentPeriodAvailable || dataItem.IsCategory || dataItem.IsTotal)
                html.push(dataItem['FscAccountDescription']);
            else
                html.push('<a href="#" class="account-link" id="' + dataItem['FscAccount'] + '">' + dataItem['FscAccountDescription'] + '</a>');
            html.push('</div></td>');

            html.push('</tr>');
            html.push('</table>');

        },

        val: function (data) {
            var me = this;

            if (arguments.length == 0)
                return me._items;

            if (data && me._items != data) {
                me._items = data;
                me.refreshUi();
            }

        }

    });

    return DataGrid;
} ();

MopDataGridHeader = function () {

    var Header = bine.extend(bine.Control, {
        tpl: '<div></div>',

        startPeriod: 1,

        endPeriod: 14,

        showBudget: true,
        showRunRate: true,
        showVariance: true,

        setPeriodRange: function (start, end) {
            var me = this;
            me.startPeriod = start;
            me.endPeriod = end;
            me.refreshUi();
        },

        refreshUi: function () {

            var me = this;

            me.$this.empty();

            var html = [];
            html.push('<table class="bud-table-2"><thead class="table-head">');

            html.push('<tr>');
            for (var i = me.startPeriod; i <= me.endPeriod; i++) {
                html.push(String.format('<th colspan="7" class="boundary mop-period-title mop-period-{0}" style="text-align:center; height:58px;">Period {0}</th>', i));
            }
            html.push('<th rowspan="2" class="boundary"  style="text-align:center; width:100px; height:89px;"><br/>Full Year<br/>Projections</th>');
            html.push('<th rowspan="2" class=""  style="text-align:center; width:100px;"><br/>Full Year<br/>Budget</th>');

            html.push('</tr>');

            html.push('<tr>');
            for (var i = me.startPeriod; i <= me.endPeriod; i++) {
                html.push(String.format('<th class="mop-projection mop-period-{0}" style="text-align:center;width:100px; ">MOP</th>', i));
                if (me.showBudget)
                    html.push(String.format('<th class="mop-budget mop-period-{0}" style="text-align:center;width:100px; ">Budget</th>', i));
                if (me.showVariance)
                    html.push(String.format('<th style="text-align:center;width:100px; "  class="mop-variance mop-period-{0}" >MOP to <br/>Budget Var</th>', i));
                html.push(String.format('<th class="mop-drunrate  mop-period-{0}" style="text-align:center;width:100px; ">Daily Run Rate</th>', i));
                if (me.showRunRate)
                    html.push(String.format('<th style="text-align:center;width:100px; " class="mop-runrate  mop-period-{0}" >Run Rate</th>', i));
                html.push(String.format('<th style="text-align:center;width:100px;  height: 24px;" class="mop-actual mop-period-{0}">Current Month<br/>Actual</th>', i));
                html.push(String.format('<th style="text-align:center;width:150px;; " class="boundary mop-comment mop-period-{0}" >Comments</th>', i));
            }

            html.push('</tr>');
            html.push('</thead></table>');


            html.push('</table>');

            me.$this.html(html.join('\r\n'));

        }

    });

    return Header;

} ();

MopDataGrid = function () {

    var DataGrid = bine.extend(bine.Control, {
        tpl: $('#controller-list', $mop_templates).html(),

        _items: null,

        fscYear: 3,
        startPeriod: 1,
        endPeriod: 14,

        showBudget: true,
        showRunRate: true,
        showVariance: true,

        setPeriodRange: function (start, end, refreshIt) {
            var me = this;
            me.startPeriod = start;
            me.endPeriod = end;
            if (refreshIt)
                me.refreshUi();

        },

        refreshUi: function () {

            var me = this;

            document.getElementById(me.id('holder')).innerHTML = '';

            if (!bine.isArray(me._items))
                return;

            var html = [];
            // html.push('  <table id="mop-item-table" class="bud-table-2 list-body mop-grid" cellpadding="0" cellspacing="0">');
            for (var i = 0; i < me._items.length; i++) {
                me.renderDataItem(me._items[i], html);
            }
            html.push('<div stye="height:200px">&nbsp;</div>');


            document.getElementById(me.id('holder')).innerHTML = html.join('\r\n');


            me.$('input').change(function () {

                var $el = $(this);
                var val = $el.val() || '0';
                val = val.replace(',', '');
                me.fireEvent('change', $el.attr('id'), val);

//                var $el = $(this);
//                me.fireEvent('change', $el.attr('id'), $el.val());
            }).focus(function () {
                $(this).select();
            });

            var verticalFocusElement = function ($el, step) {
                var $currentCell = $el.parent();
                var $currentRow = $currentCell.parent();

                var $cells = $currentRow.find('td');
                var $rows = $currentRow.parents('div.mop-grid-main').find('tr');
                var rowIndex = $rows.index($currentRow);
                var cellIndex = $cells.index($currentCell);

                var newRowIndex = rowIndex + step;
                if (newRowIndex < 0 || newRowIndex >= $rows.length)
                    return;

                var $newCell = $rows.eq(newRowIndex).find('td').eq(cellIndex);
                var $newEl = $newCell.find('input');
                if ($newEl.length > 0)
                    $newEl.focus();
                else
                    verticalFocusElement($el, step > 0 ? step + 1 : step - 1);
            };


            me.$('.bine-dv-text-field').keydown(function (e) {
                var key = e.charCode || e.keyCode || 0;

                if (e.ctrlKey)
                    return true;

                var $this = $(this);
                var $thisRow = $this.parent().parent();

                if (key == 37)    // left key
                    $this.focusPrevInputField();
                else if (key == 39) // right key
                    $this.focusNextInputField();
                else if (key == 38) // up key
                    verticalFocusElement($this, -1);
                else if (key == 40) // down key
                    verticalFocusElement($this, 1);
                return key < 37 || key > 40;
            });

            me.$('.bine-dv-right-field').keydown(function (e) {
                var key = e.charCode || e.keyCode || 0;

                if (e.ctrlKey)
                    return true;
                //console.log(key.toString());
                // allow backspace, tab, delete, arrows, numbers and keypad numbers ONLY 
                return (
                                        key == 8 ||
                                        key == 9 ||
                                        key == 46 ||
                                        (key >= 37 && key <= 40) ||
                                        (key >= 48 && key <= 57) ||
                                        (key >= 96 && key <= 105)
                                        || (key == 109 || key == 189)  // FF: 109, IE: 189
                                        || key == 190 || key == 173
                                        || key == 110);
            });

        },

        updateElement: function (elId, value) {
            var me = this;
            var $el = $('#' + elId);
            if ($el.length > 0) {
                if ($el.prop('tagName') == 'INPUT')
                    $el.val(value);
                else
                    $el.html(value);
            }
        },

        renderDataItem: function (dataItem, html) {
            var me = this;
            //var html = [];

            var renderAmount = function (value, format) {
                if (!format)
                    format = '0,000.00';
                if (!value)
                    return '0.00';
                return bine.format(Math.round(value * 100) / 100, format);
            };

            var currentPeriod = FscPeriodLookup2[fin.bud.Context.getFscPeriod()];

            var width = (me.endPeriod - me.startPeriod + 1) * (bine.isIE ? 757 : 750) + 200;
            html.push('<table class="bud-table-2 list-body mop-grid" style="width:' + width + 'px" >');
            if (dataItem.IsCategory || dataItem.IsTotal)
                html.push('<tr class="bine-ctrl bine-dv account-category-data-view" >');
            else
                html.push('<tr class="bine-ctrl bine-dv">');
            for (var i = me.startPeriod; i <= me.endPeriod; i++) {

                var FscPeriod = GetFscPeriod2(me.fscYear, i);

                if (dataItem['WorModified' + i] || dataItem.IsCategory || dataItem.IsTotal || !currentPeriod || FscPeriod.EndDt < currentPeriod.EndDt)
                    html.push('<td class="amount-col" style="width:100px; "><div ' + (dataItem['WorModified' + i] ? 'style="color:#802a2a;" ' : '') + ' id="' + dataItem['FscAccount'] + '_Projection_' + i + '">' + renderAmount(dataItem['Projection' + i]) + '</div></td>');
                else
                    html.push('<td class="amount-col editable-col" style="width:100px; padding:0px;"><input id="' + dataItem['FscAccount'] + '_Projection_' + i + '" class="bine-dv-text-field bine-dv-right-field" type="text" style="width:90px; height:16px;" value="' + renderAmount(dataItem['Projection' + i], '0,000.00') + '" /></td>');

                if (me.showBudget)
                    html.push('<td class="amount-col" style="width:100px; height:20px;">' + renderAmount(dataItem['Budget' + i]) + '</td>');
                if (me.showVariance)
                    html.push('<td id="' + dataItem['FscAccount'] + '_Variance_' + i + '"  class="amount-col" style="width:100px">' + renderAmount(dataItem['Variance' + i]) + '</td>');
                html.push('<td class="amount-col" style="width:100px">' + renderAmount(dataItem['DailyRunRate' + i]) + '</td>');
                if (me.showRunRate)
                    html.push('<td class="amount-col" style="width:100px">' + renderAmount(dataItem['RunRate' + i]) + '</td>');
                html.push('<td class="amount-col" style="width:100px">' + renderAmount(dataItem['Forecast' + i]) + '</td>');

                if (dataItem.IsCategory || dataItem.IsTotal || !currentPeriod || FscPeriod.EndDt < currentPeriod.EndDt)
                    html.push('<td  style="width:150px"><div style="overflow:hidden; width:139px;"><div style="width:500px"><a style="color:#000; " title="' + dataItem['Comment' + i] + '">' + dataItem['Comment' + i] + '</a></div></div></td>');
                else
                    html.push('<td style="width:150px" class="editable-col"><input type="text" id="' + dataItem['FscAccount'] + '_Comment_' + i + '"  style="width:130px; height:16px;"  class="bine-dv-text-field"value="' + dataItem['Comment' + i] + '" /></td>');
            }

            html.push('<td  id="' + dataItem['FscAccount'] + '_Projection_Total" class="boundary amount-col" style="width:100px;" >' + renderAmount(dataItem['ProjectionTotal']) + '</td>');
            html.push('<td  class=" amount-col" style="width:100px;">' + renderAmount(dataItem['BudgetTotal']) + '</td>');

            html.push('</tr>');
            html.push('</table>');
        },

        val: function (data) {
            var me = this;

            if (arguments.length == 0)
                return me._items;

            if (data && me._items != data) {
                me._items = data;
                me.refreshUi();
            }

        }

    });

    return DataGrid;
} ();

    var $templates = $(window.__bt__0bf692a1[0]);

    var TPL_MOP_FILTER = $('#mop-filter', $templates).html();
    var TPL_MOP_COLUMN_SWITH = $('#mop-column-switch', $templates).html();
    var TPL_MOP_FOTTER = $('#mop-footer', $templates).html();

    var TPL_WOR_FILTER = $('#wor-filter', $templates).html();
    var TPL_WOR_COMMENT = $('#wor-comment', $templates).html();

    $templates = null;

    var ComboBox = bine.extend(Ext.form.ComboBox, {
        displayField: 'Description',
        valueField: 'Id',
        mode: 'local',
        forceSelection: false,      // if set true, the tab key cannot work on IE
        triggerAction: 'all',
        selectOnFocus: true,
        editable: false,
        layzeInit: false,
        typeAhead: true,
        minChars: 1
    });

    var MopFilter = bine.extend(bine.DataView, {
        tpl: TPL_MOP_FILTER,
        createFields: function () {
            var dv = this;

            var houseCodeComboBox = new ComboBox({ store: HcmHouseCodeStore, name: 'hcmHouseCode', editable: true, width: 400, listWidth: 400 });
            dv.addField(houseCodeComboBox);

            var houseJobComboBox = new ComboBox({ store: HcmJobStore, name: 'hcmJob', width: 100 });
            dv.addField(houseJobComboBox);

            var fscYearComboBox = new ComboBox({ store: FscYearStore, name: 'fscYear', width: 100 });
            dv.addField(fscYearComboBox);
        },

        onDomReady: function () {
            var dv = this;

            var loadButton = new bine.Button({ text: 'Load Data', width: 90 });
            dv.append(loadButton, 'load-button');

            loadButton.on('click', function () {
                if (dv.isValid())
                    dv.fireEvent('load', dv.val());
            });

            dv.fieldConfig({
                hcmHouseCode: { isValid: function (value) { return value; } },
                hcmJob: { isValid: function (value) { return value; } },
                fscYear: { isValid: function (value) { return value; } }
            });

            dv.on('change', function (name, value) {
                if (name == dv.name || name == 'hcmHouseCode') {
                    var hcmHouseCode = dv.val('hcmHouseCode');
                    if (hcmHouseCode) {
                        dv.mask('Loading...');
                        loadHcmHouseJobs(hcmHouseCode, function (jobs) {
                            if (jobs && jobs.length > 0)
                                dv.val('hcmJob', jobs[0].Id);
                            dv.unmask();
                        });
                        var HcmHouseCode = HcmHouseCodeLookup[hcmHouseCode];        // bine.query(HcmHouseCodes).where(function (i) { return i.Id == hcmHouseCode; }).first();
                        if (HcmHouseCode)
                            fin.bud.Context.setHcmHouseCode(HcmHouseCode.AppUnit, HcmHouseCode.Id, HcmHouseCode.Description, HcmHouseCode.Code, HcmHouseCode.HirNode);
                    }
                }

                if (name == dv.name || name == 'fscYear') {
                    var fscYear = dv.val('fscYear');
                    if (fscYear) {
                        dv.mask('Loading Periods...');
                        loadFscPeriods(fscYear, function (fscPeriods) {
                            dv.fireEvent('fscyearchange', fscYear, fscPeriods);
                            dv.unmask();
                        });
                    }
                }
            });
        }
    });

    var ColumnSwitch = bine.extend(bine.DataView, {
        tpl: TPL_MOP_COLUMN_SWITH,

        createFields: function () {
            var dv = this;
            var fscPeriodStart = new ComboBox({ store: FscPeriodStore, name: 'fscPeriodStart', width: 100 });
            dv.addField(fscPeriodStart);

            var fscPeriodEnd = new ComboBox({ store: FscPeriodStore, name: 'fscPeriodEnd', width: 100 });
            dv.addField(fscPeriodEnd);
        },
        onDomReady: function () {
            var dv = this;
            var applyButton = new bine.Button({ text: 'Refresh', width: 60 });
            dv.append(applyButton, 'apply-button');

            applyButton.on('click', function () {
                dv.fireEvent('apply', dv.val());
            });

            dv.$('#popupButton').click(function (e) {
                e.preventDefault();
                if (!$(this).hasClass('active') && dv.filter) {
                    $(this).addClass('active');
                    var periodNumber = GetCurrentFscPeriod()['Number'];
                    dv.$('#commentLabel').html('Summary Comments for Period ' + periodNumber);
                    dv.$('#popupBox').slideDown('fast', function () {
                        bine.$mask(dv.$('#popupBox'), ('Loading...'));
                        loadWorSummaryComment(dv.filter.hcmHouseCode, dv.filter.hcmJob, dv.filter.fscYear, GetCurrentFscPeriod()['Id'], function (comment) {
                            dv.$('#summaryComment').val(comment);
                            bine.$unmask(dv.$('#popupBox'));
                        });
                    });

                }
            });

            dv.$('#saveButton').click(function (e) {
                e.preventDefault();
                bine.$mask(dv.$('#popupBox'), ('Saving...'));
                saveWorSummaryComment(dv.filter.hcmHouseCode, dv.filter.hcmJob, dv.filter.fscYear, GetCurrentFscPeriod()['Id'], dv.$('#summaryComment').val(), function () {
                    dv.$('#popupBox').slideUp('fast');
                    dv.$('#popupButton').removeClass('active');
                    bine.$unmask(dv.$('#popupBox'));
                });
            });

            dv.$('#cancelButton').click(function (e) {
                e.preventDefault();
                dv.$('#popupBox').slideUp('fast');
                dv.$('#popupButton').removeClass('active');
            });
        }
    });

    var MopFooter = bine.extend(bine.Control, {
        tpl: TPL_MOP_FOTTER,

        onDomReady: function () {
            var me = this;
            loadReportUrls();
            var fscAccount = new ComboBox({ store: FscAccountStore, name: 'fscAccount', lazyInit: false, editable: true, width: 300, listWidth: 400 });
            me.append(fscAccount, 'fscAccount');

            var addAccountButton = new bine.Button({ text: 'Add Account' });
            me.append(addAccountButton, 'addAccountButton');

            addAccountButton.on('click', function () {
                if (fscAccount.getValue())
                    me.fireEvent('addaccount', fscAccount.getValue());
            });

            var saveButton = new bine.Button({ text: 'Save' });
            me.append(saveButton, 'saveButton');
            saveButton.on('click', function () {
                me.fireEvent('save');
            });


            var payrollRegisterButton = new bine.Button({ text: 'Payroll Register Rpt' });
            me.append(payrollRegisterButton, 'payrollRegisterButton');
            payrollRegisterButton.on('click', function () {
                var rptUrl = bine.query(RptReportUrls).where(function (i) { return i.Title == 'Payroll Register'; }).select('Url').first();
                if (rptUrl)
                    window.open(rptUrl);
            });

            var transactionDetailButton = new bine.Button({ text: 'Transaction Details Rpt' });
            me.append(transactionDetailButton, 'transactionDetailButton');

            transactionDetailButton.on('click', function () {
                var rptUrl = bine.query(RptReportUrls).where(function (i) { return i.Title == 'Transaction Details'; }).select('Url').first();
                if (rptUrl)
                    window.open(rptUrl);
            });

            var printMopButton = new bine.Button({ text: 'Print MOP' });
            me.append(printMopButton, 'printMopButton');

            printMopButton.on('click', function () {
                var rptUrl = bine.query(RptReportUrls).where(function (i) { return i.Title == 'MOP'; }).select('Url').first();
                if (rptUrl)
                    window.open(rptUrl);
            });
        }
    });

    //
bud.page.WOR = function () {
    var WorFilter = bine.extend(bine.DataView, {
        tpl: TPL_WOR_FILTER,

        createFields: function () {
            var dv = this;
            var fscPeriod = new ComboBox({ store: FscPeriodStore, name: 'fscPeriod', width: 100 });
            dv.addField(fscPeriod);
        },

        onDomReady: function () {
            var dv = this;

            var backToMopButton = new bine.Button({ text: 'Back to MOP' });
            dv.append(backToMopButton, 'backToMopButton');

            backToMopButton.on('click', function () {
                dv.fireEvent('backtomop');
            });

            dv.$('#popupButton').click(function (e) {
                e.preventDefault();
                if (!$(this).hasClass('active')) {
                    $(this).addClass('active');
                    dv.$('#popupBox').slideDown('slow', function () {
                        var FscPeriod = GetCurrentFscPeriod();
                        dv.$('#commentLabel').html('Summary Comments for Period ' + FscPeriod.Number);

                        bine.$mask(dv.$('#popupBox'), ('Loading...'));
                        loadWorSummaryComment(dv.val('hcmHouseCode'), dv.val('hcmJob'), dv.val('fscYear'), FscPeriod['Id'], function (comment) {
                            dv.$('#summaryComment').val(comment);
                            bine.$unmask(dv.$('#popupBox'));
                        });
                    });

                }
            });

            dv.$('#saveButton').click(function (e) {
                e.preventDefault();
                bine.$mask(dv.$('#popupBox'), ('Saving...'));
                saveWorSummaryComment(dv.val('hcmHouseCode'), dv.val('hcmJob'), dv.val('fscYear'), GetCurrentFscPeriod()['Id'], dv.$('#summaryComment').val(), function () {
                    dv.$('#popupBox').slideUp('slow');
                    dv.$('#popupButton').removeClass('active');
                    bine.$unmask(dv.$('#popupBox'));
                });
            });

            dv.$('#cancelButton').click(function (e) {
                e.preventDefault();
                dv.$('#popupBox').slideUp('slow');
                dv.$('#popupButton').removeClass('active');
            });

            dv.fieldConfig({
                hcmHouseCode: {
                    convertDisplay: function (value) {
                        return HcmHouseCodeLookup[value]['Description'];
                        //return bine.query(HcmHouseCodes).where(function (i) { return i.Id == value; }).select('Description').first();
                    }
                },
                hcmJob: {
                    convertDisplay: function (value) {
                        var hcmHouseCode = HcmHouseCodeLookup[dv.val('hcmHouseCode')];    //bine.query(HcmHouseCodes).where(function (i) { return i.Id == dv.val('hcmHouseCode'); }).first();
                        return bine.query(hcmHouseCode.Jobs).where(function (i) { return i.Id == value; }).select('Description').first();
                    }
                },
                fscYear: {
                    convertDisplay: function (value) {
                        return bine.query(FscYears).where(function (i) { return i.Id == value; }).select('Description').first();
                    }
                }
            });
        }
    });

    var WorCommentView = bine.extend(bine.DataView, {
        tpl: TPL_WOR_COMMENT
    });

    //
var WorDataViewList = function () {
    var htmlBuilder = [];
    htmlBuilder.push('<table class="bud-table-2"><thead class="table-head" style=" border: 1px solid #c6c6c6;">');

    htmlBuilder.push('<tr>');
    //  htmlBuilder.push('<th class="boundary" ><button class="bine-btn bine-btn-txt bine-ctrl gray" style="height:50px;">SearchUpdate Future<br/>Periods w/MOP</button></th>');
    htmlBuilder.push('<th class="boundary" ><div  class="row1-btn"><button id="updaterunrate-button" class="bine-btn bine-btn-txt bine-ctrl " style="height:50px;">Update With<br/>Run Rate</button></div><div style="padding:5px;display:none"><div style="width:13px; height:20px;padding-top:3px;float:left;"><input style="" type="checkbox" name="selectAll" id="SelectAll"/></div><span style="float:left;line-height:18px; height:20px;padding-left:5px;">Select All</span><div style="clear:both;"></div></div></th>');
    htmlBuilder.push('<th class="boundary"  style="text-align:center">Account Code</th>');

    for (var i = 1; i <= 6; i++) {
        htmlBuilder.push(String.format('<th class="boundary mop-week-{0} mop-week-title row-btn" style="text-align:center"><span>Week {0}</span><br/><button class="copy-button copy-button-{0} bine-btn bine-btn-txt bine-ctrl gray" week="{0}">Copy Preposted</button></th>', i));
    }
    htmlBuilder.push('<th class="boundary"  style="text-align:center">MOP Monthly<br/>Operating Report</th>');
    htmlBuilder.push('<th class="boundary"  style="text-align:center;width:100px;">Budget</th>');
    htmlBuilder.push('<th class="boundary"  style="text-align:center; width:100px;">Run Rate</th>');
    htmlBuilder.push('<th class="boundary"  style="text-align:center">Mop to Budget<br/>Variance</th>');
    htmlBuilder.push('<th class="boundary"  style="text-align:center; ">Comments</th>');
    htmlBuilder.push('<th class="boundary"  style="text-align:center">Full Year<br/>Projections</th>');
    htmlBuilder.push('<th class=""  style="text-align:center">Full Year<br/>Budget</th>');

    htmlBuilder.push('</tr>');

    htmlBuilder.push('</thead><tbody id="item-wrapper"  class="list-body"></tbody></table>');

    var TPL_LIST = htmlBuilder.join('');

    htmlBuilder = [];
    htmlBuilder.push('<tr>');
    // htmlBuilder.push('<td class="boundary"><input type="checkbox" /></td>');
    htmlBuilder.push('<td class="boundary"><div style="padding:3px 7px;"><input type="checkbox" name="UpdateRunRate" style="display:none" /></div></td>');
    htmlBuilder.push('<td class="boundary mop-account-column" name="FscAccountDescription" style="white-space:nowrap"></td>');

    for (var i = 1; i <= 6; i++) {
        htmlBuilder.push(String.format('<td  class=" mop-projection boundary mop-week-amount mop-week-{0}"><input type="text"  style="width:100%;" name="Week{0}" /></td>', i));
    }

    htmlBuilder.push(String.format('<td class=" boundary wor-amount-col" name="Projection"></td>', i));
    htmlBuilder.push(String.format('<td class=" boundary wor-amount-col" name="Budget"></td>', i));
    htmlBuilder.push(String.format('<td class=" boundary wor-amount-col" name="RunRate"></td>', i));
    htmlBuilder.push(String.format('<td class=" boundary wor-amount-col" name="Variance"></td>', i));
    htmlBuilder.push(String.format('<td class="mop-comment boundary wor-amount-col" style=""><input type="text"  style="width:100%;" name="Comment" /></td>', i));

    htmlBuilder.push('<td  class="boundary amount-col"  name="ProjectionTotal"></td>');
    htmlBuilder.push('<td  class=" amount-col" name="BudgetTotal"></td>');

    htmlBuilder.push('</tr>');

    var TPL_VIEW = htmlBuilder.join('');

    var amountDisplay = function (value) {
        if (!value)
            return '0.00';
        return bine.format(value, '0,000.00');
    };

    var amountEdit = function (value) {
        if (!value)
            return 0;
        return value;
    };

    var amountConfig = {
        convertDisplay: amountDisplay,
        convertBack: amountEdit,
        convert: function (value) {
            return parseFloat(value);
        }
    }

    var fieldConfig = {};

    for (var i = 1; i <= 6; i++) {
        fieldConfig['Week' + i] = { type: 'number', format: '0,000.00', allowNegative: true }
    }
    fieldConfig['Budget'] = { type: 'number', format: '0,000.00', allowNegative: true }
    fieldConfig['Projection'] = { type: 'number', format: '0,000.00', allowNegative: true }
    fieldConfig['Variance'] = { type: 'number', format: '0,000.00', allowNegative: true }
    fieldConfig['RunRate'] = { type: 'number', format: '0,000.00', allowNegative: true }

    fieldConfig['BudgetTotal'] = { type: 'number', format: '0,000.00' }
    fieldConfig['ProjectionTotal'] = { type: 'number', format: '0,000.00' }
    fieldConfig['UpdateRunRate'] = { type: 'bool' };

    var DataViewList = bine.extend(bine.DataViewList, {
        tpl: TPL_LIST, itemContainerId: 'item-wrapper',
        fscPeriod: null,

        createDataView: function () {
            var me = this;
            return new bine.DataView({ tpl: TPL_VIEW,
                onDomReady: function () {
                    var dv = this;

                    $(".mop-comment").focusin(function () {
                        if (!$(this).parent().hasClass("summary"))
                            $(this).addClass("focus");
                    });
                    $(".mop-comment").focusout(function () {
                        if (!$(this).parent().hasClass("summary"))
                            $(this).removeClass("focus");
                    });

                    $(".mop-projection").focusin(function (e) {
                        if (!$(this).parent().hasClass("summary") && $("input", $(this)).attr('readonly') != "readonly")
                            $(this).addClass("focus");
                    });
                    $(".mop-projection").focusout(function () {
                        if (!$(this).parent().hasClass("summary") && $("input", $(this)).attr('readonly') != "readonly")
                            $(this).removeClass("focus");
                    });

                    me.$("#SelectAll").change(function (e) {
                        if ($(this).attr("checked") == "checked") {
                            dv.val('UpdateRunRate', true);
                        }
                        else {
                            dv.val('UpdateRunRate', false);
                        }
                    });

                    dv.on('change', function (name, value, oldValue) {

                        if (name == dv.name) {
                            if (dv.val('IsCategory') || dv.val('IsTotal')) {
                                dv.$this.addClass('account-category-data-view');
                                dv.$this.addClass('summary');
                                dv.getField('UpdateRunRate').hide();

                                for (var i = 1; i <= 6; i++) {
                                    dv.getField('Week' + i).attr('readonly', 'readonly');
                                }
                                dv.getField('Comment').attr('readonly', 'readonly').attr('disabled', true);
                            }
                            else {
                                var FscPeriod = GetFscPeriod(me.fscPeriod);

                                var today = new Date();
                                today.setHours(0, 0, 0, 0);

                                var currentPeriod = GetCurrentFscPeriodByToday();
                                $.each(FscPeriod.Weeks, function (i, week) {
                                    var weekNumber = i + 1;
                                    if (week.EndDt < today || week.EndDt < currentPeriod.StartDt || week.StartDt > currentPeriod.EndDt) {
                                        //if (weekNumber < fin.bud.Context.getWeekNumber()) {
                                        dv.getField('Week' + weekNumber).attr('readonly', 'readonly').css({ "border-width": "0px" }).addClass('readonly');
                                        $('input[name="Week' + weekNumber + '"]').parent().removeClass("mop-projection");      //.attr('disabled', true);
                                    }
                                    else {
                                        dv.getField('Week' + weekNumber).removeAttr('readonly').removeClass('readonly');            //.attr('disabled', false);
                                    }
                                });
                            }
                        }

                        if (name.startsWith('Week') || name.startsWith('Mop')) {
                            var weekNumber = name.replace('Week', '');

                            var worDetails = me.val();

                            if (dv.val('IsAccount')) {
                                var categoryView = me.getDataView(worDetails.indexOf(bine.query(worDetails).where(function (f) { return f.FscAccount == dv.val('CategoryId'); }).first()));
                                categoryView.val(name, categoryView.val(name) + value - oldValue);
                                //categoryView.val(name, bine.query(worDetails).where(function (i) { return i.CategoryId == categoryView.val('FscAccount'); }).select(name).toArray().sum());
                            }
                            else if (dv.val('IsCategory')) {
                                var totalView = me.getDataView(me.itemCount() - 1);
                                var changedValue = value - oldValue;
                                var FscAccount = FscAccountCategoryLookup[dv.val('FscAccount')];
                                if (!FscAccount.IsNegative)
                                    changedValue = -changedValue;
                                totalView.val(name, totalView.val(name) + changedValue);
                                //totalView.val(name, bine.query(worDetails).where(function (i) { return i.IsCategory; }).select(name).toArray().sum());

                                //                                totalView.val(name, bine.query(worDetails).where(function (i) { return i.IsCategory; }).select(function (i) {

                                //                                    var FscAccount = FscAccountCategoryLookup[i.FscAccount];
                                //                                    return FscAccount.IsNegative ? i[name] : -i[name];

                                //                                }).toArray().sum());
                            }

                            if (name.startsWith('Week')) {
                                var mopValue = 0;
                                for (var i = 0; i <= 6; i++)
                                    mopValue += dv.val('Week' + i) || 0;
                                dv.val('Projection', mopValue);
                            }
                        }
                    });
                }
            }, fieldConfig);
        },

        onDomReady: function () {
            var me = this;

            me.$('.copy-button').click(function () {
                var week = $(this).attr('week');
                me.fireEvent('copyflash', week);
            });

            me.$('#updaterunrate-button').click(function () {
                var FscPeriod = GetFscPeriod(me.fscPeriod);
                var today = new Date();
                today.setHours(0, 0, 0, 0);

                me.each(function (index, dv) {
                    if (dv.val('UpdateRunRate') && dv.val('IsAccount')) {
                        var dailyRunRate = Math.round(dv.val('RunRate') / FscPeriod.Days * 100) / 100;
                        $.each(FscPeriod.Weeks, function (i, week) {
                            // if (week.EndDt >= today) {
                            var weekNumber = i + 1;
                            if (weekNumber >= fin.bud.Context.getWeekNumber())
                                dv.val('Week' + weekNumber, dailyRunRate * week.Days);
                            // }
                        });
                    }
                });
            });
        },

        addFscAccount: function (fscAccount) {
            var me = this;

            var worItems = me.val();

            var exists = bine.query(worItems).where(function (f) { return f.FscAccount == fscAccount; }).first() != null;
            if (exists)
                return;

            var dataItem = createFscAccountWorDataItem(fscAccount);

            var dataItemIndex = worItems.indexOf(bine.query(worItems).where(function (f) { return f.SortIndex < dataItem.SortIndex; }).orderBy('SortIndex', false).first()) + 1;
            if (dataItemIndex < 0)
                dataItemIndex = 0;

            var dv = me.insert(dataItemIndex, dataItem);

            worItems = me.val();
            var categoryItem = bine.query(worItems).where(function (f) { return f.FscAccount == dataItem.CategoryId; }).first();
            if (!categoryItem) {
                categoryItem = createFscAccountCategoryWorDataItem(dataItem.CategoryId);

                var categoryItemIndex = worItems.indexOf(bine.query(worItems).where(function (f) { return f.SortIndex < categoryItem.SortIndex; }).orderBy('SortIndex', false).first()) + 1;
                if (categoryItemIndex < 0)
                    categoryItemIndex = 0;
                me.insert(categoryItemIndex, categoryItem);
            }
        }
    });

    return DataViewList;
} ();

    //

var WorForecasts = [];
var WorDetails = [];

var initWorDataItem = function (dataItem) {
    for (var i = 1; i <= 6; i++) {
        dataItem['Week' + i] = 0;
    }
    dataItem['Budget'] = 0;
    dataItem['Projection'] = 0;
    dataItem['Variance'] = 0;
    dataItem['RunRate'] = 0;
    dataItem['Comment'] = '';
    dataItem['BudgetTotal'] = 0;
    dataItem['ProjectionTotal'] = 0;
    dataItem['UpdateRunRate'] = true;
};

var createFscAccountWorDataItem = function (fscAccount) {
//    var FscAccount = bine.query(FscAccounts).where(function (f) { return f.Id == fscAccount; }).first();
//    var FscAccountCategory = bine.query(FscAccountCategories).where(function (f) { return f.Id == FscAccount.CategoryId; }).first();

    var FscAccount = FscAccountLookup[fscAccount];
    var FscAccountCategory = FscAccountCategoryLookup[FscAccount.CategoryId];

    var dataItem = { FscAccount: fscAccount, FscAccountDescription: FscAccount.Description, IsAccount: true };

    dataItem.CategoryId = FscAccountCategory.Id;
    dataItem.SortIndex = FscAccountCategory.OrderIndex.toString().padLeft('0', 4) + '_' + FscAccount.Code;

    initWorDataItem(dataItem);

    return dataItem;

};

var createFscAccountCategoryWorDataItem = function (fscAccountCategory) {

  //  var FscAccountCategory = bine.query(FscAccountCategories).where(function (f) { return f.Id == fscAccountCategory; }).first();
    var FscAccountCategory = FscAccountCategoryLookup[fscAccountCategory];    

    var dataItem = { FscAccount: FscAccountCategory.Id, FscAccountDescription: FscAccountCategory.Description, IsCategory: true };

    dataItem.SortIndex = FscAccountCategory.OrderIndex.toString().padLeft('0', 4) + '_9999';

    initWorDataItem(dataItem);

    return dataItem;

};

var populateWorDetails = function (periodNumber, specifiedFscAccount) {

    WorDetails = [];

    var mopItems = bine.query(MopDetails).where(function (i) { return i.IsAccount && (!specifiedFscAccount || specifiedFscAccount == i.FscAccount); }).toArray();

    var worItemIndex = {};

    var totalItem = { FscAccount: 99999, FscAccountDescription: 'Total', IsTotal: true };

    totalItem.SortIndex = '9999_9999';
    initWorDataItem(totalItem);
    WorDetails.push(totalItem);

    $.each(mopItems, function (index, mopItem) {

        var fscAccount = mopItem.FscAccount;
        var dataItem = createFscAccountWorDataItem(fscAccount);
        WorDetails.push(dataItem);

        var FscAccount = FscAccountLookup[fscAccount];

        var categoryItem = worItemIndex[dataItem.CategoryId];
        if (!categoryItem) {
            categoryItem = createFscAccountCategoryWorDataItem(dataItem.CategoryId);
            WorDetails.push(categoryItem);
            worItemIndex[dataItem.CategoryId] = categoryItem;
        }

        dataItem.IsAccount = mopItem.IsAccount;
        dataItem.IsCategory = mopItem.IsCategory;

        dataItem['Budget'] = mopItem['Budget' + periodNumber];
        dataItem['Comment'] = mopItem['Comment' + periodNumber];
        categoryItem['Budget'] += mopItem['Budget' + periodNumber];
        totalItem['Budget'] += FscAccount.IsNegative ? mopItem['Budget' + periodNumber] : -mopItem['Budget' + periodNumber];


        dataItem['RunRate'] = mopItem['RunRate' + periodNumber];
        categoryItem['RunRate'] += mopItem['RunRate' + periodNumber];
        totalItem['RunRate'] += FscAccount.IsNegative ? mopItem['RunRate' + periodNumber] : -mopItem['RunRate' + periodNumber];

        dataItem['BudgetTotal'] = mopItem['BudgetTotal'];
        dataItem['ProjectionTotal'] = mopItem['ProjectionTotal'];

        categoryItem['BudgetTotal'] += mopItem['BudgetTotal'];
        categoryItem['ProjectionTotal'] += mopItem['ProjectionTotal'];

        totalItem['BudgetTotal'] += FscAccount.IsNegative ? mopItem['BudgetTotal'] : -mopItem['BudgetTotal'];
        totalItem['ProjectionTotal'] += FscAccount.IsNegative ? mopItem['ProjectionTotal'] : -mopItem['ProjectionTotal'];

        var forecast = bine.query(WorForecasts).where(function (b) { return b.FscAccount == fscAccount; }).first();
        if (forecast) {

            for (var i = 1; i <= 6; i++) {
                dataItem['Week' + i] += forecast['Week' + i] || 0;
                categoryItem['Week' + i] += forecast['Week' + i] || 0;
                totalItem['Week' + i] += FscAccount.IsNegative ? (forecast['Week' + i] || 0) : -(forecast['Week' + i] || 0);
            }
            dataItem['Modified'] = forecast['Modified'];

        }

        if (dataItem['Modified']) {
            var weekTotal = 0;
            for (var i = 1; i <= 6; i++)
                weekTotal += dataItem['Week' + i] || 0;

            dataItem['Projection'] = weekTotal;
            categoryItem['Projection'] += weekTotal;
            totalItem['Projection'] += FscAccount.IsNegative ? weekTotal : -weekTotal;

            mopItem['Projection' + periodNumber] = weekTotal;

        }
        else {
            dataItem['Projection'] = mopItem['Projection' + periodNumber];
            categoryItem['Projection'] += mopItem['Projection' + periodNumber];
            totalItem['Projection'] += FscAccount.IsNegative ? mopItem['Projection' + periodNumber] : -mopItem['Projection' + periodNumber];
        }

    });

    //    var categories = bine.query(WorDetails).select('CategoryId').toArray().distinct();

    //    $.each(categories, function (index, category) {
    //        var categoryItem = createFscAccountCategoryWorDataItem(category);

    //        for (var i = 1; i <= 6; i++) {
    //            categoryItem['Week' + i] = bine.query(WorDetails).where(function (d) { return d.CategoryId == category; }).select('Week' + i).toArray().sum();
    //        }
    //        categoryItem['Projection'] = bine.query(WorDetails).where(function (d) { return d.CategoryId == category; }).select('Projection').toArray().sum();
    //        categoryItem['Budget'] = bine.query(WorDetails).where(function (d) { return d.CategoryId == category; }).select('Budget').toArray().sum();
    //        categoryItem['Variance'] = bine.query(WorDetails).where(function (d) { return d.CategoryId == category; }).select('Variance').toArray().sum();

    //        categoryItem['BudgetTotal'] = bine.query(WorDetails).where(function (d) { return d.CategoryId == category; }).select('BudgetTotal').toArray().sum();
    //        categoryItem['ProjectionTotal'] = bine.query(WorDetails).where(function (d) { return d.CategoryId == category; }).select('ProjectionTotal').toArray().sum();

    //        WorDetails.push(categoryItem);
    //    });

    //    var totalItem = { FscAccount: 99999, FscAccountDescription: 'Total', IsTotal: true };

    //    totalItem.SortIndex = '9999_9999';
    //    WorDetails.push(totalItem);

    //    var calculateTotal = function (field) {
    //        return bine.query(WorDetails).where(function (d) { return d.IsCategory; }).select(function (d) {
    //            var FscAccount = FscAccountCategoryLookup[d.FscAccount];
    //            return FscAccount.IsNegative ? d[field] : -d[field];
    //        }).toArray().sum();
    //    }

    //    for (var i = 1; i <= 6; i++) {
    //        totalItem['Week' + i] = calculateTotal('Week' + i);        //bine.query(WorDetails).where(function (d) { return d.IsCategory; }).select('Week' + i).toArray().sum();
    //    }

    //    totalItem['Projection'] = calculateTotal('Projection');  ///bine.query(WorDetails).where(function (d) { return d.IsCategory; }).select('Projection').toArray().sum();
    //    totalItem['Budget'] = calculateTotal('Budget');  //bine.query(WorDetails).where(function (d) { return d.IsCategory; }).select('Budget').toArray().sum();
    //    totalItem['Variance'] = calculateTotal('Variance');  // bine.query(WorDetails).where(function (d) { return d.IsCategory; }).select('Variance').toArray().sum();

    //    totalItem['BudgetTotal'] = calculateTotal('BudgetTotal');  // bine.query(WorDetails).where(function (d) { return d.IsCategory; }).select('BudgetTotal').toArray().sum();
    //    totalItem['ProjectionTotal'] = calculateTotal('ProjectionTotal');  // bine.query(WorDetails).where(function (d) { return d.IsCategory; }).select('ProjectionTotal').toArray().sum();

    WorDetails = bine.query(WorDetails).orderBy('SortIndex').toArray();

};


var loadWorData = function (hcmHouseCode, hcmJob, fscYear, fscPeriod, callback) {

    var criteriaXml = String.format('<criteria>hcmHouseCode:{0},fscYear:{2},hcmJob:{1},storeId:budBudgetWORForecasts,fscPeriod:{3},userId:[user],</criteria>',
                hcmHouseCode, hcmJob, fscYear, fscPeriod);

    fin.bud.budRequest(criteriaXml, function (data) {
        WorForecasts = [];

        //<item id="3879529" hcmHouseCode="36" hcmJob="1" fscYear="3" fscAccount="169" fscPeriod="27" week1="16215.91" week2="16215.91" 
        //week3="16215.91" week4="16215.91" crtdAt="6/15/2011 3:31:53 PM" crtdBy="COMPASS-USA\kaym01"></item>

        $('item', $(data)).each(function (index, item) {
            var $item = $(item);
            var dataItem = { FscAccount: $item.attr('fscAccount') };
            for (var i = 1; i <= 6; i++) {
                var periodField = 'Week' + i;
                dataItem[periodField] = parseFloat($item.attr('week' + i));
                if (isNaN(dataItem[periodField]))
                    dataItem[periodField] = 0;

            }
            dataItem.Modified = $item.attr('modified') == "1";
            WorForecasts.push(dataItem);
        });

        callback(WorForecasts);

    });
};

var loadWorDetails = function (hcmHouseCode, hcmJob, fscYear, fscPeriod, fscAccount, callback) {

    loadWorData(hcmHouseCode, hcmJob, fscYear, fscPeriod, function () {
        var FscYear = bine.query(FscYears).where(function (y) { return y.Id == fscYear; }).first();
        var FscPeriod = bine.query(FscYear.Periods).where(function (p) { return p.Id == fscPeriod; }).first();

        populateWorDetails(FscPeriod.Number);

        var result = WorDetails;

        if (fscAccount) {
            var item = bine.query(WorDetails).where(function (i) { return i.FscAccount == fscAccount; }).first();
            var categoryItem = bine.query(WorDetails).where(function (f) { return f.FscAccount == item.CategoryId; }).first();
            var totalItem = bine.query(WorDetails).where(function (f) { return f.FscAccount == 99999; }).first();
            result = [item, categoryItem, totalItem];
        }

        callback(result);
    });

};


var loadWorForecastComment = function (hcmHouseCode, hcmJob, fscYear, fscPeriod, callback) {

    var criteriaXml = String.format('<criteria>hcmHouseCode:{0},fscYear:{2},hcmJob:{1},storeId:budBudgetWORForecastComments,fscPeriod:{3},userId:[user],</criteria>',
                hcmHouseCode, hcmJob, fscYear, fscPeriod);

    fin.bud.budRequest(criteriaXml, function (data) {
        var item = $('item', $(data)).first();
        if (item)
            callback(item.attr('comment'));
    });

};

var copyFlashData = function (hcmHouseCode, hcmJob, fscYear, fscPeriod, weekNumber, callback) {
    var xml = String.format('<transaction id="1"><budWorCopyFlashData hcmHouseCode="{0}" hcmJob="{1}" fscYear="{2}" fscPeriod="{3}" week="{4}"/></transaction>',
                hcmHouseCode, hcmJob, fscYear, fscPeriod, weekNumber);

    fin.bud.budSubmit(xml, callback);
};

var submitWorItems = function (changes, commentXml, callback) {
    var xml = ['<transaction id="1">\r\n'];

    $.each(changes, function (index, item) {

        xml.push('<budBudgetWORForecast ');
        xml.push(String.format(' hcmHouseCode="{0}"', item.HcmHouseCode));
        xml.push(String.format(' hcmJob="{0}"', item.HcmJob));
        xml.push(String.format(' fscYear="{0}"', item.FscYear));
        xml.push(String.format(' fscAccount="{0}"', item.FscAccount));
        xml.push(String.format(' fscPeriod="{0}"', item.FscPeriod));

        for (var i = 1; i <= 6; i++) {
            xml.push(String.format(' week{1}="{0}"', item['Week' + i] || 0, i));
        }
        xml.push(String.format(' comment="{0}"', htmlEncode(item.Comment)));
        xml.push(String.format(' periodNumber="{0}"', FscPeriodLookup2[item.FscPeriod].Number));

        xml.push(' />\r\n');
    });

    //xml.push(commentXml);

    xml.push('</transaction>');

    var innerCallback = function () {

        if (changes && changes.length > 0) {
            var mopItem = bine.query(MopDetails).where(function (i) { return changes[0].FscAccount == i.FscAccount; }).first();
            mopItem['Comment' + FscPeriodLookup2[changes[0].FscPeriod].Number] = changes[0]['Comment'];
        }
        if (callback)
            callback();

    };

    fin.bud.budSubmit(xml.join(''), innerCallback);
};



    var WOR = bine.extend(bine.Control, {
        tpl: window.__bt__0bf692a1[3],

        hcmHouseCode: null,
        hcmJob: null,
        fscYear: null,
        fscPeriod: null,
        fscAccount: null,

        onDomReady: function () {
            var me = this;

            var resetListHeight = function () {
                var winHeight = $(window).height();
                // me.$('#mop-list-wrapper').css('height', winHeight - me.$('#mop-top').outerHeight() - 60);
            }

            me.onInit(function () {
                me.createControls();
                resetListHeight();
            });
        },

        onInit: function (callback) {
            callback();
        },

        saveChanges: function () {
            var me = this;

            var changes = bine.query(me.worList.val()).clean().where(function (i) { return bine.ObjectStatus.isModified(i) && i.IsAccount; }).toArray();

            $.each(changes, function (index, item) {
                bine.apply(item, { HcmHouseCode: me.hcmHouseCode, HcmJob: me.hcmJob,
                    FscYear: me.fscYear, FscPeriod: me.fscPeriod
                });
            });

            var xml = [];
            xml.push('<budBudgetWORForecastComment ');
            xml.push(String.format(' hcmHouseCode="{0}"', me.hcmHouseCode));
            xml.push(String.format(' hcmJob="{0}"', me.hcmJob));
            xml.push(String.format(' fscYear="{0}"', me.fscYear));
            xml.push(String.format(' fscPeriod="{0}"', me.fscPeriod));
            // xml.push(String.format(' comment="{0}"', me.commentView.$('#Comment').val()));
            xml.push(' />\r\n');


            // console.log(changes);
            me.mask('Saving...');
            submitWorItems(changes, xml.join(''), function () {
                me.unmask();
                $.each(changes, function (index, item) {
                    me.fireEvent('mopreadonly', item.FscAccount, item.Projection);
                });
                me.loadWorDetails();
            });
        },

        createControls: function () {
            var me = this;

            me.filter = new WorFilter();
            me.append(me.filter, 'wor-filter');

            me.footer = new MopFooter();
            me.append(me.footer, 'mop-footer');

            me.footer.$('#add-account-warpper').hide();

            me.footer.on('addaccount', function (fscAccount) {
                me.worList.addFscAccount(fscAccount);
            });

            me.footer.on('save', function () {
                me.saveChanges();
            });

            me.worList = new WorDataViewList({ fscPeriod: me.fscPeriod });
            me.append(me.worList, 'wor-list');

            me.worList.on('add', function (name) {
                me.refreshWorListLayout();
            });

            me.worList.on('copyflash', function (week) {
                me.mask('Loading...');
                copyFlashData(me.hcmHouseCode, me.hcmJob, me.fscYear, me.fscPeriod, week, function () {
                    me.unmask();
                    me.loadWorDetails();
                });
            });

            me.filter.on('change', function (name, value) {
                if (name == 'fscPeriod') {
                    me.fscPeriod = value;
                    me.worList.fscPeriod = value;
                    me.loadWorDetails();
                }
            });

            //            me.commentView = new WorCommentView();
            //            me.append(me.commentView, 'wor-comment');

            me.filter.val({ hcmHouseCode: me.hcmHouseCode, hcmJob: me.hcmJob, fscYear: me.fscYear, fscPeriod: me.fscPeriod });

            me.filter.on('backtomop', function () {
                me.dispose();
            });

            me.loadWorDetails();
        },

        refreshWorListLayout: function () {
            var me = this;
            var FscPeriod = GetFscPeriod(me.fscPeriod);

            var today = new Date();
            today.setHours(0, 0, 0, 0);
            $.each(FscPeriod.Weeks, function (index, week) {
                var weekIndex = index + 1;
                me.worList.$('.mop-week-title.mop-week-' + weekIndex + ' span').html(String.format('Week {0}<br/>{1} ({2} Day{3})', weekIndex, bine.format(week.StartDt, 'MMM dd'), week.Days, (week.Days > 1 ? 's' : '')));
                if (today <= week.StartDt || today <= week.EndDt)
                    me.worList.$('.copy-button-' + weekIndex).show();
                else
                    me.worList.$('.copy-button-' + weekIndex).hide();
            });

            me.$('.mop-week-5').css('display', FscPeriod.Weeks.length > 4 ? 'table-cell' : 'none');
            me.$('.mop-week-6').css('display', FscPeriod.Weeks.length > 5 ? 'table-cell' : 'none');
        },
        loadWorDetails: function () {
            var me = this;

            me.mask('Loading...');

            //            loadWorForecastComment(me.hcmHouseCode, me.hcmJob, me.fscYear, me.fscPeriod, function (comment) {
            //                me.commentView.$('#Comment').val(comment);
            //            });

            loadWorDetails(me.hcmHouseCode, me.hcmJob, me.fscYear, me.fscPeriod, me.fscAccount, function (worDetails) {
                var worItem = bine.query(worDetails).where(function (i) { return i.IsAccount; }).first();

                if (worItem && worItem.Modified) {
                    me.fireEvent('mopreadonly', worItem.FscAccount, worItem.Projection);
                }

                me.worList.val(worDetails);
                me.refreshWorListLayout();

                me.unmask();
            });
        }
    });

    return WOR;
} ();

    bud.page.MOP = bine.extend(bine.Control, {
        tpl: window.__bt__0bf692a1[1],

        onDomReady: function () {
            var me = this;

            var resetListHeight = function () {
                var winHeight = $(window).height();
                //console.log(winHeight, me.$('#mop-top').outerHeight(), me.$('#mop-footer').outerHeight());
                me.mopList.$('#mop-list-wrapper').css('height', winHeight - me.$('#mop-top').outerHeight() - 185);
            }

            me.$('#mop-grid-wrapper').scroll(function () {
                me.refreshScrolls();
            });

            $(window).resize(function () {
                me.resizeUi();
            });

            me.onInit(function () {
                me.createControls();
                resetListHeight();

                me.resizeUi();
            });
        },

        refreshScrolls: function () {
            var me = this;
            var gridId = me.id('mop-grid-wrapper');

            if (!document.getElementById(gridId))
                return;

            var scrollLeft = document.getElementById(gridId).scrollLeft;
            var scrollTop = document.getElementById(gridId).scrollTop;
            document.getElementById(me.id('mop-grid-header-wrapper')).scrollLeft = scrollLeft;
            document.getElementById(me.id('mop-controller-wrapper')).scrollTop = scrollTop;
        },

        ensureFooterCreated: function () {
            var me = this;
            me.$('#mop-footer').show();
            if (me.footer)
                return;
            me.footer = new MopFooter();
            me.append(me.footer, 'mop-footer');
            me.footer.on('addaccount', function (fscAccount) {
                me.addFscAccount(fscAccount);

            });

            me.footer.on('save', function () {
                me.saveChanges();
            });
        },

        createControls: function () {
            var me = this;

            me.filter = new MopFilter();
            me.append(me.filter, 'filter-wrapper');

            me.columnSwitch = new ColumnSwitch();
            me.append(me.columnSwitch, 'column-swith');

            me.mopList = new MopDataGrid();
            me.append(me.mopList, 'mop-grid');
            me.initMopDataGrid();

            me.controllerheader = new MopDataControllerHeader();
            me.append(me.controllerheader, 'controller-header');

            me.controller = new MopDataController();
            me.append(me.controller, 'mop-controller');
            me.initMopDataController();

            me.gridheader = new MopDataGridHeader();
            me.append(me.gridheader, 'grid-header');

            me.initMopDataControllerHeader();

            var showWor = function (fscPeriod, fscAccount) {
                var wor = new bud.page.WOR({ hcmHouseCode: me.filter.val('hcmHouseCode'), hcmJob: me.filter.val('hcmJob'), fscYear: me.filter.val('fscYear'),
                    fscPeriod: fscPeriod, fscAccount: fscAccount
                });
                me.$container.hide();
                wor.appendTo(document.body);

                wor.on('mopreadonly', function (fscAccount, mop) {
                    var mopItem = bine.query(me.mopData).where(function (i) { return i.FscAccount == fscAccount; }).first();
                    if (mopItem) {
                        var currentFscPeriod = GetCurrentFscPeriod();

                        mopItem.WorModified = true;
                        mopItem['WorModified' + currentFscPeriod['Number']] = true;
                        me.projectionUpdated(mopItem.FscAccount, currentFscPeriod['Number'], mop);


                        me.controller.refreshUi();
                        me.mopList.refreshUi();
                        me.refreshScrolls();
                        //                        mopItem.refresh();
                        //                        mopItem.fireEvent('change', 'Projection' + currentFscPeriod['Number'], mop, 0, mopItem);
                    }
                });

                wor.on('remove', function () {
                    me.$container.show();
                });
            };

            me.controller.on('showaccountwor', function (fscAccount) {
                if (me.currentPeriodAvailable)
                    showWor(GetCurrentFscPeriod()['Id'], fscAccount);
            });

            me.filter.on('fscyearchange', function (fscYear, fscPeriods) {

                me.columnSwitch.fscPeriods = fscPeriods;
                // var currentPeriod = bine.query(fscPeriods).where(function (p) { return p.StartDt <= today && p.EndDt >= today; }).first();
                var currentPeriod = FscPeriodLookup2[fin.bud.Context.getFscPeriod()];            ///bine.query(me.columnSwitch.fscPeriods).where(function (p) { return p.Id == fin.bud.Context.getFscPeriod(); }).first();

                if (currentPeriod) {
                    me.columnSwitch.val('fscPeriodStart', currentPeriod.Id);
                    me.columnSwitch.val('fscPeriodEnd', currentPeriod.Id);
                }
                else {
                    var firstPeriod = bine.query(fscPeriods).orderBy('Number').first();
                    var lastPeriod = bine.query(fscPeriods).orderBy('Number', false).first();
                    me.columnSwitch.val('fscPeriodStart', firstPeriod.Id);
                    me.columnSwitch.val('fscPeriodEnd', lastPeriod.Id);
                }

            });

            me.filter.on('change', function () {

                me.$('#mop-footer').hide();
                me.$('#mop-wrapper').hide();
            });


            me.columnSwitch.on('apply', function (name) {
                me.refreshListLayout();
                me.controller.refreshUi();
                me.mopList.refreshUi();
                me.refreshScrolls();

                me.resizeUi();
            });


            me.columnSwitch.val({ Variance: true, Budget: true, RunRate: true });



            me.filter.on('load', function (filter) {
                me.mask('Loading...');

                isBudgetStarted(filter.hcmHouseCode, filter.hcmJob, filter.fscYear, function (started) {
                    if (started)
                        me.loadMopDetails();
                    else {
                        alert('Budget does not exist.');
                    }
                    me.unmask();
                });
            });

            var hcmHouseCode = fin.bud.Context.getHcmHouseCode();

            if (!hcmHouseCode)
                hcmHouseCode = HcmHouseCodes[0].Id;

            me.filter.val({ hcmHouseCode: hcmHouseCode, fscYear: fin.bud.Context.getFscYear() });
        },

        loadMopDetails: function () {
            var me = this;
            var filter = me.filter.val();
            me.columnSwitch.filter = filter;
            me.mask('Loading...');
            loadMopPeriodItems(filter.hcmHouseCode, filter.hcmJob, filter.fscYear, function (mopDetails) {
                me.dataLoaded(mopDetails);
                me.unmask();
            });
            //            me.dataLoaded(test_data);
        },

        initMopDataControllerHeader: function () {
            var me = this;

            me.controllerheader.on('checkfuture', function (checked) {
                if (!me.mopData)
                    return;
                $.each(me.mopData, function (index, item) {
                    if (item.IsAccount)
                        item.UpdateFuture = checked;
                });
                if (me.controller)
                    me.controller.refreshUi();
            });

            me.controllerheader.on('checkrunrate', function (checked) {
                if (!me.mopData)
                    return;

                $.each(me.mopData, function (index, item) {
                    if (item.IsAccount)
                        item.UpdateRunRate = checked;
                });
                if (me.controller)
                    me.controller.refreshUi();
            });

            me.controllerheader.on('updatefuture', function () {
                if (!me.mopData)
                    return;
                var periodIndex = me.mopList.periodStart;         //GetCurrentFscPeriod()['Number'];

                $.each(me.mopData, function (index, item) {
                    if (item.UpdateFuture) {
                        for (var i = periodIndex + 1; i <= 14; i++) {
                            // item['Projection' + i] = item['Projection' + periodIndex];
                            me.projectionUpdated(item.FscAccount, i, item['Projection' + periodIndex]);
                        }
                    }
                });
                if (me.mopList)
                    me.mopList.refreshUi();
            });
            me.controllerheader.on('updaterunrate', function () {
                if (!me.mopData)
                    return;
                var periodIndex = GetCurrentFscPeriod()['Number'];
                $.each(me.mopData, function (index, item) {
                    if (item.UpdateRunRate)
                    //item['Projection' + periodIndex] = item['RunRate' + periodIndex];
                        me.projectionUpdated(item.FscAccount, periodIndex, item['RunRate' + periodIndex]);
                });

                if (me.mopList)
                    me.mopList.refreshUi();
            });

        },

        initMopDataController: function () {
            var me = this;

            me.controller.on('change', function (field, value) {
                var fieldSegment = field.split('_');
                var accountItem = bine.query(me.mopData).where(function (i) { return i.FscAccount == fieldSegment[1]; }).first();
                accountItem[fieldSegment[0]] = value;
            });

        },

        projectionUpdated: function (fscAccount, period, newValue) {
            var me = this;
            var accountItem = bine.query(me.mopData).where(function (i) { return i.FscAccount == fscAccount; }).first();
            var i = period;
            var categoryItem = bine.query(me.mopData).where(function (i) { return i.FscAccount == accountItem['CategoryId']; }).first();
            var totalItem = bine.query(me.mopData).where(function (i) { return i.FscAccount == 99999; }).first();

            var oldValue = accountItem['Projection' + period];
            var variance = newValue - oldValue;

            var FscAccount = FscAccountLookup[accountItem.FscAccount];

            accountItem['Projection' + i] = accountItem['Projection' + i] + variance;
            accountItem['ProjectionTotal'] = accountItem['ProjectionTotal'] + variance;
            accountItem['Variance' + i] = accountItem['Variance' + i] + variance;
            accountItem._isModified = true;

            if (categoryItem) {
                categoryItem['Projection' + i] = categoryItem['Projection' + i] + variance;
                categoryItem['Variance' + i] = categoryItem['Variance' + i] + variance;
                categoryItem['ProjectionTotal'] = categoryItem['ProjectionTotal'] + variance;
            }

            if (totalItem) {
                totalItem['Projection' + i] = totalItem['Projection' + i] + (FscAccount && FscAccount.IsNegative ? variance : -variance);
                totalItem['Variance' + i] = totalItem['Variance' + i] + (FscAccount && FscAccount.IsNegative ? variance : -variance);
                totalItem['ProjectionTotal'] = totalItem['ProjectionTotal'] + (FscAccount && FscAccount.IsNegative ? variance : -variance);
            }

            me.mopList.updateElement(String.format('{0}_Projection_{1}', accountItem.FscAccount, i), bine.format(accountItem['Projection' + i], '0,000.00'));
            me.mopList.updateElement(String.format('{0}_Variance_{1}', accountItem.FscAccount, i), bine.format(accountItem['Variance' + i], '0,000.00'));
            me.mopList.updateElement(String.format('{0}_Projection_Total', accountItem.FscAccount), bine.format(accountItem.ProjectionTotal, '0,000.00'));


            me.mopList.updateElement(String.format('{0}_Projection_{1}', categoryItem.FscAccount, i), bine.format(categoryItem['Projection' + i], '0,000.00'));
            me.mopList.updateElement(String.format('{0}_Variance_{1}', categoryItem.FscAccount, i), bine.format(categoryItem['Variance' + i], '0,000.00'));
            me.mopList.updateElement(String.format('{0}_Projection_Total', categoryItem.FscAccount), bine.format(categoryItem.ProjectionTotal, '0,000.00'));

            me.mopList.updateElement(String.format('{0}_Projection_{1}', totalItem.FscAccount, i), bine.format(totalItem['Projection' + i], '0,000.00'));
            me.mopList.updateElement(String.format('{0}_Variance_{1}', totalItem.FscAccount, i), bine.format(totalItem['Variance' + i], '0,000.00'));
            me.mopList.updateElement(String.format('{0}_Projection_Total', totalItem.FscAccount), bine.format(totalItem.ProjectionTotal, '0,000.00'));

        },

        initMopDataGrid: function () {
            var me = this;

            me.mopList.on('change', function (field, value) {

                var fieldSegment = field.split('_');
                var i = fieldSegment[2];
                var accountItem = bine.query(me.mopData).where(function (i) { return i.FscAccount == fieldSegment[0]; }).first();
                if (fieldSegment[1] == 'Comment') {
                    accountItem['Comment' + i] = value;
                    accountItem._isModified = true;

                }
                else if (fieldSegment[1] == 'Projection') {
                    me.projectionUpdated(fieldSegment[0], i, value);
                    return;
                    var categoryItem = bine.query(me.mopData).where(function (i) { return i.FscAccount == accountItem['CategoryId']; }).first();
                    var totalItem = bine.query(me.mopData).where(function (i) { return i.FscAccount == 99999; }).first();
                    console.log(accountItem, categoryItem, totalItem);
                    var oldValue = accountItem['Projection' + fieldSegment[2]];
                    var variance = value - oldValue;

                    accountItem['Projection' + i] = accountItem['Projection' + i] + variance;
                    accountItem['ProjectionTotal'] = accountItem['ProjectionTotal'] + variance;

                    categoryItem['Projection' + i] = categoryItem['Projection' + i] + variance;
                    categoryItem['ProjectionTotal'] = categoryItem['ProjectionTotal'] + variance;

                    totalItem['Projection' + i] = totalItem['Projection' + i] + variance;
                    totalItem['ProjectionTotal'] = totalItem['ProjectionTotal'] + variance;

                    me.mopList.updateElement(String.format('{0}_Projection_{1}', accountItem.FscAccount, i), bine.format(accountItem['Projection' + i], '0,000.00'));
                    me.mopList.updateElement(String.format('{0}_Projection_Total', accountItem.FscAccount), bine.format(accountItem.ProjectionTotal, '0,000.00'));

                    me.mopList.updateElement(String.format('{0}_Projection_{1}', categoryItem.FscAccount, i), bine.format(categoryItem['Projection' + i], '0,000.00'));
                    me.mopList.updateElement(String.format('{0}_Projection_Total', categoryItem.FscAccount), bine.format(categoryItem.ProjectionTotal, '0,000.00'));

                    me.mopList.updateElement(String.format('{0}_Projection_{1}', totalItem.FscAccount, i), bine.format(totalItem['Projection' + i], '0,000.00'));
                    me.mopList.updateElement(String.format('{0}_Projection_Total', totalItem.FscAccount), bine.format(totalItem.ProjectionTotal, '0,000.00'));

                }

            });

        },

        dataLoaded: function (data) {
            var me = this;
            me.mopData = data;
            me.$('#mop-wrapper').show();
            me.mopList.fscYear = me.filter.val('fscYear');
            me.refreshListLayout();

            me.mopList.val(data);
            me.controller.val(data);

            me.resizeUi();

            me.ensureFooterCreated();
        },

        saveChanges: function () {
            var me = this;
            var filter = me.filter.val();
            var changes = bine.query(me.mopData).where(function (i) { return i._isModified && i.IsAccount; }).toArray();

            $.each(changes, function (index, item) {
                bine.apply(item, { HcmHouseCode: filter.hcmHouseCode, HcmJob: filter.hcmJob,
                    FscYear: filter.fscYear
                });
            });

            //console.log(changes);
            me.mask('Saving...');
            submitMopItems(changes, function () {
                me.unmask();
                //me.loadMopDetails();
            });
        },

        resizeUi: function () {
            var me = this;

            var controllerWidth = me.$('.mop-controller').width();
            var winWidth = $(window).width();
            var winHeight = $(window).height();

            // me.$('#mop-list').css('width', $(window).width() - me.mopList.$('#mop-controller-list').width() - 10);
            me.$('.mop-controller').css('width', me.controllerheader.$this.innerWidth());

            me.$('#mop-grid-wrapper').css('width', window - controllerWidth - 10);

            me.$('#mop-grid-header-wrapper').css('width', window - controllerWidth - 30);

            me.$('#mop-grid-wrapper').css('height', winHeight - 223);

            me.$('#mop-controller-wrapper').css('height', winHeight - 243);

            me.$('#mop-grid').css('width', 12000);
            me.$('#mop-grid').css('width', me.mopList.$this.children(":first").children(":first").width() + 30);


        },

        addFscAccount: function (fscAccount) {
            var me = this;

            var mopDetails = me.mopData;

            var exists = bine.query(mopDetails).where(function (f) { return f.FscAccount == fscAccount; }).first() != null;
            if (exists)
                return;

            var getPriorIndex = function (sortIndex) {
                for (var i = 0; i < mopDetails.length; i++) {
                    if (mopDetails[i].SortIndex > sortIndex)
                        return i;
                }
                return mopDetails.length;
            };

            var dataItem = createFscAccountDataItem(fscAccount);

            var dataItemIndex = getPriorIndex(dataItem.SortIndex);

            mopDetails.insertAt(dataItem, dataItemIndex);

            var categoryItem = bine.query(mopDetails).where(function (f) { return f.FscAccount == dataItem.CategoryId; }).first();
            if (!categoryItem) {
                categoryItem = createFscAccountCategoryDataItem(dataItem.CategoryId);
                var categoryItemIndex = getPriorIndex(categoryItem.SortIndex);

                mopDetails.insertAt(categoryItem, categoryItemIndex);
            }

            me.mopData = mopDetails;
            me.mopList.refreshUi();
            me.controller.refreshUi();
            me.refreshScrolls();
        },

        refreshListLayout: function () {
            var me = this;
            var periodStart = 1;
            var periodEnd = 14;

            var fscPeriodStart = me.columnSwitch.val('fscPeriodStart');
            var fscPeriodEnd = me.columnSwitch.val('fscPeriodEnd');

            var periodStartDt;
            var periodEndDt;

            if (fscPeriodStart) {
                var fscPeriod = bine.query(me.columnSwitch.fscPeriods).where(function (p) { return p.Id == fscPeriodStart; }).first();
                if (fscPeriod) {
                    periodStart = fscPeriod.Number;
                    periodStartDt = fscPeriod.StartDt;
                }
            }
            if (fscPeriodEnd) {
                var fscPeriod = bine.query(me.columnSwitch.fscPeriods).where(function (p) { return p.Id == fscPeriodEnd; }).first();
                if (fscPeriod) {
                    periodEnd = fscPeriod.Number;
                    periodEndDt = fscPeriod.EndDt;
                }
            }

            me.mopList.showBudget = me.columnSwitch.val('Budget');
            me.mopList.showVariance = me.columnSwitch.val('Variance');
            me.mopList.showRunRate = me.columnSwitch.val('RunRate');

            me.gridheader.showBudget = me.columnSwitch.val('Budget');
            me.gridheader.showVariance = me.columnSwitch.val('Variance');
            me.gridheader.showRunRate = me.columnSwitch.val('RunRate');


            var currentPeriod = FscPeriodLookup2[fin.bud.Context.getFscPeriod()];

            var currentPeriodAvailable = currentPeriod && periodStartDt && periodEndDt && periodStartDt <= currentPeriod.StartDt && periodEndDt >= currentPeriod.EndDt;
            me.currentPeriodAvailable = currentPeriodAvailable;
            me.mopList.currentPeriodAvailable = me.currentPeriodAvailable;
            me.controller.currentPeriodAvailable = me.currentPeriodAvailable;


            var isCurrentOrFuturePeriod = currentPeriod && periodEndDt && periodEndDt >= currentPeriod.EndDt;
            me.$('.mop-updatefuture').css('display', isCurrentOrFuturePeriod ? 'table-cell' : 'none');
            me.$('.mop-updaterunrate').css('display', isCurrentOrFuturePeriod ? 'table-cell' : 'none');

            me.mopList.periodStart = periodStart;
            me.mopList.setPeriodRange(periodStart, periodEnd);
            me.gridheader.setPeriodRange(periodStart, periodEnd);

        },

        onInit: function (callback) {
            var me = this;

            var dataLoadedCount = 0;
            var innerCallback = function () {
                dataLoadedCount++;
                if (dataLoadedCount == 3) {
                    callback();
                    me.unmask();
                }
            };
            me.mask('Initializing...');
            loadFscYears(innerCallback);
            loadFscAccounts(innerCallback);
            loadHcmHouseCodes(innerCallback);
        }
    });
} (fin.bud);
