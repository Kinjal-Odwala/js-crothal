window.__weblight_t_c0e3a119 = ['<?xml version="1.0" encoding="utf-8"?><transmission>  <target id="iiCache" requestId="2">    <store id="appDataCollectors" activeId="0" criteria="storeId:appDataCollectors,userId:[user],">      <item id="1" houseCodeId="363" moduleId="5" numberOfColumns="6" frequency="Monthly" lockout="true" email="1" emailAddress="admin@crothall.com" message="True" messageText="Your monthly BI Statistics update is overdue. Click here to enter the data now before you can no longer access the other modules." lockoutMessage="True" lockoutMessageText="Your monthly BI Statistics update is overdue. You will no longer be able to access any modules until you complete the update. Click here to enter the data now." />    </store>  </target></transmission>','<div>    <div class="form-header">        Data Collector Information    </div>    <div id="DataCollectorContentArea" class="body">         <div id="TableEditArea">            <div class="LabelTextAreaLeftDataCollector">                <span class="requiredFieldIndicator">&#149;</span>Description:            </div>            <div id="Div14">                <div id="description">                </div>            </div>            <div style="clear: both;">            </div>        </div>        <div id="TableEditArea">            <div class="LabelTextAreaLeftDataCollector">                <span class="requiredFieldIndicator">&#149;</span>Frequency:            </div>            <div id="InputTextAreaRight">                <div id="frequency">                </div>            </div>            <div style="clear: both;">            </div>        </div>         <div id="Div13">            <div class="LabelTextAreaLeftDataCollector">                Active:            </div>            <div id="InputTextAreaRight">                <div id="active">                </div>            </div>            <div style="clear: both;">            </div>        </div>        <div style="clear: both;">        </div>         <div id="TableEditArea">            <div class="LabelTextAreaLeftDataCollector">                <span class="requiredFieldIndicator">&#149;</span>House Code:            </div>            <div id="InputTextAreaRight">                <div id="houseCodeId">                </div>            </div>        </div>        <div style="clear: both;">        </div>        <div id="TableEditArea">            <div class="LabelTextAreaLeftDataCollector">                <span class="requiredFieldIndicator">&#149;</span>Module:            </div>            <div id="InputTextAreaRight">                <div id="moduleId">                </div>            </div>        </div>        <div style="clear: both;">        </div>        <div id="Div6">            <div class="LabelTextAreaLeftDataCollector">               <span class="requiredFieldIndicator">&#149;</span>Columns:            </div>            <div id="InputTextAreaRight" class="lov-combo">                <div id="columns">                </div>            </div>        </div>                 <div style="clear: both;">        </div>       <div id="Div7">            <div class="LabelTextAreaLeftDataCollector">                <span class="requiredFieldIndicator">&#149;</span>Number of columns:            </div>            <div id="Div9">                <div id="numberOfColumns">                </div>            </div>            <div style="clear: both;">            </div>        </div>        <div style="clear: both;">        </div>        <div id="users-holder">            <div class="LabelTextAreaLeftDataCollector">              <span class="requiredFieldIndicator">&#149;</span>Users:            </div>            <div id="Div11" class="lov-combo">                <div id="users">                </div>            </div>        </div>        <div style="clear: both;">        </div>        <div id="Div3">            <div class="LabelTextAreaLeftDataCollector">                Lockout:            </div>            <div id="Div5">                <div id="lockout">                </div>            </div>            <div style="clear: both;">            </div>        </div>        <div style="clear: both;">        </div>        <div id="Div1">            <div class="LabelTextAreaLeftDataCollector">                Email Address:            </div>            <div id="Div2" style="float:left;">                <table cellpadding="0" cellspacing="0">                  <tr>                      <td><div id="email" style="padding-bottom: 5px;"></div></td>                      <td><div id="emailAddress"></div></td>                  </tr>                </table>            </div>            <div style="clear: both;">            </div>        </div>        <div style="clear: both; height: 5px;">        </div>        <div id="Div4">            <div class="LabelTextAreaLeftDataCollector">                Message:            </div>            <div id="Div8">                <div id="message" style="padding-bottom: 5px;">                </div>                <div id="messageText">                </div>            </div>            <div style="clear: both;">            </div>        </div>        <div style="clear: both; height: 5px;">        </div>        <div id="Div10">            <div class="LabelTextAreaLeftDataCollector">                Lockout Message:            </div>            <div id="Div12">                <div id="lockoutMessage" style="padding-bottom: 5px;">                </div>                <div id="lockoutMessageText">                </div>            </div>            <div style="clear: both;">            </div>        </div>        <div style="clear: both;">        </div>    </div>    <div class="footer">        <div class="iiButton AnchorSave" id="AnchorSave">            <div class="iiButtonPart Begin" id="AnchorSaveBegin">            </div>            <div class="iiButtonPart Middle" id="AnchorSaveMiddle">                <span>&nbsp;&nbsp;Save&nbsp;&nbsp;</span></div>            <div class="iiButtonPart End" id="AnchorSaveEnd">            </div>        </div>        <div class="iiButton AnchorNew" id="AnchorNew">            <div class="iiButtonPart Begin" id="AnchorNewBegin">            </div>            <div class="iiButtonPart Middle" id="AnchorNewMiddle">                <span>&nbsp;&nbsp;New&nbsp;&nbsp;</span></div>            <div class="iiButtonPart End" id="AnchorNewEnd">            </div>        </div>        <div class="iiButton AnchorUndo" id="AnchorUndo">            <div class="iiButtonPart Begin" id="AnchorUndoBegin">            </div>            <div class="iiButtonPart Middle" id="AnchorUndoMiddle">                <span>&nbsp;&nbsp;Undo&nbsp;&nbsp;</span></div>            <div class="iiButtonPart End" id="AnchorUndoEnd">            </div>        </div>        <div style="clear: both;">        </div>    </div></div>','<div style="margin: 5px 10px 10px 10px;"> <div id="itemStatusDiv"><div id="itemStatusImage" class="itemStatusImage"></div><div id="itemModifiedImage" class="itemModifiedImage"></div><div id="itemStatusText">Loading, please wait...</div></div><div style="clear:both;height:5px;"></div>   <table>        <tr>            <td id="data-collector-grid" style="width:500px; vertical-align:top;"></td>            <td id="data-collector-editor" style="width:525px; vertical-align:top;"></td>        </tr>    </table>    </div>',''];

/**
* Copyright (c) 2009 Sergiy Kovalchuk (serg472@gmail.com)
* 
* Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
* and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
*  
* Following code is based on Element.mask() implementation from ExtJS framework (http://extjs.com/)
*
*/
; (function ($) {

    /**
    * Displays loading mask over selected element(s). Accepts both single and multiple selectors.
    *
    * @param label Text message that will be displayed on top of the mask besides a spinner (optional). 
    * 				If not provided only mask will be displayed without a label or a spinner.  	
    * @param delay Delay in milliseconds before element is masked (optional). If unmask() is called 
    *              before the delay times out, no mask is displayed. This can be used to prevent unnecessary 
    *              mask display for quick processes.   	
    */
    $.fn.maskEl = function (label, delay) {
        $(this).each(function () {
            if (delay !== undefined && delay > 0) {
                var element = $(this);
                element.data("_mask_timeout", setTimeout(function () { $.maskElement(element, label) }, delay));
            } else {
                $.maskElement($(this), label);
            }
        });
    };

    /**
    * Removes mask from the element(s). Accepts both single and multiple selectors.
    */
    $.fn.unmaskEl = function () {
        $(this).each(function () {
            $.unmaskElement($(this));
        });
    };

    /**
    * Checks if a single element is masked. Returns false if mask is delayed or not displayed. 
    */
    $.fn.isElMasked = function () {
        return this.hasClass("masked");
    };

    $.maskElement = function (element, label) {

        //if this element has delayed mask scheduled then remove it and display the new one
        if (element.data("_mask_timeout") !== undefined) {
            clearTimeout(element.data("_mask_timeout"));
            element.removeData("_mask_timeout");
        }

        if (element.isElMasked()) {
            $.unmaskElement(element);
        }

        if (element.css("position") == "static") {
            element.addClass("masked-relative");
        }

        element.addClass("masked");

        var maskDiv = $('<div class="loadmask"></div>');

        //auto height fix for IE
        if (navigator.userAgent.toLowerCase().indexOf("msie") > -1) {
            maskDiv.height(element.height() + parseInt(element.css("padding-top")) + parseInt(element.css("padding-bottom")));
            maskDiv.width(element.width() + parseInt(element.css("padding-left")) + parseInt(element.css("padding-right")));
        }

        //fix for z-index bug with selects in IE6
        if (navigator.userAgent.toLowerCase().indexOf("msie 6") > -1) {
            element.find("select").addClass("masked-hidden");
        }

        element.append(maskDiv);

        if (label !== undefined) {
            var maskMsgDiv = $('<div class="loadmask-msg" style="display:none;"></div>');
            maskMsgDiv.append('<div>' + label + '</div>');
            element.append(maskMsgDiv);

            //calculate center position
            maskMsgDiv.css("top", Math.round(element.height() / 2 - (maskMsgDiv.height() - parseInt(maskMsgDiv.css("padding-top")) - parseInt(maskMsgDiv.css("padding-bottom"))) / 2) + "px");
            maskMsgDiv.css("left", Math.round(element.width() / 2 - (maskMsgDiv.width() - parseInt(maskMsgDiv.css("padding-left")) - parseInt(maskMsgDiv.css("padding-right"))) / 2) + "px");

            maskMsgDiv.show();
        }

    };

    $.unmaskElement = function (element) {
        //if this element has delayed mask scheduled then remove it
        if (element.data("_mask_timeout") !== undefined) {
            clearTimeout(element.data("_mask_timeout"));
            element.removeData("_mask_timeout");
        }

        element.find(".loadmask-msg,.loadmask").remove();
        element.removeClass("masked");
        element.removeClass("masked-relative");
        element.find("select").removeClass("masked-hidden");
    };

})(jQuery);
// vim: ts=4:sw=4:nu:fdc=4:nospell
/*global Ext */
/**
 * @singleton 
 * @class Ext.ux.util
 *
 * Contains utilities that do not fit elsewhere
 *
 * @author     Ing. Jozef Sakáloš
 * @copyright  (c) 2009, Ing. Jozef Sakáloš
 * @version    1.0
 * @date       30. January 2009
 * @revision   $Id: Ext.ux.util.js 620 2009-03-09 12:41:44Z jozo $
 *
 * @license
 * Ext.ux.util.js is licensed under the terms of
 * the Open Source LGPL 3.0 license.  Commercial use is permitted to the extent
 * that the code/component(s) do NOT become part of another Open Source or Commercially
 * licensed development library or toolkit without explicit permission.
 *
 * <p>License details: <a href="http://www.gnu.org/licenses/lgpl.html"
 * target="_blank">http://www.gnu.org/licenses/lgpl.html</a></p>
 *
 * @donate
 * <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">
 * <input type="hidden" name="cmd" value="_s-xclick">
 * <input type="hidden" name="hosted_button_id" value="3430419">
 * <input type="image" src="https://www.paypal.com/en_US/i/btn/x-click-butcc-donate.gif" 
 * border="0" name="submit" alt="PayPal - The safer, easier way to pay online.">
 * <img alt="" border="0" src="https://www.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1">
 * </form>
 */

Ext.ns('Ext.ux.util');

// {{{
/**
 * @param {String} s
 * @return {String} MD5 sum
 * Calculates MD5 sum of the argument
 * @forum   28460
 * @author  <a href="http://extjs.com/forum/member.php?u=13648">wm003</a>
 * @version 1.0
 * @date    20. March 2008
 *
 */
Ext.ux.util.MD5 = function(s) {
    var hexcase = 0;
    var chrsz = 8;

    function safe_add(x, y){
        var lsw = (x & 0xFFFF) + (y & 0xFFFF);
        var msw = (x >> 16) + (y >> 16) + (lsw >> 16);
        return (msw << 16) | (lsw & 0xFFFF);
    }
    function bit_rol(num, cnt){
        return (num << cnt) | (num >>> (32 - cnt));
    }
    function md5_cmn(q, a, b, x, s, t){
        return safe_add(bit_rol(safe_add(safe_add(a, q), safe_add(x, t)), s),b);
    }
    function md5_ff(a, b, c, d, x, s, t){
        return md5_cmn((b & c) | ((~b) & d), a, b, x, s, t);
    }
    function md5_gg(a, b, c, d, x, s, t){
        return md5_cmn((b & d) | (c & (~d)), a, b, x, s, t);
    }
    function md5_hh(a, b, c, d, x, s, t){
        return md5_cmn(b ^ c ^ d, a, b, x, s, t);
    }
    function md5_ii(a, b, c, d, x, s, t){
        return md5_cmn(c ^ (b | (~d)), a, b, x, s, t);
    }

    function core_md5(x, len){
        x[len >> 5] |= 0x80 << ((len) % 32);
        x[(((len + 64) >>> 9) << 4) + 14] = len;
        var a =  1732584193;
        var b = -271733879;
        var c = -1732584194;
        var d =  271733878;
        for(var i = 0; i < x.length; i += 16){
            var olda = a;
            var oldb = b;
            var oldc = c;
            var oldd = d;
            a = md5_ff(a, b, c, d, x[i+ 0], 7 , -680876936);
            d = md5_ff(d, a, b, c, x[i+ 1], 12, -389564586);
            c = md5_ff(c, d, a, b, x[i+ 2], 17,  606105819);
            b = md5_ff(b, c, d, a, x[i+ 3], 22, -1044525330);
            a = md5_ff(a, b, c, d, x[i+ 4], 7 , -176418897);
            d = md5_ff(d, a, b, c, x[i+ 5], 12,  1200080426);
            c = md5_ff(c, d, a, b, x[i+ 6], 17, -1473231341);
            b = md5_ff(b, c, d, a, x[i+ 7], 22, -45705983);
            a = md5_ff(a, b, c, d, x[i+ 8], 7 ,  1770035416);
            d = md5_ff(d, a, b, c, x[i+ 9], 12, -1958414417);
            c = md5_ff(c, d, a, b, x[i+10], 17, -42063);
            b = md5_ff(b, c, d, a, x[i+11], 22, -1990404162);
            a = md5_ff(a, b, c, d, x[i+12], 7 ,  1804603682);
            d = md5_ff(d, a, b, c, x[i+13], 12, -40341101);
            c = md5_ff(c, d, a, b, x[i+14], 17, -1502002290);
            b = md5_ff(b, c, d, a, x[i+15], 22,  1236535329);
            a = md5_gg(a, b, c, d, x[i+ 1], 5 , -165796510);
            d = md5_gg(d, a, b, c, x[i+ 6], 9 , -1069501632);
            c = md5_gg(c, d, a, b, x[i+11], 14,  643717713);
            b = md5_gg(b, c, d, a, x[i+ 0], 20, -373897302);
            a = md5_gg(a, b, c, d, x[i+ 5], 5 , -701558691);
            d = md5_gg(d, a, b, c, x[i+10], 9 ,  38016083);
            c = md5_gg(c, d, a, b, x[i+15], 14, -660478335);
            b = md5_gg(b, c, d, a, x[i+ 4], 20, -405537848);
            a = md5_gg(a, b, c, d, x[i+ 9], 5 ,  568446438);
            d = md5_gg(d, a, b, c, x[i+14], 9 , -1019803690);
            c = md5_gg(c, d, a, b, x[i+ 3], 14, -187363961);
            b = md5_gg(b, c, d, a, x[i+ 8], 20,  1163531501);
            a = md5_gg(a, b, c, d, x[i+13], 5 , -1444681467);
            d = md5_gg(d, a, b, c, x[i+ 2], 9 , -51403784);
            c = md5_gg(c, d, a, b, x[i+ 7], 14,  1735328473);
            b = md5_gg(b, c, d, a, x[i+12], 20, -1926607734);
            a = md5_hh(a, b, c, d, x[i+ 5], 4 , -378558);
            d = md5_hh(d, a, b, c, x[i+ 8], 11, -2022574463);
            c = md5_hh(c, d, a, b, x[i+11], 16,  1839030562);
            b = md5_hh(b, c, d, a, x[i+14], 23, -35309556);
            a = md5_hh(a, b, c, d, x[i+ 1], 4 , -1530992060);
            d = md5_hh(d, a, b, c, x[i+ 4], 11,  1272893353);
            c = md5_hh(c, d, a, b, x[i+ 7], 16, -155497632);
            b = md5_hh(b, c, d, a, x[i+10], 23, -1094730640);
            a = md5_hh(a, b, c, d, x[i+13], 4 ,  681279174);
            d = md5_hh(d, a, b, c, x[i+ 0], 11, -358537222);
            c = md5_hh(c, d, a, b, x[i+ 3], 16, -722521979);
            b = md5_hh(b, c, d, a, x[i+ 6], 23,  76029189);
            a = md5_hh(a, b, c, d, x[i+ 9], 4 , -640364487);
            d = md5_hh(d, a, b, c, x[i+12], 11, -421815835);
            c = md5_hh(c, d, a, b, x[i+15], 16,  530742520);
            b = md5_hh(b, c, d, a, x[i+ 2], 23, -995338651);
            a = md5_ii(a, b, c, d, x[i+ 0], 6 , -198630844);
            d = md5_ii(d, a, b, c, x[i+ 7], 10,  1126891415);
            c = md5_ii(c, d, a, b, x[i+14], 15, -1416354905);
            b = md5_ii(b, c, d, a, x[i+ 5], 21, -57434055);
            a = md5_ii(a, b, c, d, x[i+12], 6 ,  1700485571);
            d = md5_ii(d, a, b, c, x[i+ 3], 10, -1894986606);
            c = md5_ii(c, d, a, b, x[i+10], 15, -1051523);
            b = md5_ii(b, c, d, a, x[i+ 1], 21, -2054922799);
            a = md5_ii(a, b, c, d, x[i+ 8], 6 ,  1873313359);
            d = md5_ii(d, a, b, c, x[i+15], 10, -30611744);
            c = md5_ii(c, d, a, b, x[i+ 6], 15, -1560198380);
            b = md5_ii(b, c, d, a, x[i+13], 21,  1309151649);
            a = md5_ii(a, b, c, d, x[i+ 4], 6 , -145523070);
            d = md5_ii(d, a, b, c, x[i+11], 10, -1120210379);
            c = md5_ii(c, d, a, b, x[i+ 2], 15,  718787259);
            b = md5_ii(b, c, d, a, x[i+ 9], 21, -343485551);
            a = safe_add(a, olda);
            b = safe_add(b, oldb);
            c = safe_add(c, oldc);
            d = safe_add(d, oldd);
        }
        return [a, b, c, d];
    }
    function str2binl(str){
        var bin = [];
        var mask = (1 << chrsz) - 1;
        for(var i = 0; i < str.length * chrsz; i += chrsz) {
            bin[i>>5] |= (str.charCodeAt(i / chrsz) & mask) << (i%32);
        }
        return bin;
    }
    function binl2hex(binarray){
        var hex_tab = hexcase ? "0123456789ABCDEF" : "0123456789abcdef";
        var str = "";
        for(var i = 0; i < binarray.length * 4; i++) {
            str += hex_tab.charAt((binarray[i>>2] >> ((i%4)*8+4)) & 0xF) + hex_tab.charAt((binarray[i>>2] >> ((i%4)*8  )) & 0xF);
        }
        return str;
    }
    return binl2hex(core_md5(str2binl(s), s.length * chrsz));
};  
// }}}
// {{{
/**
 * Clone Function
 * @param {Object/Array} o Object or array to clone
 * @return {Object/Array} Deep clone of an object or an array
 * @author Ing. Jozef Sakáloš
 */
Ext.ux.util.clone = function(o) {
	if(!o || 'object' !== typeof o) {
		return o;
	}
	if('function' === typeof o.clone) {
		return o.clone();
	}
	var c = '[object Array]' === Object.prototype.toString.call(o) ? [] : {};
	var p, v;
	for(p in o) {
		if(o.hasOwnProperty(p)) {
			v = o[p];
			if(v && 'object' === typeof v) {
				c[p] = Ext.ux.util.clone(v);
			}
			else {
				c[p] = v;
			}
		}
	}
	return c;
}; // eo function clone
// }}}
// {{{
/**
 * Copies the source object properties with names that match target object properties to the target. 
 * Undefined properties of the source object are ignored even if names match.
 * This way it is possible to create a target object with defaults, apply source to it not overwriting 
 * target defaults with <code>undefined</code> values of source.
 * @param {Object} t The target object
 * @param {Object} s (optional) The source object. Equals to scope in which the function runs if omitted. That 
 * allows to set this function as method of any object and then call it in the scope of that object. E.g.:
 * <pre>
 * var p = new Ext.Panel({
 * &nbsp;	 prop1:11
 * &nbsp;	,prop2:22
 * &nbsp;	,<b>applyMatching:Ext.ux.util.applyMatching</b>
 * &nbsp;	// ...
 * });
 * var t = p.applyMatching({prop1:0, prop2:0, prop3:33});
 * </pre>
 * The resulting object:
 * <pre>
 * t = {prop1:11, prop2:22, prop3:33};
 * </pre>
 * @return {Object} Original passed target object with properties updated from source
 */
Ext.ux.util.applyMatching = function(t, s) {
	var s = s || this;
	for(var p in t) {
		if(t.hasOwnProperty(p) && undefined !== s[p]) {
			t[p] = s[p];
		}
	}
	return t;
}; // eo function applyMatching
// }}}

// conditional override
// {{{
/**
 * Same as {@link Ext#override} but overrides only if method does not exist in the target class
 * @member Ext
 * @param {Object} origclass
 * @param {Object} overrides
 */
Ext.overrideIf = 'function' === typeof Ext.overrideIf ? Ext.overrideIf : function(origclass, overrides) {
	if(overrides) {
		var p = origclass.prototype;
		for(var method in overrides) {
			if(!p[method]) {
				p[method] = overrides[method];
			}
		}
	}
};
// }}}

// RegExp
// {{{
/**
 * @class RegExp
 */
if('function' !== typeof RegExp.escape) {
	/**
	 * Escapes regular expression
	 * @param {String} s
	 * @return {String} The escaped string
	 * @static
	 */
	RegExp.escape = function(s) {
		if('string' !== typeof s) {
			return s;
		}
		return s.replace(/([.*+?\^=!:${}()|\[\]\/\\])/g, '\\$1');
	};
}
Ext.overrideIf(RegExp, {

	/**
	 * Clones RegExp object
	 * @return {RegExp} Clone of this RegExp
	 */
	 clone:function() {
		return new RegExp(this);
	} // eo function clone
});
// }}}

// Array
// {{{
Ext.overrideIf(Array, {
	// {{{
	/**
	 * One dimensional copy. Use {@link Ext.ux.util#clone Ext.ux.util.clone} to deeply clone an Array.
	 * @member Array
	 * @return {Array} New Array that is copy of this
	 */
	 copy:function() {
		var a = [];
		for(var i = 0, l = this.length; i < l; i++) {
			a.push(this[i]);
		}
		return a;
	} // eo function copy
	// }}}
	// {{{
	/**
	 * Not used anyway as Ext has its own indexOf
	 * @member Array
	 * @return {Integer} Index of v or -1 if not found
	 * @param {Mixed} v Value to find indexOf
	 * @param {Integer} b Starting index
	 */
	,indexOf:function(v, b) {
		for(var i = +b || 0, l = this.length; i < l; i++) {
			if(this[i] === v) { 
				return i; 
			}
		}
		return -1;
	} // eo function indexOf
	// }}}
	// {{{
	/**
	 * Returns intersection of this Array and passed arguments
	 * @member Array
	 * @return {Array} Intersection of this and passed arguments
	 * @param {Mixed} arg1 (optional)
	 * @param {Mixed} arg2 (optional)
	 * @param {Mixed} etc. (optional)
	 */
	,intersect:function() {
		if(!arguments.length) {
			return [];
		}
		var a1 = this, a2, a;
		for(var k = 0, ac = arguments.length; k < ac; k++) {
			a = [];
			a2 = arguments[k] || [];
			for(var i = 0, l = a1.length; i < l; i++) {
				if(-1 < a2.indexOf(a1[i])) {
					a.push(a1[i]);
				}
			}
			a1 = a;
		}
		return a.unique();
	} // eo function intesect
	// }}}
	// {{{
	/**
	 * Returns last index of passed argument
	 * @member Array
	 * @return {Integer} Index of v or -1 if not found
	 * @param {Mixed} v Value to find indexOf
	 * @param {Integer} b Starting index
	 */
	,lastIndexOf:function(v, b) {
		b = +b || 0;
		var i = this.length; 
		while(i-- > b) {
			if(this[i] === v) { 
				return i; 
			}
		}
		return -1;
	} // eof function lastIndexOf
	// }}}
	// {{{
	/**
	 * @member Array
	 * @return {Array} New Array that is union of this and passed arguments
	 * @param {Mixed} arg1 (optional)
	 * @param {Mixed} arg2 (optional)
	 * @param {Mixed} etc. (optional)
	 */
	,union:function() {
		var a = this.copy(), a1;
		for(var k = 0, ac = arguments.length; k < ac; k++) {
			a1 = arguments[k] || [];
			for(var i = 0, l = a1.length; i < l; i++) {
				a.push(a1[i]);
			}
		}
		return a.unique();
	} // eo function union
	// }}}
	// {{{
	/**
	 * Removes duplicates from array
	 * @member Array
	 * @return {Array} New Array with duplicates removed
	 */
	,unique:function() {
		var a = [], i, l = this.length;
		for(i = 0; i < l; i++) {
			if(a.indexOf(this[i]) < 0) { 
				a.push(this[i]); 
			}
		}
		return a;
	} // eo function unique
	// }}}

});
// }}}

// eof

// vim: ts=4:sw=4:nu:fdc=4:nospell
/*global Ext */
/**
 * @class Ext.ux.form.LovCombo
 * @extends Ext.form.ComboBox
 *
 * Simple list of values Combo
 *
 * @author    Ing. Jozef Sakáloš
 * @copyright (c) 2008, by Ing. Jozef Sakáloš
 * @version   1.3
 * @date      <ul>
 * <li>16. April 2008</li>
 * <li>2. February 2009</li>
 * </ul>
 * @revision  $Id: Ext.ux.form.LovCombo.js 733 2009-06-26 07:29:07Z jozo $
 *
 * @license Ext.ux.form.LovCombo.js is licensed under the terms of the Open Source
 * LGPL 3.0 license. Commercial use is permitted to the extent that the 
 * code/component(s) do NOT become part of another Open Source or Commercially
 * licensed development library or toolkit without explicit permission.
 * 
 * <p>License details: <a href="http://www.gnu.org/licenses/lgpl.html"
 * target="_blank">http://www.gnu.org/licenses/lgpl.html</a></p>
 *
 * @forum     32692
 * @demo      http://lovcombo.extjs.eu
 * @download  
 * <ul>
 * <li><a href="http://lovcombo.extjs.eu/lovcombo.tar.bz2">lovcombo.tar.bz2</a></li>
 * <li><a href="http://lovcombo.extjs.eu/lovcombo.tar.gz">lovcombo.tar.gz</a></li>
 * <li><a href="http://lovcombo.extjs.eu/lovcombo.zip">lovcombo.zip</a></li>
 * </ul>
 *
 * @donate
 * <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">
 * <input type="hidden" name="cmd" value="_s-xclick">
 * <input type="hidden" name="hosted_button_id" value="3430419">
 * <input type="image" src="https://www.paypal.com/en_US/i/btn/x-click-butcc-donate.gif" 
 * border="0" name="submit" alt="PayPal - The safer, easier way to pay online.">
 * <img alt="" border="0" src="https://www.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1">
 * </form>
 */
 
// Check RegExp.escape dependency
if('function' !== typeof RegExp.escape) {
	throw('RegExp.escape function is missing. Include Ext.ux.util.js file.');
}

// create namespace
Ext.ns('Ext.ux.form');
 
/**
 * Creates new LovCombo
 * @constructor
 * @param {Object} config A config object
 */
Ext.ux.form.LovCombo = Ext.extend(Ext.form.ComboBox, {

    // {{{
    // configuration options
    /**
    * @cfg {String} checkField Name of field used to store checked state.
    * It is automatically added to existing fields.
    * (defaults to "checked" - change it only if it collides with your normal field)
    */
    checkField: 'checked'

    /**
    * @cfg {String} separator Separator to use between values and texts (defaults to "," (comma))
    */
    , separator: ','

    /**
    * @cfg {String/Array} tpl Template for items. 
    * Change it only if you know what you are doing.
    */
    // }}}
    // {{{
	, constructor: function (config) {
	    config = config || {};
	    config.listeners = config.listeners || {};
	    Ext.applyIf(config.listeners, {
	        scope: this
			, beforequery: this.onBeforeQuery
			, blur: this.onRealBlur
	    });
	    Ext.ux.form.LovCombo.superclass.constructor.call(this, config);
	} // eo function constructor
    // }}}
    // {{{

    , resetHeight: function () {
        var me = this;
        var value = this.getCheckedDisplay();
        //me.$textbox.val(this.getCheckedValue());
        me.$textbox.height(Math.floor(value.length * 6 / me.$textbox.width() + 1) * 21);
    }
    , initComponent: function () {

        // template with checkbox
        if (!this.tpl) {
            this.tpl =
				 '<tpl for=".">'
				+ '<div class="x-combo-list-item">'
				+ '<img src="' + Ext.BLANK_IMAGE_URL + '" '
				+ 'class="ux-lovcombo-icon ux-lovcombo-icon-'
				+ '{[values.' + this.checkField + '?"checked":"unchecked"' + ']}">'
				+ '<div class="ux-lovcombo-item-text">{' + (this.displayField || 'text') + ':htmlEncode}</div>'
				+ '</div>'
				+ '</tpl>'
			;
        }

        // call parent
        Ext.ux.form.LovCombo.superclass.initComponent.apply(this, arguments);

        // remove selection from input field
        this.onLoad = this.onLoad.createSequence(function () {
            if (this.el) {
                var v = this.el.dom.value;
                this.el.dom.value = '';
                this.el.dom.value = v;
            }
        });
        var me = this;
        this.on('render', function () {

            me.$textbox = $('#' + this.id);
            me.$textbox.replaceWith('<textarea id="' + this.id + '" class="x-form-text x-form-field x-trigger-noedit"></textarea>');
            me.$textbox = $('#' + this.id);

        });


    } // eo function initComponent
    // }}}
    // {{{
    /**
    * Disables default tab key bahavior
    * @private
    */
	, initEvents: function () {
	    Ext.ux.form.LovCombo.superclass.initEvents.apply(this, arguments);

	    // disable default tab handling - does no good
	    this.keyNav.tab = false;

	} // eo function initEvents
    // }}}
    // {{{
    /**
    * Clears value
    */
	, clearValue: function () {
	    this.value = '';
	    this.setRawValue(this.value);
	    this.store.clearFilter();
	    this.store.each(function (r) {
	        r.set(this.checkField, false);
	    }, this);
	    if (this.hiddenField) {
	        this.hiddenField.value = '';
	    }
	    this.applyEmptyText();
	} // eo function clearValue
    // }}}
    // {{{
    /**
    * @return {String} separator (plus space) separated list of selected displayFields
    * @private
    */
	, getCheckedDisplay: function () {
	    var re = new RegExp(this.separator, "g");
	    return this.getCheckedValue(this.displayField).replace(re, this.separator + ' ');
	} // eo function getCheckedDisplay
    // }}}
    // {{{
    /**
    * @return {String} separator separated list of selected valueFields
    * @private
    */
	, getCheckedValue: function (field) {
	    field = field || this.valueField;
	    var c = [];

	    // store may be filtered so get all records
	    var snapshot = this.store.snapshot || this.store.data;

	    snapshot.each(function (r) {
	        if (r.get(this.checkField)) {
	            c.push(r.get(field));
	        }
	    }, this);

	    return c.join(this.separator);
	} // eo function getCheckedValue
    // }}}
    // {{{
    /**
    * beforequery event handler - handles multiple selections
    * @param {Object} qe query event
    * @private
    */
	, onBeforeQuery: function (qe) {
	    qe.query = qe.query.replace(new RegExp(RegExp.escape(this.getCheckedDisplay()) + '[ ' + this.separator + ']*'), '');
	} // eo function onBeforeQuery
    // }}}
    // {{{
    /**
    * blur event handler - runs only when real blur event is fired
    * @private
    */
	, onRealBlur: function () {
	    this.list.hide();
	    var rv = this.getRawValue();
	    var rva = rv.split(new RegExp(RegExp.escape(this.separator) + ' *'));
	    var va = [];
	    var snapshot = this.store.snapshot || this.store.data;

	    // iterate through raw values and records and check/uncheck items
	    Ext.each(rva, function (v) {
	        snapshot.each(function (r) {
	            if (v === r.get(this.displayField)) {
	                va.push(r.get(this.valueField));
	            }
	        }, this);
	    }, this);
	    this.setValue(va.join(this.separator));
	    this.store.clearFilter();
	} // eo function onRealBlur
    // }}}
    // {{{
    /**
    * Combo's onSelect override
    * @private
    * @param {Ext.data.Record} record record that has been selected in the list
    * @param {Number} index index of selected (clicked) record
    */
	, onSelect: function (record, index) {
	    if (this.fireEvent('beforeselect', this, record, index) !== false) {

	        // toggle checked field
	        record.set(this.checkField, !record.get(this.checkField));

	        // display full list
	        if (this.store.isFiltered()) {
	            this.doQuery(this.allQuery);
	        }

	        // set (update) value and fire event
	        this.setValue(this.getCheckedValue());
	        this.fireEvent('select', this, record, index);
	    }
	} // eo function onSelect
    // }}}
    // {{{
    /**
    * Sets the value of the LovCombo. The passed value can by a falsie (null, false, empty string), in
    * which case the combo value is cleared or separator separated string of values, e.g. '3,5,6'.
    * @param {Mixed} v value
    */
	, setValue: function (v) {
	    if (v) {
	        v = '' + v;
	        if (this.valueField) {
	            this.store.clearFilter();
	            this.store.each(function (r) {
	                var checked = !(!v.match(
						 '(^|' + this.separator + ')' + RegExp.escape(r.get(this.valueField))
						+ '(' + this.separator + '|$)'))
					;

	                r.set(this.checkField, checked);
	            }, this);
	            this.value = this.getCheckedValue();
	            this.setRawValue(this.getCheckedDisplay());
	            if (this.hiddenField) {
	                this.hiddenField.value = this.value;
	            }
	        }
	        else {
	            this.value = v;
	            this.setRawValue(v);
	            if (this.hiddenField) {
	                this.hiddenField.value = v;
	            }
	        }
	        if (this.el) {
	            this.el.removeClass(this.emptyClass);
	        }
	    }
	    else {
	        this.clearValue();
	    }
	    this.resetHeight();
	} // eo function setValue
    // }}}
    // {{{
    /**
    * Selects all items
    */
	, selectAll: function () {
	    this.store.each(function (record) {
	        // toggle checked field
	        record.set(this.checkField, true);
	    }, this);

	    //display full list
	    this.doQuery(this.allQuery);
	    this.setValue(this.getCheckedValue());
	} // eo full selectAll
    // }}}
    // {{{
    /**
    * Deselects all items. Synonym for clearValue
    */
    , deselectAll: function () {
        this.clearValue();
    } // eo full deselectAll 
    // }}}

});                      // eo extend
 
// register xtype
Ext.reg('lovcombo', Ext.ux.form.LovCombo); 
 
// eof

if (top.ui.ctl.menu) {
	var me = this;
	top.ui.ctl.menu.Dom.me.registerDirtyCheck(dirtyCheck, me);
}

function dirtyCheck(me) {
	return !window.top.fin.cmn.status.itemValid();
}
            
function modified(status) {
	window.top.fin.appUI.modified = status;
	
	if (status)
		me.setStatus("Edit");
}

function setStatus(status) {
	var me = this;

	me.$itemStatusImage = $("#wl-ctrl-100-itemStatusImage");
	me.$itemModifiedImage = $("#wl-ctrl-100-itemModifiedImage");
	me.$itemStatusText = $("#wl-ctrl-100-itemStatusText");

	if (status == "New")
		message = "New";
	else if (status == "Loading" || status == "Saving" || status == "Exporting" || status == "Uploading" || status == "Importing")
		message = status + ", please wait...";
	else if (status == "Saved")
		message = "Data saved successfully.";
	else if (status == "Imported")
		message = "Data imported successfully.";
	else if (status == "Exported")
		message = "Data exported successfully.";
	else if (status == "Locked")
		message = "The current page is Readonly.";
	else if (status == "Error")
		message = "Error while updating the data.";
	else
		message = "Normal";

	if (status == "Locked")
		me.$itemModifiedImage.addClass("Locked");
	else
		me.$itemModifiedImage.removeClass("Locked");

	if (status == "Edit")
		me.$itemModifiedImage.addClass("Modified");
	else
		me.$itemModifiedImage.removeClass("Modified");

	if (status == "Edit" || status == "Loaded" || status == "Saved" || status == "Imported" || status == "Exported")
		status = "Normal";

	me.$itemStatusImage.attr("class", "itemStatusImage " + status);
	me.$itemStatusText.text(message);
}

Ext.Ajax.timeout = 300000; //5 minutes

jQuery.ajaxSettings.contentType = 'application/x-www-form-urlencoded; charset=utf-8';

Ext.namespace('eFin', 'eFin.data', 'eFin.ctrl', 'eFin.page', 'eFin.page.app', 'eFin.data.app', 'eFin.ctrl.app','eFin.data.hcm');

Ext.override(WebLight.Control, {

    mask: function (msg) {
        if (!msg)
            msg = 'Please wait...';
        //this.$this.maskEl(msg);
		setStatus(msg.replace("...", ""));
		Ext.getBody().mask(msg);
    },
    unmask: function (msg) {
        //this.$this.unmaskEl();
		if (window.top.fin.appUI.modified)
			setStatus("Edit");
		else
			setStatus(msg);
		Ext.getBody().unmask();
    }
});

Ext.override(WebLight.Page, {

    mask: function (msg) {
        if (!msg)
            msg = 'Please wait...';
        //this.$this.maskEl(msg);
    },
    unmask: function () {
        //this.$this.unmaskEl();
    }
});

Ext.grid.RowNumberer = function(config){
    Ext.apply(this, config);
    if(this.rowspan){
        this.renderer = this.renderer.createDelegate(this);
    }
};

Ext.grid.RowNumberer.prototype = {   
    header: "#",    
    width: 30,
    sortable: true,
    fixed:false,
    menuDisabled:false,
    dataIndex: '',
    id: '0',
    rowspan: undefined,
	cls:'ux-grid-1',
    renderer : function(v, p, record, rowIndex){
        if(this.rowspan){
            p.cellAttr = 'rowspan="'+this.rowspan+'"';
        }
        return rowIndex+1;
    }
};

Ext.EventManager.onWindowResize(function () {
	
	$("#ext-gen30").height($(window).height() - 75);
	$("#ext-gen25").height($(window).height() - 50);
	$("#wl-ctrl-101-DataCollectorContentArea").height($(window).height() - 123);
	$("#wl-ctrl-101-DataCollectorContentArea").width($(window).width() - 550);
});

Ext.apply(Ext.form.VTypes, {
    multipleEmail: function (value, field) {
        
		var email = value.split(';');
		for (var i = 0; i < email.length; i++) {
			if (email[i] != '') {
				if (!this.validateEmail(email[i])) {
					return false;
				}
			}
		}
		return true; 
    },
	
	validateEmail: function(field) {
	    var regex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,5}$/;
	    return (regex.test(field)) ? true : false;
	},
	
    multipleEmailText: 'Please enter valid Email Address. Use semicolon to separate two addresses.'
});

eFin.data.XmlReader = Ext.extend(Ext.data.XmlReader, {

    read: function (response) {
        var xml = this.formatXml(response.responseText);
        var doc;
        if (window.ActiveXObject) {
            doc = new ActiveXObject("Microsoft.XMLDOM");
            doc.async = "false";
            doc.loadXML(xml);
        } else {
            doc = new DOMParser().parseFromString(xml, "text/xml");
        }

        if (!doc) {
            throw { message: "XmlReader.read: XML Document not available" };
        }
        return this.readRecords(doc);
    },

    /// fix returned data is "True" and "False" issue
    formatXml: function (input) {

        input = input.replace(/"True"/gi, '"true"');
        input = input.replace(/"False"/gi, '"false"');
        return input;
    }

});

eFin.data.XmlStore = WebLight.extend(WebLight.data.Store, {

    /// default api url
    url: '/net/crothall/chimes/fin/app/act/Provider.aspx',

    recordName: 'item',

    /// constructor
    constructor: function (config) {
        var me = this;
        config = config || {};
        var fields = config.fields || this.fields;
        var reader = config.reader || this.reader;
        var idProperty = config.idProperty || this.idProperty;
        if (!idProperty)
            idProperty = '@id';

        if (!reader && fields && fields.length) {
            reader = new eFin.data.XmlReader({ record: me.recordName, idProperty: idProperty }, fields);
            config.reader = reader;
            this.reader = reader;
        }

        eFin.data.XmlStore.superclass.constructor.call(this, config);

    },

    requestId: 2,
    moduleId: 'app',
    targetId: 'iiCache',
    storeId: '',

    getRequestId: function () { return this.requestId; },

    getStoreId: function () { return this.storeId; },

    getCriteria: function () { return {}; },

    getRequestXml: function () {
        var arr = ['<criteria>'];
        var criteria = this.getCriteria();

        var userId = '[user]';

        criteria = Ext.apply(criteria || {}, { storeId: this.getStoreId(), userId: userId });

        for (i in criteria) {
            arr.push(String.format('{0}:{1},', i, criteria[i]));
        }

        arr.push('</criteria>');
        return arr.join('');
    },


    load: function (options) {

        this.setBaseParam('requestId', this.getRequestId());
        this.setBaseParam('moduleId', this.moduleId);
        this.setBaseParam('targetId', this.targetId);
        this.setBaseParam('requestXml', this.getRequestXml());

        eFin.data.XmlStore.superclass.load.call(this, {});
    },

    reload: function (options) {
        // do not call subclass load event
        this.setBaseParam('requestId', this.getRequestId());
        this.setBaseParam('moduleId', this.moduleId);
        this.setBaseParam('targetId', this.targetId);
        this.setBaseParam('requestXml', this.getRequestXml());

        eFin.data.XmlStore.superclass.load.call(this, {});
    },

    loadData: function (xml) {
        var doc;
        if (window.ActiveXObject) {
            doc = new ActiveXObject("Microsoft.XMLDOM");
            doc.async = "false";
            doc.loadXML(xml);
        } else {
            doc = new DOMParser().parseFromString(xml, "text/xml");
        }

        eFin.data.XmlStore.superclass.loadData.call(this, doc);
    },

    addAttributes: function (data) { },

    _ignoredRecords: null,
    ignoreRecords: function (records) {
        var me = this;
        if (null == me._ignoredRecords)
            me._ignoredRecords = [];
        if (WebLight.isArray(records))
            me._ignoredRecords.concat(records);
        else
            me._ignoredRecords.push(records);
    },

    getChangedRecords: function () {
        var me = this;
        var records = eFin.data.XmlStore.superclass.getChangedRecords.call(this);

        if (null == me._ignoredRecords)
            return records;

        var changedRecords = [];
        WebLight.each(records, function (r) {
            if (me._ignoredRecords.indexOf(r) == -1)
                changedRecords.push(r);
        });
        return changedRecords;
    },

    /// submit changes to server
    submitChanges: function (callback) {
        var current = this;
        this.fireEvent('beforesubmit', this);

        var xml = ['<transaction id="1">'];

        Ext.each(this.getChangedRecords(), function (item, index) {

            xml.push('<');
            xml.push(current.getStoreId().replace(/s$/, ''));
            current.addAttributes(item.data);
            for (key in item.data) {
                var value = item.data[key];
                if (Ext.isDate(value))
                    value = Ext.util.Format.date(value, 'm/d/Y');
                else if (Ext.isString(value))
                    value = value.replace(/&/gi, '&amp;').replace(/"/gi, '&quot;').replace(/</gi, '&lt;').replace(/>/gi, '&gt;');
                xml.push(String.format(' {0}="{1}"', key, value));

            }
            xml.push('/>');
        }, this);

        xml.push('</transaction>');

        var postData = String.format('moduleId={0}&requestId={1}&requestXml={2}&&targetId=iiTransaction',
            this.moduleId, this.requestId, encodeURIComponent(xml.join('').replace(/\&/gi, '&amp;')));

        jQuery.post(this.url, postData, function (data, status) {
            var innerCallback = function () {
                if (callback)
                    callback(data, status);
                current.fireEvent('submit');
            };
            innerCallback();
        });
    }

});

eFin.data.XmlStore._requestId = 2;
//http://localhost/net/crothall/chimes/fin/app/act/Provider.aspx?moduleId=app&targetId=iiCache&requestId=1&requestXml=%3Ccriteria%3EstoreId:appDataCollectors,userId:[user]%3C/criteria%3E

/*
<item id="1" houseCodeId="363" moduleId="5" numberOfColumns="6" frequency="Monthly" 
lockout="True" email="True" emailAddress="admin@crothall.com" message="True" 
messageText="Your monthly BI Statistics update is overdue. Click here to enter the data now before you can no longer access the other modules." lockoutMessage="True" 
lockoutMessageText="Your monthly BI Statistics update is overdue. You will no longer be able to access any modules until you complete the update. Click here to enter the data now."/>

*/

eFin.data.app.DataCollectorStore = WebLight.extend(eFin.data.XmlStore, {

    url: '/net/crothall/chimes/fin/app/act/Provider.aspx',

    moduleId: 'app',

    recordName: 'item',

    storeId: 'appDataCollectors',

    fields: [
               { name: 'id', mapping: '@id', type: 'float' },
               { name: 'houseCodeId', mapping: '@houseCodeId', type: 'float' },
               { name: 'houseCodeBrief', mapping: '@houseCodeBrief' },
               { name: 'moduleId', mapping: '@moduleId', type: 'float' },
               { name: 'numberOfColumns', mapping: '@numberOfColumns', type: 'float' },
               { name: 'frequency', mapping: '@frequency' },
               { name: 'lockout', mapping: '@lockout', type: 'bool' },
               { name: 'email', mapping: '@email', type: 'bool' },
               { name: 'emailAddress', mapping: '@emailAddress' },
               { name: 'columns', mapping: '@columns' },
               { name: 'users', mapping: '@users' },
               { name: 'message', mapping: '@message', type: 'bool' },
               { name: 'messageText', mapping: '@messageText' },
               { name: 'lockoutMessage', mapping: '@lockoutMessage', type: 'bool' },
               { name: 'lockoutMessageText', mapping: '@lockoutMessageText' },
               { name: 'active', mapping: '@active', type: 'bool' },
               { name: 'description', mapping: '@description' }
           ]

    , loadSampleData: function () {
        this.loadData(window.__weblight_t_c0e3a119[0]);
    }
});
/*
<item id="5" number="5" name="House Code" description="HcmHouseCodes"/>
*/

eFin.data.app.ModuleStore = WebLight.extend(eFin.data.XmlStore, {

    url: '/net/crothall/chimes/fin/app/act/Provider.aspx',

    moduleId: 'app',

    recordName: 'item',

    storeId: 'appModules',
	
	module: '',

    fields: [
               { name: 'id', mapping: '@id', type: 'float' },
               { name: 'number', mapping: '@number', type: 'float' },
               { name: 'name', mapping: '@name' },
               { name: 'description', mapping: '@description' }
           ],
	
	load: function(){
		this.module = "DataCollector";
		eFin.data.app.ModuleStore.superclass.load.call(this);
	},

    getCriteria: function () {
        return { module: this.module };
    }
});
/*
<item id="22" number="22" name="HcmHoucBedsLicensed"/>
*/

eFin.data.app.ModuleColumnStore = WebLight.extend(eFin.data.XmlStore, {

    url: '/net/crothall/chimes/fin/app/act/Provider.aspx',

    moduleId: 'app',

    recordName: 'item',

    storeId: 'appModuleColumns',

    moduleName: '',

    fields: [
               { name: 'id', mapping: '@id', type: 'float' },
               { name: 'number', mapping: '@number', type: 'float' },
               { name: 'name', mapping: '@name' },
               { name: 'description', mapping: '@description' }
           ]
    ,
    load: function (moduleName) {
        this.moduleName = moduleName;


        eFin.data.app.ModuleColumnStore.superclass.load.call(this);
    },

    getCriteria: function () {
        return { module: this.moduleName };
    }
});

eFin.data.hcm.HouseCodeStore = WebLight.extend(eFin.data.XmlStore, {

    url: '/net/crothall/chimes/fin/hcm/act/provider.aspx',

    moduleId: 'hcm',

    storeId: 'hcmHouseCodes',

    getCriteria: function () {
        var me = this;

        return { appUnitBrief: me.baseParams['query'] || '' };
    },

    fields: [
               { name: 'id', mapping: '@id' },
               { name: 'name', mapping: '@name' },
               { name: 'number', mapping: '@number' },
               { name: 'brief', mapping: '@brief' },
               { name: 'appUnit', mapping: '@appUnit' },
               { name: 'hirNode', mapping: '@hirNode' }
           ]
});

/*
<item id="3" dataCollectorId="1" numberOfColumns="6" frequency="Monthly" brief="BedsLicensed" title="Beds Licensed" displayOrder="3" active="True"/>
*/

eFin.data.app.DataCollectorColumnStore = WebLight.extend(eFin.data.XmlStore, {

    url: '/net/crothall/chimes/fin/app/act/Provider.aspx',

    moduleId: 'app',

    recordName: 'item',

    storeId: 'appDataCollectorColumns',

    dataCollectorId: 0,

    fields: [
               { name: 'id', mapping: '@id', type: 'float' },
               { name: 'dataCollectorId', mapping: '@dataCollectorId', type: 'int' },
               { name: 'moduleColumn', mapping: '@moduleColumnId', type: 'float' },
               { name: 'brief', mapping: '@brief', type: 'string' },
               { name: 'numberOfColumns', mapping: '@numberOfColumns', type: 'int' },
               { name: 'title', mapping: '@title', type: 'string' },
               { name: 'active', mapiing: '@active', type: 'bool' },
               { name: 'displayOrder', mapping: '@displayOrder', type: 'int' }
           ]
    ,
    load: function (dataCollectorId) {
        this.dataCollectorId = dataCollectorId;

        eFin.data.app.ModuleColumnStore.superclass.load.call(this);
    },

    getCriteria: function () {
        return { dataCollectorId: this.dataCollectorId };
    }
});
/*
<item id="22" number="22" name="HcmHoucBedsLicensed"/>
*/

eFin.data.app.AppUserStore = WebLight.extend(eFin.data.XmlStore, {

    url: '/net/crothall/chimes/fin/app/act/Provider.aspx',

    moduleId: 'app',

    recordName: 'item',

    storeId: 'appUsers',

    hcmHouseCode: 0,

    fields: [
               { name: 'id', mapping: '@id', type: 'float' },
               { name: 'name', mapping: '@name' }
           ]
    ,
    load: function (hcmHouseCode) {
        this.hcmHouseCode = hcmHouseCode;

        if (this.hcmHouseCode > 0)
            eFin.data.app.AppUserStore.superclass.load.call(this);
    },

    getCriteria: function () {
        return { hcmHouseCode: this.hcmHouseCode };
    }
});
/*
<item id="3" dataCollectorId="1" numberOfColumns="6" frequency="Monthly" brief="BedsLicensed" title="Beds Licensed" displayOrder="3" active="True"/>
*/

eFin.data.app.DataCollectorUserStore = WebLight.extend(eFin.data.XmlStore, {

    url: '/net/crothall/chimes/fin/app/act/Provider.aspx',

    moduleId: 'app',

    recordName: 'item',

    storeId: 'appDataCollectorUsers',

    dataCollectorId: 0,

    fields: [
               { name: 'id', mapping: '@id', type: 'float' },
               { name: 'appUser', mapping: '@appUser', type: 'float' }
           ]
    ,
    load: function (dataCollectorId) {
        this.dataCollectorId = dataCollectorId;


        eFin.data.app.DataCollectorUserStore.superclass.load.call(this);
    },

    getCriteria: function () {
        return { dataCollectorId: this.dataCollectorId };
    }
});

Ext.override(Ext.ux.form.LovCombo, {
    beforeBlur: Ext.emptyFn
});

eFin.ctrl.app.DataCollectorEditor = WebLight.extend(WebLight.form.DataView, {

    html: window.__weblight_t_c0e3a119[1],

    moduleStore: null,
    houseCodeStore: null,
    moduleColumnStore: null,
    userStore: null,
    dataCollectorColumnStore: null,
    dataCollectorUserStore: null,

    loadingCount: 0,

    onDataBeforeLoad: function () {
        var me = this;
        if (me.loadingCount++ == 0)
            me.mask('Loading...');
    },

    onDataLoad: function () {
        var me = this;
        if (--me.loadingCount == 0)
            me.unmask("Loaded");
    },

    attachLoadMaskEvent: function (store) {
        var me = this;

        store.on('beforeload', me.onDataBeforeLoad.createDelegate(me));
        store.on('load', me.onDataLoad.createDelegate(me));
    },

    createChildControls: function () {

        var me = this;

        me.moduleStore = new eFin.data.app.ModuleStore();
        me.moduleColumnStore = new eFin.data.app.ModuleColumnStore();
        if (null == me.houseCodeStore)
            me.houseCodeStore = new eFin.data.hcm.HouseCodeStore();
        me.dataCollectorColumnStore = new eFin.data.app.DataCollectorColumnStore();
        me.dataCollectorUserStore = new eFin.data.app.DataCollectorUserStore();
        me.userStore = new eFin.data.app.AppUserStore();

        me.attachLoadMaskEvent(me.moduleStore);
        me.attachLoadMaskEvent(me.moduleColumnStore);
        me.attachLoadMaskEvent(me.houseCodeStore);
        me.attachLoadMaskEvent(me.dataCollectorColumnStore);
        me.attachLoadMaskEvent(me.dataCollectorUserStore);
        me.attachLoadMaskEvent(me.userStore);

        me.initFields();

        me.initButtons();

        me.on('update', function (name, value, oldValue, field, data) {

        });

        eFin.ctrl.app.DataCollectorEditor.superclass.createChildControls.call(this);
        me.on('render', function () {
            me.disable();
            me.$child('users-holder').hide();
        });
    },

    initFields: function () {
        var me = this;

        var frequencyField = new Ext.form.ComboBox({ valueField: 'name', allowBlank: false, name: 'frequency',
            triggerAction: 'all', editable: false, displayField: 'name',
            store: new Ext.data.ArrayStore({ idIndex: 0, fields: ['name'], data: [['Weekly'], ['Monthly'], ['Semiannual']] }), mode: 'local',
			listeners: { 'change': function() { modified(true); } }
        });
        var numberOfColumnsField = new Ext.form.TextField({ name: 'numberOfColumns', editable: false, value: 0, minValue: 0, width: 50 });
        var houseCodeField = new Ext.form.ComboBox({ valueField: 'id', allowBlank: false, resizeable: true, name: 'houseCodeId', triggerAction: 'all', forceSelection: true,
            editable: true, displayField: 'name', store: me.houseCodeStore, mode: 'local', width: 350,
			listeners: { 'change': function() { modified(true); } }
        });
        var moduleField = new Ext.form.ComboBox({ valueField: 'id', displayField: 'name', editable: false, triggerAction: 'all', mode: 'local', name: 'moduleId', store: me.moduleStore, listeners: { 'change': function() { modified(true); } } });
        var descriptionField = new Ext.form.TextField({ name: 'description', width: 350, maxLength: 250, allowBlank: false, regex: /^[a-zA-Z0-9\s-_]+$/, regexText: 'This field should only contain letters, numbers and special charactes like_-', msgTarget: 'side',
            autoCreate: { tag: 'input', type: 'text', maxLength: 250, autocomplete: 'off' },
			listeners: { 'change': function() { modified(true); } }
        });
        var columnField = new Ext.ux.form.LovCombo({ valueField: 'id', resizable: true, width: 370, displayField: 'description', editable: false,
            triggerAction: 'all', mode: 'local', name: 'columns', store: me.moduleColumnStore, allowBlank: false,
			listeners: { 'change': function() { modified(true); } }
        });
        var userField = new Ext.ux.form.LovCombo({ valueField: 'id', resizable: true, width: 370, displayField: 'name', editable: false, triggerAction: 'all', allowBlank: false,
            mode: 'local', name: 'users', store: me.userStore,
			listeners: { 'change': function() { modified(true); } }
        });
        var lockoutField = new Ext.form.Checkbox({ name: 'lockout' });
        var activeField = new Ext.form.Checkbox({ name: 'active' });
        var sendEmailField = new Ext.form.Checkbox({ name: 'email' });
        var emailAddressField = new Ext.form.TextField({ width: 330, name: 'emailAddress', maxLength: 250, 
			msgTarget: 'side',
			vtype: 'multipleEmail',
            autoCreate: { tag: 'input', type: 'text', maxLength: 250, autocomplete: 'off' },
			listeners: { 'change': function() { modified(true); } }
        });
        var messageSendField = new Ext.form.Checkbox({ boxLabel: '', name: 'message' });
        var messageField = new Ext.form.TextArea({ width: 350, height: 70, name: 'messageText', listeners: { 'change': function() { modified(true); } } });
        var lockoutMessageSendField = new Ext.form.Checkbox({ boxLabel: '', name: 'lockoutMessage' });
        var lockoutMessageField = new Ext.form.TextArea({ width: 350, height: 70, name: 'lockoutMessageText', listeners: { 'change': function() { modified(true); } } });

        var toggleEmailAddressField = function () {
            var checked = me.getData().email;

            if (arguments.length > 0)
                checked = sendEmailField.getValue();
            if (checked) {
                emailAddressField.allowBlank = false;
                emailAddressField.show();
            }
            else {
                emailAddressField.allowBlank = true;
                emailAddressField.hide();
            }
        }
        var toggleMessageTextField = function () {
            var checked = me.getData().message;
            if (arguments.length > 0)
                checked = messageSendField.getValue();
            if (checked) {
                messageField.allowBlank = false;
                messageField.show();
            }
            else {
                messageField.allowBlank = true;
                messageField.hide();
            }
        }
        var toggleUsersContainer = function () {
            var data = me.getData();

            if (data.moduleId == 1)
                me.$child('users-holder').show();
            else
                me.$child('users-holder').hide();
        };
        var toggleLockoutMessageTextField = function () {
            var checked = me.getData().lockoutMessage;
            if (arguments.length > 0)
                checked = lockoutMessageSendField.getValue();
            if (checked) {
                lockoutMessageField.allowBlank = false;
                lockoutMessageField.show();
            }
            else {
                lockoutMessageField.allowBlank = true
                lockoutMessageField.hide();
            }
        }

        var reloadColumns = function () {
            var moduleRecord = me.moduleStore.getById(moduleField.getValue());
            if (moduleRecord) {
                var moduleName = moduleRecord.get('description');
                if (me.moduleColumnStore.lastModuleName != moduleName) {
                    me.moduleColumnStore.lastModuleName = moduleName;

                    me.moduleColumnStore.load(moduleName);
                }
            }
            else
                me.moduleColumnStore.loadData({ data: [] });
        };

        var reloadUsers = function () {
            var houseCodeId = me.getData().houseCodeId;
            var moduleId = me.getData().moduleId;
            if (houseCodeId && houseCodeId > 0 && moduleId == 1 && me.userStore.lastHouseCodeId != houseCodeId) {
                me.userStore.lastHouseCodeId = houseCodeId;
                me.userStore.load(houseCodeId);
            }
        };

        var applyColumns = function () {

            if (me.moduleColumnStore.getCount() == 0)
                return;

            var values = [];

            me.dataCollectorColumnStore.each(function (record, index) {
                values.push(record.get('moduleColumn'));
            });

            columnField.setValue(values.join(','));
            me.getData().columns = values.join(',');
            me.fireEvent('update', 'columns', values.join(','));
        };

        me.dataCollectorColumnStore.on('load', applyColumns);
        me.moduleColumnStore.on('load', applyColumns);

		//sendEmailField.on('check', toggleEmailAddressField);
        //messageSendField.on('check', toggleMessageTextField);
		
		sendEmailField.on('check', function () {
			toggleEmailAddressField(1);
            modified(true);
        });
		
		messageSendField.on('check', function () {
			toggleMessageTextField(1);
            modified(true);
        });

        var applyUsers = function () {

            if (me.userStore.getCount() == 0)
                return;

            var values = [];
            me.dataCollectorUserStore.each(function (record, index) {
                values.push(record.get('appUser'));
            });

            userField.setValue(values.join(','));
            me.getData().users = values.join(',');
            me.fireEvent('update', 'users', values.join(','));
        };

        me.dataCollectorUserStore.on('load', applyUsers);
        me.userStore.on('load', applyUsers);

        me.on('update', function (name, newValue, oldValue) {
            if (oldValue == newValue)
                return;

            switch (name) {
                case 'moduleId':
                    reloadColumns();
                    toggleUsersContainer();
                    break;
                case 'houseCodeId':
                    reloadUsers();
                    break;
                case 'columns':
                    if (newValue == '')
                        numberOfColumnsField.setValue(0);
                    else
                        numberOfColumnsField.setValue(newValue.split(',').length);
                    break;
            }
        });

        me.on('bound', function (data) {

            me.enableButton('AnchorSave');
            me.enableButton('AnchorUndo');
            me.enable();
            reloadColumns();
            reloadUsers();

            me.dataCollectorColumnStore.load(data.id);
            me.dataCollectorUserStore.load(data.id);
            numberOfColumnsField.disable();

            var data = me.getData();
            if (me.houseCodeStore.getCount() == 0 || null == me.houseCodeStore.getById(data.houseCodeId))
                houseCodeField.setRawValue(data.houseCodeBrief);
            toggleUsersContainer();
        });

		activeField.on('check', function () {
             modified(true);
        });
		
        lockoutField.on('check', function () {			
            lockoutMessageSendField.setValue(lockoutField.getValue());
            toggleLockoutMessageTextField(1);       // post 1 to ensure arguments length is not zero
            modified(true);
        });

		lockoutMessageSendField.on('check', function () {			
            toggleLockoutMessageTextField(1);       // post 1 to ensure arguments length is not zero
            modified(true);
        });
		
        //lockoutMessageSendField.on('check', toggleLockoutMessageTextField);

        me.on('bound', function () {
            me.dataCollectorUserStore.removeAll(true);
            me.dataCollectorColumnStore.removeAll(true);
            toggleEmailAddressField();
            toggleLockoutMessageTextField();
            toggleMessageTextField();
			modified(false);
        });

        me.addFields([frequencyField, numberOfColumnsField, houseCodeField, moduleField, descriptionField,
			columnField, userField, lockoutField, activeField, sendEmailField, emailAddressField,
			messageSendField, messageField, lockoutMessageSendField, lockoutMessageField]);
    },

    initButtons: function () {
        var me = this;

        me.$newButton = me.$child('AnchorNew');
        me.$undoButton = me.$child('AnchorUndo');
        me.$saveButton = me.$child('AnchorSave');

        me.enableButton('AnchorNew');
        me.diableButton('AnchorUndo');
        me.diableButton('AnchorSave');

        me.$newButton.click(function () {
            if (me.$newButton.hasClass('Enabled')) {
				if (!window.top.fin.cmn.status.itemValid())
					return;

                me.fireEvent('createnew', me);
            }
        });

        me.$saveButton.click(function () {
            if (me.$saveButton.hasClass('Enabled')) {
                me.fireEvent('save', me, me.getData());
            }
        });

        me.$undoButton.click(function () {
            if (me.$undoButton.hasClass('Enabled')) {
				if (!window.top.fin.cmn.status.itemValid())
					return;
                me.fireEvent('undo', me, me.getData());
            }
        });
    },

    enableButton: function (name) {
        var me = this;

        me.$child(name).removeClass('Disabled').addClass('Enabled');
        me.$child(name + 'Begin').removeClass('Disabled').addClass('Enabled');
        me.$child(name + 'Middle').removeClass('Disabled').addClass('Enabled');
        me.$child(name + 'End').removeClass('Disabled').addClass('Enabled');
    },

    diableButton: function (name) {
        var me = this;

        me.$child(name).addClass('Disabled').removeClass('Enabled');
        me.$child(name + 'Begin').addClass('Disabled').removeClass('Enabled');
        me.$child(name + 'Middle').addClass('Disabled').removeClass('Enabled');
        me.$child(name + 'End').addClass('Disabled').removeClass('Enabled');
    },

    dataBind: function () {
        var me = this;
        eFin.ctrl.app.DataCollectorEditor.superclass.dataBind.call(this);
        me.moduleStore.load();
        if (me.houseCodeStore.getCount() == 0)
            me.houseCodeStore.load();
    }
});

eFin.page.app.DataCollector = WebLight.extend(WebLight.Page, {

    html: window.__weblight_t_c0e3a119[2],

    title: 'Data Collector',

    dataCollectorStore: null,
    moduleStore: null,
    dataCollectorGrid: null,
    houseCodeStore: null,

    dataCollectorEditor: null,
    lastSelectedRowIndex: -1,

    rowSelectionModel: null,

    createChildControls: function () {

        var me = this;

        me.dataCollectorStore = new eFin.data.app.DataCollectorStore();
        me.moduleStore = new eFin.data.app.ModuleStore();
        me.houseCodeStore = new eFin.data.hcm.HouseCodeStore();

        eFin.page.app.DataCollector.superclass.createChildControls.call(this);

        var moduleColumnRenderer = function (value) {

            var module = me.moduleStore.getById(value);
            if (module)
                return module.get('name');
            return value;

        };

        me.rowSelectionModel = new Ext.grid.RowSelectionModel({ singleSelect: true });

        me.dataCollectorGrid = new Ext.grid.GridPanel({
            store: me.dataCollectorStore,
            height: 440, ctCls: 'ux-grid-1', enableHdMenu: false,
            //  viewConfig: { forceFit: true },
            width: 480,
            sm: me.rowSelectionModel, stripeRows: true,
            cm: new Ext.grid.ColumnModel({
                defaults: { sortable: true, align: 'left' },
                columns: [
						 	new Ext.grid.RowNumberer(),
                            { header: 'House Code', width: 90, dataIndex: 'houseCodeBrief' },
                            { header: 'Frequency', width: 80, dataIndex: 'frequency' },
                            { header: 'Module', width: 120, dataIndex: 'moduleId', renderer: moduleColumnRenderer },
                            { header: 'Description', width: 173, dataIndex: 'description' }
                    ]
            })
        });

        me.rowSelectionModel.on('rowselect', function (sm, rowIndex, record) {
			if (!window.top.fin.cmn.status.itemValid())
				return;

            if (me.lastSelectedRowIndex != rowIndex) {
                if (me.lastSelectedRowIndex != -1 && me.lastSelectedRowIndex < me.dataCollectorStore.getCount())
                    me.dataCollectorStore.getAt(me.lastSelectedRowIndex).reject();
				
				record.data.lockoutMessageText = record.data.lockoutMessageText.replace('&amp;','&').replace('&quot;', '"').replace('&lt;', '<').replace('&gt;','>')
				record.data.messageText = record.data.messageText.replace('&amp;','&').replace('&quot;', '"').replace('&lt;', '<').replace('&gt;','>')
                me.dataCollectorEditor.updateData(Ext.apply({}, record.data));
                me.lastSelectedRowIndex = rowIndex;
            }
        });

        me.dataCollectorEditor = new eFin.ctrl.app.DataCollectorEditor({ houseCodeStore: me.houseCodeStore });

        me.addChildControl(me.dataCollectorEditor, 'data-collector-editor');
        me.addChildControl(me.dataCollectorGrid, 'data-collector-grid');

        me.initDataCollectorEditor();

        me.dataCollectorStore.on('beforeload', function () { me.mask('Loading...'); });
        me.dataCollectorStore.on('load', function () {
            if (me.lastSelectedRowIndex != -1) {
                //me.dataCollectorEditor.updateData(me.dataCollectorStore.getAt(me.lastSelectedRowIndex).data);
                me.rowSelectionModel.selectRow(me.lastSelectedRowIndex);
                /// because columns loaded from another store, need set back to record, to ensure other fields changes not missing this value.
                var record = me.dataCollectorStore.getAt(me.lastSelectedRowIndex);
                record.set('columns', me.dataCollectorEditor.getData().columns);
            }
        });

        me.houseCodeStore.on('load', function () {
            me.dataCollectorGrid.getView().refresh();
        });

        me.moduleStore.on('load', function () {
            me.dataCollectorGrid.getView().refresh();
        });
    },

    initDataCollectorEditor: function () {
        var me = this;

        me.dataCollectorEditor.on('createnew', function () {
            var data = { frequency: 'Monthly',
                numberOfColumns: 0,
                lockout: false,
                //houseCodeId: 0,
                moduleId: 1,
                message: false,
                messageText: 'Your monthly BI Statistics update is overdue. Click here to enter the data now before you can no longer access the other modules.',
                lockoutMessage: false,
                lockoutMessageText: 'Your monthly BI Statistics update is overdue. You will no longer be able to access any modules until you complete the update. Click here to enter the data now.',
                email: false, emailAddress: '', active:true
            };

            var record = me.dataCollectorStore.newRecord(data);
            me.dataCollectorStore.add(record);

            me.rowSelectionModel.selectRow(me.dataCollectorStore.getCount() - 1);
        });

        me.dataCollectorEditor.on('undo', function () {
            //me.dataCollectorStore.reload();
            me.dataCollectorStore.getAt(me.lastSelectedRowIndex).reject();
            if (me.lastSelectedRowIndex > me.dataCollectorStore.getCount() - 1)
                me.rowSelectionModel.selectRow(0);
            else
                me.dataCollectorEditor.updateData(Ext.apply({}, me.dataCollectorStore.getAt(me.lastSelectedRowIndex).data));
        });

        me.dataCollectorEditor.on('save', function () {

            if (me.dataCollectorEditor.isValid()) {

                me._controls[0].mask('Saving...');
                me.dataCollectorStore.submitChanges(function () {
					modified(false);
                    me._controls[0].unmask("Saved");
                    me.dataCollectorStore.reload();
                });
            }
        });

        me.dataCollectorEditor.on('update', function (name, newValue) {
            if (me.lastSelectedRowIndex >= 0) {
                var record = me.dataCollectorStore.getAt(me.lastSelectedRowIndex);
                record.set(name, newValue);
            }
        });
    },

    safeUnmask: function () {
        var me = this;
        if (me.moduleStore.getCount() > 0  && me.houseCodeStore.getCount() > 0)
            me.unmask("Normal");
    },

    dataBind: function () {
        var me = this;
        eFin.page.app.DataCollector.superclass.dataBind.call(this);
        me.mask('Loading...');

        me.moduleStore.on('load', me.safeUnmask.createDelegate(me));
        me.dataCollectorStore.on('load', me.safeUnmask.createDelegate(me));
        me.houseCodeStore.on('load', me.safeUnmask.createDelegate(me));

        me.moduleStore.load();
        me.dataCollectorStore.load();
        setTimeout(function () { me.houseCodeStore.load(); }, 10000);
		$("#ext-gen30").height($(window).height() - 75);
		$("#ext-gen25").height($(window).height() - 50);
		$("#wl-ctrl-101-DataCollectorContentArea").height($(window).height() - 123);
		$("#wl-ctrl-101-DataCollectorContentArea").width($(window).width() - 550);
    }

});